<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Understanding LMS-based Color Blindness Simulations | DaltonLens</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Understanding LMS-based Color Blindness Simulations" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Diving deeper in the theory of Viénot, Brettel &amp; Mollon’s method to understand what’s behind the scene." />
<meta property="og:description" content="Diving deeper in the theory of Viénot, Brettel &amp; Mollon’s method to understand what’s behind the scene." />
<link rel="canonical" href="http://daltonlens.org/understanding-cvd-simulation/" />
<meta property="og:url" content="http://daltonlens.org/understanding-cvd-simulation/" />
<meta property="og:site_name" content="DaltonLens" />
<meta property="og:image" content="http://daltonlens.org/images/chart-preview.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-10-30T00:00:00-05:00" />
<script type="application/ld+json">
{"url":"http://daltonlens.org/understanding-cvd-simulation/","headline":"Understanding LMS-based Color Blindness Simulations","dateModified":"2021-10-30T00:00:00-05:00","datePublished":"2021-10-30T00:00:00-05:00","image":"http://daltonlens.org/images/chart-preview.png","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://daltonlens.org/understanding-cvd-simulation/"},"description":"Diving deeper in the theory of Viénot, Brettel &amp; Mollon’s method to understand what’s behind the scene.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="http://daltonlens.org/feed.xml" title="DaltonLens" /><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">DaltonLens</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/search/">Search</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Understanding LMS-based Color Blindness Simulations</h1><p class="page-description">Diving deeper in the theory of Viénot, Brettel & Mollon's method to understand what's behind the scene.</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2021-10-30T00:00:00-05:00" itemprop="datePublished">
        Oct 30, 2021
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      63 min read
    
</span></p>

    

    
      
        <div class="pb-5 d-flex flex-wrap flex-justify-end">
          <div class="px-2">

    <a href="https://github.com/DaltonLens/daltonlens.org/tree/master/_notebooks/2021-10-30-Understanding-Color-Blindness-Simulations.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          <div class="px-2">
    <a href="https://mybinder.org/v2/gh/DaltonLens/daltonlens.org/master?filepath=_notebooks%2F2021-10-30-Understanding-Color-Blindness-Simulations.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/binder.svg" alt="Open In Binder"/>
    </a>
</div>

          <div class="px-2">
    <a href="https://colab.research.google.com/github/DaltonLens/daltonlens.org/blob/master/_notebooks/2021-10-30-Understanding-Color-Blindness-Simulations.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h1"><a href="#Introduction">Introduction </a>
<ul>
<li class="toc-entry toc-h2"><a href="#Why-simulate-color-vision-deficiencies-(CVD)?">Why simulate color vision deficiencies (CVD)? </a></li>
<li class="toc-entry toc-h2"><a href="#Making-sense-of-the-available-models-and-programs">Making sense of the available models and programs </a></li>
<li class="toc-entry toc-h2"><a href="#Vocabulary-notes">Vocabulary notes </a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#Overview-of-the-existing-approaches">Overview of the existing approaches </a>
<ul>
<li class="toc-entry toc-h2"><a href="#Coblis-and-the-HCIRN-Color-Blind-Simulation-function">Coblis and the HCIRN Color Blind Simulation function </a></li>
<li class="toc-entry toc-h2"><a href="#Brettel-&-Mollon-1997">Brettel &amp; Mollon 1997 </a></li>
<li class="toc-entry toc-h2"><a href="#Viénot,-Brettel-&-Mollon-1999">Viénot, Brettel &amp; Mollon 1999 </a></li>
<li class="toc-entry toc-h2"><a href="#Machado-2009">Machado 2009 </a></li>
<li class="toc-entry toc-h2"><a href="#So-which-one-should-we-use?">So which one should we use? </a></li>
<li class="toc-entry toc-h2"><a href="#Show-me-some-images!">Show me some images! </a>
<ul>
<li class="toc-entry toc-h3"><a href="#For-protanopia">For protanopia </a></li>
<li class="toc-entry toc-h3"><a href="#For-deuteranopia">For deuteranopia </a></li>
<li class="toc-entry toc-h3"><a href="#For-tritanopia">For tritanopia </a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#Understanding-LMS-based-simulations">Understanding LMS-based simulations </a>
<ul>
<li class="toc-entry toc-h2"><a href="#From-sRGB-to-LMS">From sRGB to LMS </a>
<ul>
<li class="toc-entry toc-h3"><a href="#From-sRGB-to-linearRGB">From sRGB to linearRGB </a>
<ul>
<li class="toc-entry toc-h4"><a href="#Does-it-matter?-Yes!">Does it matter? Yes! </a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#From-linearRGB-to-CIE-XYZ">From linearRGB to CIE XYZ </a></li>
<li class="toc-entry toc-h3"><a href="#From-CIE-XYZ-to-LMS">From CIE XYZ to LMS </a></li>
<li class="toc-entry toc-h3"><a href="#Putting-it-together">Putting it together </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Simulating-dichromacy-in-LMS-(Brettel-&-Mollon-1997)">Simulating dichromacy in LMS (Brettel &amp; Mollon 1997) </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Projection-planes-in-LMS">Projection planes in LMS </a></li>
<li class="toc-entry toc-h3"><a href="#The-simplification-of-(Viénot,-Brettel-and-Mollon-1999)-for-protanopes-and-deuteranopes">The simplification of (Viénot, Brettel and Mollon 1999) for protanopes and deuteranopes </a>
<ul>
<li class="toc-entry toc-h4"><a href="#Plane-projection-as-a-3x3-matrix">Plane projection as a 3x3 matrix </a></li>
<li class="toc-entry toc-h4"><a href="#Putting-it-together">Putting it together </a></li>
<li class="toc-entry toc-h4"><a href="#What-about-tritanopes?">What about tritanopes? </a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Comparing-Viénot-1999-and-Brettel-1997">Comparing Viénot 1999 and Brettel 1997 </a></li>
<li class="toc-entry toc-h2"><a href="#How-accurate-are-these-simulations?">How accurate are these simulations? </a></li>
<li class="toc-entry toc-h2"><a href="#What-about-anomalous-trichromacy?">What about anomalous trichromacy? </a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#Appendix">Appendix </a>
<ul>
<li class="toc-entry toc-h2"><a href="#Code-to-generate-the-confusion-lines-of-the-introduction">Code to generate the confusion lines of the introduction </a></li>
<li class="toc-entry toc-h2"><a href="#Generated-Ishihara-like-plates-to-evaluate-the-kind-and-severity-of-CVD">Generated Ishihara-like plates to evaluate the kind and severity of CVD </a></li>
</ul>
</li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2021-10-30-Understanding-Color-Blindness-Simulations.ipynb
-->

<div class="container" id="notebook-container">
        
    
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Introduction">
<a class="anchor" href="#Introduction" aria-hidden="true"><span class="octicon octicon-link"></span></a>Introduction<a class="anchor-link" href="#Introduction"> </a>
</h1>
<h2 id="Why-simulate-color-vision-deficiencies-(CVD)?">
<a class="anchor" href="#Why-simulate-color-vision-deficiencies-(CVD)?" aria-hidden="true"><span class="octicon octicon-link"></span></a>Why simulate color vision deficiencies (CVD)?<a class="anchor-link" href="#Why-simulate-color-vision-deficiencies-(CVD)?"> </a>
</h2>
<p>Color vision deficiencies (CVD), commonly called "color blindness" affects ~8% of the male population and ~0.4% of the female population. Being able to accurately simulate them is important for several reasons:</p>
<ul>
<li>Communicate about this issue and help other people understand it</li>
<li>Help designers choose color schemes that everyone will perceive</li>
<li>Create tools to enhance images and help color blind people in their daily tasks. Most correction tools start by simulating how a person with CVD would see the image, and then find some way to spread the lost information into the channels that are better perceived or playing with the light intensity to restore the contrast.</li>
</ul>
<p>There are many online resources to understand CVD in detail. The <a href="https://en.wikipedia.org/wiki/Color_blindness">wikipedia</a> page and <a href="https://color-blindness.com/">color-blindness.com</a> are a good start, but here are the most relevant facts to understand CVD simulations:</p>
<ul>
<li>Human color perception is achieved via cone cells in the retina. Humans with normal vision have 3 kinds of cells, sensitive to different light wavelengths. L cones capture Long-wavelength (red), M cones capture Medium-wavelength (green) and S cones capture Short-wavelength (blue). Their response over the light spectrum is shown below.</li>
</ul>
<p><img src="https://upload.wikimedia.org/wikipedia/commons/d/d1/Cone_spectral_sensitivities.png" alt="image" title="LMS Response over the light wavelength (from Wikipedia). L is roughly centered on red, M on green and S on blue. Note that the responses overlap significantly, especially for L and M cones.">.</p>
<ul>
<li>
<p>Most color vision deficiencies can be explained by one type of cone not working properly. Protanopes, deuteranopes and tritanopes respectively lack or have malfunctioning L, M, or S cone cells.</p>
</li>
<li>
<p>CVD simulations based on physiological experiments generally consists in transforming the image to a color space where the influence of each kind of cone cells is explicit and can be decreased or removed easily. The <a href="https://en.wikipedia.org/wiki/LMS_color_space">LMS</a> color space was designed to specifically match the human cone responses and is thus the choice of the vast majority of methods.</p>
</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Making-sense-of-the-available-models-and-programs">
<a class="anchor" href="#Making-sense-of-the-available-models-and-programs" aria-hidden="true"><span class="octicon octicon-link"></span></a>Making sense of the available models and programs<a class="anchor-link" href="#Making-sense-of-the-available-models-and-programs"> </a>
</h2>
<p>There are many methods to simulate color blindness, and the web has lots of opensource programs to do so. However color appearance theory is complex and most developers (like me!) end up copying existing algorithms without having a solid understanding of where they come from and which one is best. It is also difficult to evaluate the accuracy of the simulations, so very bad simulations can still appear reasonable to an untrained observer.</p>
<p>While developing <a href="daltonlens.org">DaltonLens</a> I got frustrated by this as I was trying to decide which method I should implement. And being a mild-protan myself, I was often not very convinced by the results of existing methods as they tended to make the simulated images way too exaggerated.</p>
<p>So I decided to dig further into the history of the available algorithms and try to understand where they come from and how they work. To visualize and play with the models interactively this page is actually originally a <a href="https://github.com/DaltonLens/DaltonLens-Python/blob/master/research/understanding-simulations/UnderstandingColorBlindness.ipynb">Jupyter notebook</a> that can be run in e.g. Google colab to play with it.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Vocabulary-notes">
<a class="anchor" href="#Vocabulary-notes" aria-hidden="true"><span class="octicon octicon-link"></span></a>Vocabulary notes<a class="anchor-link" href="#Vocabulary-notes"> </a>
</h2>
<p>As it can quickly get confusing, here is a summary of the main terms to describe CVD variants:</p>
<ul>
<li>
<p><em>Dichromacy</em> refers to one kind of cone cells fully missing. The corresponding deficiencies for each kind are called <em>protanopia</em>, <em>deuteranopia</em> and <em>tritanopia</em>. The color vision of people with dichromacy (<em>dichromats</em>) is basically 2D instead of 3D and simulations of full dichromacy generally end up projecting the 3D color space to a carefully chosen 2D plane. This contrasts with <em>trichromacy</em>, the normal vision for humans. As a side note some animals (e.g. goldfishes) have 4 types of cones and are <a href="https://en.wikipedia.org/wiki/Tetrachromacy">tetrachromats</a>.</p>
</li>
<li>
<p><em>Anomalous trichromacy</em> refers to having one kind of cone cells with only a partial disfunction (e.g less density or with a shifted wavelenght peak). The corresponding deficiencies are called <em>protanomaly</em>, <em>deuteranomaly</em> and <em>tritanomaly</em>. In software simulations the degree of severity is usually encoded as a float value between 0 (no deficiency) and 1 (dichromacy).</p>
</li>
<li>
<p>A <em>protan</em> or a <em>protanope</em> is a person suffering from protanopia ("strong" protan) or protanomaly ("mild" protan). <em>Deutan/deuteranope</em> and <em>tritan/tritanope</em> are defined similarly.</p>
</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Overview-of-the-existing-approaches">
<a class="anchor" href="#Overview-of-the-existing-approaches" aria-hidden="true"><span class="octicon octicon-link"></span></a>Overview of the existing approaches<a class="anchor-link" href="#Overview-of-the-existing-approaches"> </a>
</h1>
<p>Let's start by looking at the most popular software and research papers. To complete this section I used the nice thread and software links compiled by Markku Laine in a <a href="https://github.com/aalto-ui/aim/pull/13">pull-request of the Aalto Interface Metrics (AIM) project</a>.</p>
<h2 id="Coblis-and-the-HCIRN-Color-Blind-Simulation-function">
<a class="anchor" href="#Coblis-and-the-HCIRN-Color-Blind-Simulation-function" aria-hidden="true"><span class="octicon octicon-link"></span></a>Coblis and the HCIRN Color Blind Simulation function<a class="anchor-link" href="#Coblis-and-the-HCIRN-Color-Blind-Simulation-function"> </a>
</h2>
<p>A google search for "color blindness simulation" first returns <a href="https://color-blindness.com/">color-blindness.com</a>. I mentioned that website before because it has great introductory material, but it also proposes a CVD simulator, called <em>Coblis</em>. Being one of the oldest and easiest tool to test it has inspired lots of other software. But digging into the history of the code is interesting and shows that its accuracy is quite questionable, especially in the older version.</p>
<p>The simulator relies on the source code of MaPePeR <a href="https://github.com/MaPePeR/jsColorblindSimulator">https://github.com/MaPePeR/jsColorblindSimulator</a> . It implements two different functions, one based on the "Color-Matrix" algorithm (Coblis v1), and one based on the "HCIRN Color Blind Simulation function" (Coblis v2, the default as of October 2021).</p>
<p>The "Color-Matrix" algorithm was developed by <a href="http://web.archive.org/web/20081014161121/http://www.colorjack.com/labs/colormatrix/">www.colorjack.com</a>. He converted the "HCIRN Color Blind Simulation function" that works in the CIE-XYZ color-space into a faster matrix that directly works on RGB values (that kind of optimization mattered back then). He did so by running the full function on 3 RGB values (pure red, pure green, pure blue) to deduce the 3x3 transformation matrices. So this approach only ensures the equivalence for these 3 colors. It also ignores the non-linearity of sRGB images, which was approximately handled in the original code a gamma function (more about sRGB in section FIXME). The author himself later said that this was a one-night hack and that nobody should use it anymore in a <a href="https://web.archive.org/web/20111123145815/http://kaioa.com/node/75#comment-247">comment on kaioa.com</a>:</p>
<blockquote>
<p>You're right, the ColorMatrix version is very simplified, and not accurate. I created that color matrix one night (<a href="http://www.colorjack.com/labs/colormatrix/">http://www.colorjack.com/labs/colormatrix/</a>) and since then it's shown up many places... I should probably take that page down before it spreads more! Anyways, it gives you an idea of what it might look like, but for the real thing...
The author actually took down that page since then, but it's hard to stop the spread.</p>
</blockquote>
<p>Regarding the proper "HCIRN Color Blind Simulation function", the first public code was developed by <a href="http://colorlab.wickline.org/colorblind/colorlab/docs/acknowledgments.html">Matthew Wickline</a> and made available in a javascript <a href="https://web.archive.org/web/20071012020140/http://www.nofunc.com/Color_Blindness_Library/">Color Blindness Library</a>. The author says in the <a href="http://colorlab.wickline.org/colorblind/colorlab/docs/acknowledgments.html">acknowledgments</a> that he wrote it by adapting some Java code that he kindly got from Thomas Wolfmaier after reading his 1999 article <a href="https://web.archive.org/web/20071212234539/http://www.internettg.org/newsletter/mar99/accessibility_color_challenged.html">Designing for the Color-Challenged: A Challenge</a>.</p>
<p>This article explains that they implemented a method based on the seminal work of <a class="citation" href="#meyer_color_defective_1988">(Meyer &amp; Greenberg, 1988)</a>, which was the first to propose an algorithm to simulate CVD, in the CIE XYZ color space. However the article of Thomas Wolfmaier was not peer-reviewed and their implementation was not validated experimentally, here are their conclusions in the article:</p>
<blockquote>
<p>Has the model been validated on individuals with color vision deficiencies? Unfortunately, we have not yet been able to test the model. We did apply the model to some of the tables of the UMIST 'For Fun' Colour Vision Test and were able to reproduce the predicted confusions. If you have some form of color vision deficiency, please have a look at the design aids described in the following sections and let us know how well the model predicts the color you see. Please send your feedback to Thomas Wolfmaier.</p>
<p>How accurate is the model? The model provides only a rough approximation. It includes estimates for some properties of color vision defects as well as assumptions about the hardware on which the colors are displayed. It also does not account for the reduced sensitivity to reds of individuals with protan defects.</p>
</blockquote>
<p>It is worth noting that <a class="citation" href="#meyer_color_defective_1988">(Meyer &amp; Greenberg, 1988)</a> did some experimental validation, where they noted that dichromats responded favorably to the simulations, despite some issues with highly saturated colors. <a class="citation" href="#vienot_digital_1999">(Viénot, Brettel, &amp; Mollon, 1999)</a> later commented that working in the CIE XYZ color space is worse as it does not take into account the altered perception of luminosity for dichromats.</p>
<p>So to summarize:- The ColorMatrix algorithm that was used in the first version of Coblis was a one-night hack severely simplifying the Javascript code of Matthew Wickline, which itself was an adaptation of the Java code of Thomas Wolfmaier in 1999. The author of the ColorMatrix himself said that we should not use it and removed the code, so let's stop using that.</p>
<ul>
<li>
<p>The code adapted by Matthew Wickline from Thomas Wolfmaier article was inspired by the Meyer and Greeberg paper which was a solid work. But the code itself was not validated and the experimental validation in the 1988 paper was not fully convincing and somewhat outdated. So it's unclear whether we can trust it, and the more recent academic litterature by colour science researchers moved to more recent approaches. In any case that code needs to be adapted to modern monitors by implementing the proper sRGB transform from RGB to CIE XYZ as the original code used a generic gamma correction (there was no sRGB standard back then).</p>
</li>
<li>
<p>Last, the license of the code is not super permissive, it cannot be used for commercial applications.</p>
</li>
</ul>
<p>Other examples of software using the HCIRN Color Blind Simulation function or the ColorMatrix are:</p>
<ul>
<li>
<a href="https://github.com/jkulesza/peacock">Peacock (Python &amp; C++)</a>. HCIRN Color Blind Simulation function.</li>
<li>
<a href="https://github.com/oftheheadland/Colorblindly">Colorblindly (chrome extension)</a>. Uses the ColorMatrix.</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Brettel-&amp;-Mollon-1997">
<a class="anchor" href="#Brettel-&amp;-Mollon-1997" aria-hidden="true"><span class="octicon octicon-link"></span></a>Brettel &amp; Mollon 1997<a class="anchor-link" href="#Brettel-&amp;-Mollon-1997"> </a>
</h2>
<p>A more modern algorithm for dichromacy simulation was developed by <a class="citation" href="#brettel_computerized_1997">(Brettel &amp; Mollon, 1997)</a>. Their paper has become a reference in the research community. It is based on the LMS color space, which is designed to model human perception at the cone level. It was performed on a calibrated CRT monitor, so implementations of this approach need to be adapted for modern LCD monitors and the sRGB standard. The most famous implementation is the one of <a href="www.vischeck.com">www.vischeck.com</a> in Java. It also had an online version, but the website is now broken. vischeck was used to generate the examples in the reference color science book <a class="citation" href="#fairchild2013color">(Fairchild, 2013)</a>.</p>
<p>There are comparatively few opensource implementation of this algorithm as the follow-up <a class="citation" href="#vienot_digital_1999">(Viénot, Brettel, &amp; Mollon, 1999)</a> paper from the same group proposed a simpler algorithm for protanopia and deuteranopia that is also more adapted to digital monitors. However it's worth noting that this newer approach does not work well for tritanopia, so the Brettel 1997 approach is still relevant in that case.</p>
<p>Another popular recent work from <a class="citation" href="#machado_physiologically_based_2009">(Machado, Oliveira, &amp; Fernandes, 2009)</a> uses Brettel 1997 as their reference and are actually very similar to it for dichromacy (by design, they tuned their parameters to match it).</p>
<p>Note that even if it was initially developed for full dichromacy, the approach can be adapted to simulate less severe anomalous trichromacy by either linearly interpolating between the original image and the dichromat image or by applying smaller corrections with fixed steps (<a class="citation" href="#flatla_so_2012">(Flatla &amp; Gutwin, 2012)</a>). Even if it looks reasonable in practice, the interpolation approach was not formally evaluated.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Viénot,-Brettel-&amp;-Mollon-1999">
<a class="anchor" href="#Vi%C3%A9not,-Brettel-&amp;-Mollon-1999" aria-hidden="true"><span class="octicon octicon-link"></span></a>Viénot, Brettel &amp; Mollon 1999<a class="anchor-link" href="#Vi%C3%A9not,-Brettel-&amp;-Mollon-1999"> </a>
</h2>
<p><a class="citation" href="#vienot_digital_1999">(Viénot, Brettel, &amp; Mollon, 1999)</a> builds on the Brettel 1997 paper. We'll see more details in section FIXME:, but in a nutshell it simplifies the math and adapts it for digital displays. It has become a very popular reference, in large part thanks to the daltonize algorithm of <a class="citation" href="#fidaner_analysis_2005">(Fidaner, Lin, &amp; Ozguven, 2005)</a>. That daltonize algorithm aims at improving the color contrasts of a given image for a person with CVD. The first step is to simulate how the image is seen by a dichromat, and then distribute the error w.r.t the original image on the other color channels. That algorithm became very popular and got copy/pasted/adapted many times. Since it used the simulation algorithm of Viénot 1999 in the first step, this approach became popular along the way too.</p>
<p>For protanopia and deuteranopia the results are reasonably similar between Viénot 1999 and Brettel 1997, so the faster one can be preferred, but again the Viénot paper is not well adapted to tritanopia. The authors themselves only mention protanopia and deuteranopia in it.</p>
<p>It can also be adapted for anomalous trichromacy like the Brettel 1997 approach, with the same limits about the validation.</p>
<p>Likewise, one challenge when implementing that algorithm is that the original paper was also dealing with CRT monitors, and thus did not use the sRGB standard. So their RGB to XYZ matrices have to be adjusted for modern monitors, but many opensource code copied the original matrices from <a class="citation" href="#fidaner_analysis_2005">(Fidaner, Lin, &amp; Ozguven, 2005)</a> and are thus inaccurate. The XYZ to LMS transform is also subject to discussion and we'll talk about it in section FIXME.</p>
<p>A worse but also common issue is that the code from <a class="citation" href="#fidaner_analysis_2005">(Fidaner, Lin, &amp; Ozguven, 2005)</a> actually did not include any gamma decoding of the input image, so many software just apply the matrices on the raw RGB values of the image and skip the sRGB decoding step altogether.</p>
<p>Here are a few examples of opensource projects implementing it:</p>
<ul>
<li>
<p><a href="https://github.com/joergdietrich/daltonize">daltonize.py (Python)</a>. Adapted to sRGB, but uses the CIECAM02 sharpened matrix for the RGB-&gt;LMS conversion. I think this is debatable for CVD simulation (see section FIXME).</p>
</li>
<li>
<p><a href="https://ixora.io/projects/colorblindness/color-blindness-simulation-research/">Ixora.io (Processing)</a>. Adapted to sRGB and uses the Hunt-Pointer-Estevez matrix for RGB-&gt;LMS.</p>
</li>
<li>
<p><a href="http://daltonize.org">daltonize.org (several languages)</a>. Most software listed there are adaptation of <a class="citation" href="#fidaner_analysis_2005">(Fidaner, Lin, &amp; Ozguven, 2005)</a>. And most forget the sRGB decoding and still use the original CRT RGB-&gt;XYZ conversion.</p>
</li>
<li>
<p><a href="https://github.com/tsarjak/Simulate-Correct-ColorBlindness">tsarjak/Simulate-Correct-ColorBlindness (Python)</a>. Also extends the approach to anomalous trichromacy by linearly interpolating between the original color and the dichromat color. Uses the original RGB&lt;&gt;LMS conversion for CRT monitors.</p>
</li>
<li>
<p><a href="https://github.com/asada0/ChromaticVisionSimulator">ChromaticVisionSimulator</a>. Mobile app for Android. Uses a proper sRGB-&gt;XYZ conversion. Uses a linear interpolation with the original image to simulate anomalous trichromacy.</p>
</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Machado-2009">
<a class="anchor" href="#Machado-2009" aria-hidden="true"><span class="octicon octicon-link"></span></a>Machado 2009<a class="anchor-link" href="#Machado-2009"> </a>
</h2>
<p>Even more recently <a class="citation" href="#machado_physiologically_based_2009">(Machado, Oliveira, &amp; Fernandes, 2009)</a> proposed an approach that supports both dichromacy and anomalous trichromacy in a principled way. They also made the nice and very welcome effort to publish easy-to-use matrices on <a href="https://www.inf.ufrgs.br/~oliveira/pubs_files/CVD_Simulation/CVD_Simulation.html">their website</a> and it is becoming more and more popular.</p>
<p>As mentioned ealier it is actually very similar to Brettel &amp; Mollon for dichromacy as they tuned their scaling parameters to match it. However it does not work very well for tritanopia as their model is to shift the peak response of the faulty kind of cone cells, and how it should be shifted is unclear for tritanopes. They also did not do any experimental validation with tritanopes.</p>
<p>For anomalous trichromacy the results are reasonably similar to the variant of Brettel 1997 that interpolates with the original image, but since the Machado approach is more principled it can be preferred.</p>
<p>Here are some examples of software using this approach:</p>
<ul>
<li>
<p><a href="https://github.com/colour-science/colour">colour-science.org (Python)</a>. Also has code to re-compute the predefined matrices. Overall a very comprehensive reference for anything color-related.</p>
</li>
<li>
<p><a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1003700#c33">Chromium</a> and <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1655053">Mozilla</a> used to rely on the ColorMatrix (Coblis v1) algorithm but fortunately now rely on the Machado approach.</p>
</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="So-which-one-should-we-use?">
<a class="anchor" href="#So-which-one-should-we-use?" aria-hidden="true"><span class="octicon octicon-link"></span></a>So which one should we use?<a class="anchor-link" href="#So-which-one-should-we-use?"> </a>
</h2>
<p>Given the limits of the existing algorithms I would recommend different methods depending on the kind of deficiency:</p>
<ul>
<li>
<p>For tritanopia the Brettel 1997 approach is still the most solid and basically only valid choice. For tritanomaly I'd also recommend it with an interpolation factor with the original image, but this is more debatable.</p>
</li>
<li>
<p>For protanopia and deuteranopia Viénot 1999, Brettel 1997 and Machado 2009 are solid choices, with a slight advantage for Viénot because it behaves a bit better with extreme values. For protanomaly and deuteranomaly Machado is more principled than linearly interpolating with the original image so it's probably a better choice.</p>
</li>
</ul>
<p>This is the heuristic implemented by <code>Simulator_AutoSelect</code> in <a href="https://github.com/DaltonLens/DaltonLens-Python">DaltonLens-Python</a>.</p>
<p>More discussion and comparisons can be found in the <a class="citation" href="#simon_liedtke_using_2016">(Simon-Liedtke &amp; Farup, 2016)</a> paper. It includes an evaluation of the <a class="citation" href="#kotera_optimal_2012">(Kotera, 2012)</a> method, which I did not include as I haven't found any opensource software implementing it (and it performs worse than Viénot and Brettel in that study).</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Show-me-some-images!">
<a class="anchor" href="#Show-me-some-images!" aria-hidden="true"><span class="octicon octicon-link"></span></a>Show me some images!<a class="anchor-link" href="#Show-me-some-images!"> </a>
</h2>
<p>We'll see the differences between some of these approaches in greater details later on, but let's get an initial idea of their output. The input image covers the full RGB range. These results are for full dichromacy, so people with a mild CVD will likely see significant differences between the original and the simulated images for all models.</p>
<p>The images were generated using the implemention of each method in <a href="https://github.com/DaltonLens/DaltonLens-Python">DaltonLens-Python</a>, with the exception of Coblis V1 and V2 which respectively come from <a href="https://github.com/skratchdot/color-matrix">skratchdot/color-matrix</a> and <a href="https://github.com/jkulesza/peacock">Peacock</a>.</p>
<p>Overall it confirms that Coblis V1 (the ColorMatrix) is very broken. The other algorithms have some differences but fortunately still generally agree for protanopia and deuteranopia. For tritanopia Brettel 1997 is significantly different and should be more accurate as the other models were not designed to be compatible with tritanopia.</p>
<h3 id="For-protanopia">
<a class="anchor" href="#For-protanopia" aria-hidden="true"><span class="octicon octicon-link"></span></a>For protanopia<a class="anchor-link" href="#For-protanopia"> </a>
</h3>
<p><!-- Image tags have to be unindented for nbdev to catch them :-( --></p>
<table>
    <tr>
<th>Original</th>
<th>Machado 2009</th>
<th>Viénot 1999</th>
</tr>
    <tr>
<td>
<figure>
  
    <img class="docimage" src="/images/copied_from_nb/simulation_images/rgbspan.png" alt="">
    
    
</figure>
</td>
<td>
<figure>
  
    <img class="docimage" src="/images/copied_from_nb/simulation_images/rgbspan_protan_machado2009.png" alt="">
    
    
</figure>
</td>
<td>
<figure>
  
    <img class="docimage" src="/images/copied_from_nb/simulation_images/rgbspan_protan_vienot1999.png" alt="">
    
    
</figure>
</td>
</tr>
     <tr>
<th>Brettel 1997</th>
<th>Coblis V1</th>
<th>Coblis V2</th>
</tr>
    <tr>
<td>
<figure>
  
    <img class="docimage" src="/images/copied_from_nb/simulation_images/rgbspan_protan_brettel1997.png" alt="">
    
    
</figure>
</td>
<td>
<figure>
  
    <img class="docimage" src="/images/copied_from_nb/simulation_images/rgbspan_protan_coblisv1.png" alt="">
    
    
</figure>
</td>
<td>
<figure>
  
    <img class="docimage" src="/images/copied_from_nb/simulation_images/rgbspan_protan_coblisv2.png" alt="">
    
    
</figure>
</td>
</tr>
</table>
<h3 id="For-deuteranopia">
<a class="anchor" href="#For-deuteranopia" aria-hidden="true"><span class="octicon octicon-link"></span></a>For deuteranopia<a class="anchor-link" href="#For-deuteranopia"> </a>
</h3>
<table>
    <tr>
<th>Original</th>
<th>Machado 2009</th>
<th>Viénot 1999</th>
</tr>
    <tr>
<td>
<figure>
  
    <img class="docimage" src="/images/copied_from_nb/simulation_images/rgbspan.png" alt="">
    
    
</figure>
</td>
<td>
<figure>
  
    <img class="docimage" src="/images/copied_from_nb/simulation_images/rgbspan_deutan_machado2009.png" alt="">
    
    
</figure>
</td>
<td>
<figure>
  
    <img class="docimage" src="/images/copied_from_nb/simulation_images/rgbspan_deutan_vienot1999.png" alt="">
    
    
</figure>
</td>
</tr>
     <tr>
<th>Brettel 1997</th>
<th>Coblis V1</th>
<th>Coblis V2</th>
</tr>
    <tr>
<td>
<figure>
  
    <img class="docimage" src="/images/copied_from_nb/simulation_images/rgbspan_deutan_brettel1997.png" alt="">
    
    
</figure>
</td>
<td>
<figure>
  
    <img class="docimage" src="/images/copied_from_nb/simulation_images/rgbspan_deutan_coblisv1.png" alt="">
    
    
</figure>
</td>
<td>
<figure>
  
    <img class="docimage" src="/images/copied_from_nb/simulation_images/rgbspan_deutan_coblisv2.png" alt="">
    
    
</figure>
</td>
</tr>
</table>
<h3 id="For-tritanopia">
<a class="anchor" href="#For-tritanopia" aria-hidden="true"><span class="octicon octicon-link"></span></a>For tritanopia<a class="anchor-link" href="#For-tritanopia"> </a>
</h3>
<table>
    <tr>
<th>Original</th>
<th>Machado 2009</th>
<th>Viénot 1999</th>
</tr>
    <tr>
<td>
<figure>
  
    <img class="docimage" src="/images/copied_from_nb/simulation_images/rgbspan.png" alt="">
    
    
</figure>
</td>
<td>
<figure>
  
    <img class="docimage" src="/images/copied_from_nb/simulation_images/rgbspan_tritan_machado2009.png" alt="">
    
    
</figure>
</td>
<td>
<figure>
  
    <img class="docimage" src="/images/copied_from_nb/simulation_images/rgbspan_tritan_vienot1999.png" alt="">
    
    
</figure>
</td>
</tr>
     <tr>
<th>Brettel 1997</th>
<th>Coblis V1</th>
<th>Coblis V2</th>
</tr>
    <tr>
<td>
<figure>
  
    <img class="docimage" src="/images/copied_from_nb/simulation_images/rgbspan_tritan_brettel1997.png" alt="">
    
    
</figure>
</td>
<td>
<figure>
  
    <img class="docimage" src="/images/copied_from_nb/simulation_images/rgbspan_tritan_coblisv1.png" alt="">
    
    
</figure>
</td>
<td>
<figure>
  
    <img class="docimage" src="/images/copied_from_nb/simulation_images/rgbspan_tritan_coblisv2.png" alt="">
    
    
</figure>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Understanding-LMS-based-simulations">
<a class="anchor" href="#Understanding-LMS-based-simulations" aria-hidden="true"><span class="octicon octicon-link"></span></a>Understanding LMS-based simulations<a class="anchor-link" href="#Understanding-LMS-based-simulations"> </a>
</h1>
<p><a class="citation" href="#brettel_computerized_1997">(Brettel &amp; Mollon, 1997)</a>, <a class="citation" href="#vienot_digital_1999">(Viénot, Brettel, &amp; Mollon, 1999)</a> and <a class="citation" href="#machado_physiologically_based_2009">(Machado, Oliveira, &amp; Fernandes, 2009)</a> all rely on the same low-level principles to simulate CVD. For all of them the final code will basically just apply a gamma function, one or two 3x3 matrices, undo the gamma, and call it a day. But we're going to dive in that pipeline and to understand the details of how to compute those matrices and get a sense of what they do.</p>
<p>The Machado method is actually a bit more involved as it uses a second stage of modeling (opponent-color theory), so I will not cover it here and only focus on Viénot and Brettel. Both focus on full dichromacy, so we'll start with that.</p>
<p>The extension to anomalous trichromacy will be discussed in section FIXME. As we've seen before, Protanopes, deuteranopes and tritanopes respectively lack the L, M, and S cone cells. Thus a natural approach to simulate dichromacy is to go to the LMS color-space and somehow remove the component coming from the missing cone cells. The good news is that going from an RGB color space to LMS can be done with a linear transformation (matrix multiplication). The bad news is that there are many ways to do it, and that will be the focus on section FIXME.</p>
<p>One extra complexity is that images are typically encoded in <code>sRGB</code> to get properly displayed on digital monitors once they apply their gamma correction. So our first step will be to go from sRGB to linear RGB, and then from there to LMS.</p>
<p>Once in the LMS color space, we know that colors that only differ by the coordinate of the axis corresponding to the missing cone cannot be differentiated by a dichromat. This creates so-called confusion lines, which are, by construction, parallel to the missing axis in the LMS color space. So according to this model a protanope cannot distinguish colors that only differ by their L component, a deuteranope those that only differ by their M component, and tritanopes those that only differ by their S component.</p>
<p>To illustrate this let's build a plot with a few confusion lines in the LMS space, and their counterpart on the linear RGB space. We'll see the details on how to generate the confusion lines later on, but for now we'll just draw 5 precomputed lines, starting with protanopia (missing L cones). To have a reference we'll also add the gamut (range) of colors that can be produced by a digital monitor. It's a cube in the RGB color space, and a parallelepiped in the LMS space. The 8 vertices are black (<code>K = RGB[0,0,0]</code>), white (<code>W = RGB[1, 1, 1])</code>, red (<code>R = RGB[1, 0, 0])</code>, green (<code>G = RGB[0,1,0]</code>), blue (<code>B = RGB[0,0,1]</code>), yellow (<code>G = RGB[1,1,0]</code>), magenta (<code>M = RGB[1,0,1]</code>) and cyan (<code>C = RGB[0,1,1]</code>). 
</p>
<div class="flash">
    <svg class="octicon octicon-info" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z"></path></svg>
    <strong>Note: </strong>the plots are in 3D and interactive, so feel free to play with the point of view!
</div>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># This cell defines all our imports and a few utilities</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">plotly.express</span> <span class="k">as</span> <span class="nn">px</span>
<span class="kn">import</span> <span class="nn">plotly.graph_objs</span> <span class="k">as</span> <span class="nn">go</span>
<span class="kn">from</span> <span class="nn">plotly.subplots</span> <span class="kn">import</span> <span class="n">make_subplots</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">Geometry3D</span> <span class="k">as</span> <span class="nn">geo3d</span>

<span class="kn">import</span> <span class="nn">daltonlens.convert</span> <span class="k">as</span> <span class="nn">convert</span>
<span class="kn">import</span> <span class="nn">daltonlens.generate</span> <span class="k">as</span> <span class="nn">generate</span>
<span class="kn">import</span> <span class="nn">daltonlens.simulate</span> <span class="k">as</span> <span class="nn">simulate</span>
<span class="kn">import</span> <span class="nn">daltonlens.geometry</span> <span class="k">as</span> <span class="nn">geometry</span>
<span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">suppress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">printMatrix</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
    <span class="n">mat_str</span> <span class="o">=</span> <span class="s1">'</span><span class="se">\n</span><span class="s1">  '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array_repr</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">))</span>
    <span class="nb">print</span> <span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> = </span><span class="se">\n</span><span class="s1">  </span><span class="si">{</span><span class="n">mat_str</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
    
<span class="c1"># Utility for plotly imshow</span>
<span class="n">hide_image_axes</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">yaxis_visible</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">yaxis_showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">xaxis_visible</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">xaxis_showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">show_confusion_lines</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
    <span class="n">rgb_cube</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">([</span>
        <span class="p">(</span><span class="s1">'K'</span><span class="p">,</span> <span class="s1">'black'</span><span class="p">,</span>     <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span> <span class="mf">0.</span>        <span class="p">,</span> <span class="mf">0.</span>        <span class="p">,</span> <span class="mf">0.</span>        <span class="p">,</span> <span class="s1">'#000000'</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">'B'</span><span class="p">,</span> <span class="s1">'blue'</span><span class="p">,</span>      <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">1</span><span class="p">,</span> <span class="mf">0.03596577</span><span class="p">,</span> <span class="mf">0.03620635</span><span class="p">,</span> <span class="mf">0.01528089</span><span class="p">,</span> <span class="s1">'#0000ff'</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">'M'</span><span class="p">,</span> <span class="s1">'magenta'</span><span class="p">,</span>   <span class="mi">1</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">1</span><span class="p">,</span> <span class="mf">0.21482533</span><span class="p">,</span> <span class="mf">0.07001029</span><span class="p">,</span> <span class="mf">0.01559176</span><span class="p">,</span> <span class="s1">'#ff00ff'</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">'R'</span><span class="p">,</span> <span class="s1">'red'</span><span class="p">,</span>       <span class="mi">1</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span> <span class="mf">0.17885956</span><span class="p">,</span> <span class="mf">0.03380394</span><span class="p">,</span> <span class="mf">0.00031087</span><span class="p">,</span> <span class="s1">'#ff0000'</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">'G'</span><span class="p">,</span> <span class="s1">'green'</span><span class="p">,</span>     <span class="mi">0</span><span class="p">,</span>   <span class="mi">1</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span> <span class="mf">0.43997117</span><span class="p">,</span> <span class="mf">0.27515242</span><span class="p">,</span> <span class="mf">0.00191661</span><span class="p">,</span> <span class="s1">'#00ff00'</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">'C'</span><span class="p">,</span> <span class="s1">'cyan'</span><span class="p">,</span>      <span class="mi">0</span><span class="p">,</span>   <span class="mi">1</span><span class="p">,</span>   <span class="mi">1</span><span class="p">,</span> <span class="mf">0.47593694</span><span class="p">,</span> <span class="mf">0.31135877</span><span class="p">,</span> <span class="mf">0.0171975</span> <span class="p">,</span> <span class="s1">'#00ffff'</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">'W'</span><span class="p">,</span> <span class="s1">'white'</span><span class="p">,</span>     <span class="mi">1</span><span class="p">,</span>   <span class="mi">1</span><span class="p">,</span>   <span class="mi">1</span><span class="p">,</span> <span class="mf">0.6547965</span> <span class="p">,</span> <span class="mf">0.34516271</span><span class="p">,</span> <span class="mf">0.01750837</span><span class="p">,</span> <span class="s1">'#ffffff'</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">'Y'</span><span class="p">,</span> <span class="s1">'yellow'</span><span class="p">,</span>    <span class="mi">1</span><span class="p">,</span>   <span class="mi">1</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span> <span class="mf">0.61883073</span><span class="p">,</span> <span class="mf">0.30895636</span><span class="p">,</span> <span class="mf">0.00222748</span><span class="p">,</span> <span class="s1">'#ffff00'</span><span class="p">)],</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'short_name'</span><span class="p">,</span> <span class="s1">'name'</span><span class="p">,</span> <span class="s1">'R'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">,</span> <span class="s1">'L'</span><span class="p">,</span> <span class="s1">'M'</span><span class="p">,</span> <span class="s1">'S'</span><span class="p">,</span> <span class="s1">'sRGB_hex'</span><span class="p">])</span>
    <span class="n">rgb_cube</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">rgb_cube</span><span class="p">[</span><span class="s1">'short_name'</span><span class="p">]</span>
    <span class="n">rgb_cube</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">'key'</span>
    <span class="c1"># display(HTML("&lt;h2&gt;RGB Cube&lt;/h2&gt;"), rgb_cube)</span>
    
    <span class="n">fig</span> <span class="o">=</span> <span class="n">make_subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> 
                        <span class="n">subplot_titles</span><span class="o">=</span><span class="p">(</span><span class="s1">'RGB Color Space'</span><span class="p">,</span>  <span class="s1">'LMS Color Space'</span><span class="p">),</span>
                        <span class="n">specs</span><span class="o">=</span><span class="p">[[{</span><span class="s2">"type"</span><span class="p">:</span> <span class="s2">"scene"</span><span class="p">},</span> <span class="p">{</span><span class="s2">"type"</span><span class="p">:</span> <span class="s2">"scene"</span><span class="p">}]])</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">add_scatter3d</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">rgb_cube</span><span class="p">[</span><span class="s1">'R'</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">rgb_cube</span><span class="p">[</span><span class="s1">'G'</span><span class="p">],</span> <span class="n">z</span><span class="o">=</span><span class="n">rgb_cube</span><span class="p">[</span><span class="s1">'B'</span><span class="p">],</span> 
                      <span class="n">text</span><span class="o">=</span><span class="n">rgb_cube</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">"markers+text"</span><span class="p">,</span>
                      <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">rgb_cube</span><span class="p">[</span><span class="s1">'sRGB_hex'</span><span class="p">]),</span>
                      <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">add_scatter3d</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">rgb_cube</span><span class="p">[</span><span class="s1">'L'</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">rgb_cube</span><span class="p">[</span><span class="s1">'M'</span><span class="p">],</span> <span class="n">z</span><span class="o">=</span><span class="n">rgb_cube</span><span class="p">[</span><span class="s1">'S'</span><span class="p">],</span> 
                      <span class="n">text</span><span class="o">=</span><span class="n">rgb_cube</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">"markers+text"</span><span class="p">,</span>
                      <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">rgb_cube</span><span class="p">[</span><span class="s1">'sRGB_hex'</span><span class="p">]),</span>
                      <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">dragmode</span><span class="o">=</span><span class="s1">'orbit'</span><span class="p">,</span> 
                      <span class="n">scene</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                        <span class="n">xaxis_title</span><span class="o">=</span><span class="s1">'R'</span><span class="p">,</span>
                        <span class="n">yaxis_title</span><span class="o">=</span><span class="s1">'G'</span><span class="p">,</span>
                        <span class="n">zaxis_title</span><span class="o">=</span><span class="s1">'B'</span><span class="p">))</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">scene2</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                        <span class="n">xaxis_title</span><span class="o">=</span><span class="s1">'L'</span><span class="p">,</span>
                        <span class="n">yaxis_title</span><span class="o">=</span><span class="s1">'M'</span><span class="p">,</span>
                        <span class="n">zaxis_title</span><span class="o">=</span><span class="s1">'S'</span><span class="p">))</span>
    
    <span class="c1"># Add the parallelepiped lines</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">rgb_cube</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="s1">'K'</span><span class="p">,</span><span class="s1">'B'</span><span class="p">,</span><span class="s1">'M'</span><span class="p">,</span><span class="s1">'R'</span><span class="p">,</span> <span class="s1">'K'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'Y'</span><span class="p">,</span> <span class="s1">'W'</span><span class="p">,</span> <span class="s1">'C'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'Y'</span><span class="p">,</span> <span class="s1">'R'</span><span class="p">,</span> <span class="s1">'M'</span><span class="p">,</span> <span class="s1">'W'</span><span class="p">,</span> <span class="s1">'C'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">]]</span>    
    <span class="n">fig</span><span class="o">.</span><span class="n">add_scatter3d</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'R'</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'G'</span><span class="p">],</span> <span class="n">z</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'B'</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">'lines'</span><span class="p">,</span> <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_scatter3d</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'L'</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'M'</span><span class="p">],</span> <span class="n">z</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'S'</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">'lines'</span><span class="p">,</span> <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_scatter3d</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">line</span><span class="p">[</span><span class="s1">'R'</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">line</span><span class="p">[</span><span class="s1">'G'</span><span class="p">],</span> <span class="n">z</span><span class="o">=</span><span class="n">line</span><span class="p">[</span><span class="s1">'B'</span><span class="p">],</span> <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                          <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">line</span><span class="p">[</span><span class="s1">'sRGB_hex'</span><span class="p">]),</span>
                          <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">add_scatter3d</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">line</span><span class="p">[</span><span class="s1">'L'</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">line</span><span class="p">[</span><span class="s1">'M'</span><span class="p">],</span> <span class="n">z</span><span class="o">=</span><span class="n">line</span><span class="p">[</span><span class="s1">'S'</span><span class="p">],</span> <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                          <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">line</span><span class="p">[</span><span class="s1">'sRGB_hex'</span><span class="p">]),</span>
                          <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Confusion lines for Deficiency.PROTAN</span>
<span class="n">protan_confusion_lines</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">([</span>
        <span class="p">(</span><span class="mf">0.2309</span><span class="p">,</span> <span class="mf">0.0690</span><span class="p">,</span> <span class="mf">0.0035</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">,</span> <span class="mf">0.1022</span><span class="p">,</span> <span class="mf">0.1960</span><span class="p">,</span> <span class="s1">'#fe5a7a'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.2101</span><span class="p">,</span> <span class="mf">0.0690</span><span class="p">,</span> <span class="mf">0.0035</span><span class="p">,</span> <span class="mf">0.8333</span><span class="p">,</span> <span class="mf">0.1226</span><span class="p">,</span> <span class="mf">0.1968</span><span class="p">,</span> <span class="s1">'#eb627a'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1893</span><span class="p">,</span> <span class="mf">0.0690</span><span class="p">,</span> <span class="mf">0.0035</span><span class="p">,</span> <span class="mf">0.6667</span><span class="p">,</span> <span class="mf">0.1430</span><span class="p">,</span> <span class="mf">0.1977</span><span class="p">,</span> <span class="s1">'#d5697a'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1684</span><span class="p">,</span> <span class="mf">0.0690</span><span class="p">,</span> <span class="mf">0.0035</span><span class="p">,</span> <span class="mf">0.5000</span><span class="p">,</span> <span class="mf">0.1633</span><span class="p">,</span> <span class="mf">0.1985</span><span class="p">,</span> <span class="s1">'#bb707b'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1476</span><span class="p">,</span> <span class="mf">0.0690</span><span class="p">,</span> <span class="mf">0.0035</span><span class="p">,</span> <span class="mf">0.3334</span><span class="p">,</span> <span class="mf">0.1837</span><span class="p">,</span> <span class="mf">0.1993</span><span class="p">,</span> <span class="s1">'#9c767b'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1268</span><span class="p">,</span> <span class="mf">0.0690</span><span class="p">,</span> <span class="mf">0.0035</span><span class="p">,</span> <span class="mf">0.1667</span><span class="p">,</span> <span class="mf">0.2041</span><span class="p">,</span> <span class="mf">0.2002</span><span class="p">,</span> <span class="s1">'#717c7b'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1060</span><span class="p">,</span> <span class="mf">0.0690</span><span class="p">,</span> <span class="mf">0.0035</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.2244</span><span class="p">,</span> <span class="mf">0.2010</span><span class="p">,</span> <span class="s1">'#00827b'</span><span class="p">)],</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'L'</span><span class="p">,</span> <span class="s1">'M'</span><span class="p">,</span> <span class="s1">'S'</span><span class="p">,</span> <span class="s1">'R'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">,</span> <span class="s1">'sRGB_hex'</span><span class="p">]),</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">([</span>
        <span class="p">(</span><span class="mf">0.3899</span><span class="p">,</span> <span class="mf">0.1726</span><span class="p">,</span> <span class="mf">0.0088</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">,</span> <span class="mf">0.4389</span><span class="p">,</span> <span class="mf">0.4975</span><span class="p">,</span> <span class="s1">'#feb0bb'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.3690</span><span class="p">,</span> <span class="mf">0.1726</span><span class="p">,</span> <span class="mf">0.0088</span><span class="p">,</span> <span class="mf">0.8333</span><span class="p">,</span> <span class="mf">0.4593</span><span class="p">,</span> <span class="mf">0.4983</span><span class="p">,</span> <span class="s1">'#ebb4bb'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.3482</span><span class="p">,</span> <span class="mf">0.1726</span><span class="p">,</span> <span class="mf">0.0088</span><span class="p">,</span> <span class="mf">0.6667</span><span class="p">,</span> <span class="mf">0.4796</span><span class="p">,</span> <span class="mf">0.4992</span><span class="p">,</span> <span class="s1">'#d5b8bb'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.3274</span><span class="p">,</span> <span class="mf">0.1726</span><span class="p">,</span> <span class="mf">0.0088</span><span class="p">,</span> <span class="mf">0.5000</span><span class="p">,</span> <span class="mf">0.5000</span><span class="p">,</span> <span class="mf">0.5000</span><span class="p">,</span> <span class="s1">'#bbbbbb'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.3066</span><span class="p">,</span> <span class="mf">0.1726</span><span class="p">,</span> <span class="mf">0.0088</span><span class="p">,</span> <span class="mf">0.3334</span><span class="p">,</span> <span class="mf">0.5204</span><span class="p">,</span> <span class="mf">0.5008</span><span class="p">,</span> <span class="s1">'#9cbebb'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.2858</span><span class="p">,</span> <span class="mf">0.1726</span><span class="p">,</span> <span class="mf">0.0088</span><span class="p">,</span> <span class="mf">0.1667</span><span class="p">,</span> <span class="mf">0.5407</span><span class="p">,</span> <span class="mf">0.5017</span><span class="p">,</span> <span class="s1">'#71c2bb'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.2649</span><span class="p">,</span> <span class="mf">0.1726</span><span class="p">,</span> <span class="mf">0.0088</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.5611</span><span class="p">,</span> <span class="mf">0.5025</span><span class="p">,</span> <span class="s1">'#00c5bb'</span><span class="p">)],</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'L'</span><span class="p">,</span> <span class="s1">'M'</span><span class="p">,</span> <span class="s1">'S'</span><span class="p">,</span> <span class="s1">'R'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">,</span> <span class="s1">'sRGB_hex'</span><span class="p">]),</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">([</span>
        <span class="p">(</span><span class="mf">0.2754</span><span class="p">,</span> <span class="mf">0.1044</span><span class="p">,</span> <span class="mf">0.0120</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">,</span> <span class="mf">0.1584</span><span class="p">,</span> <span class="mf">0.7462</span><span class="p">,</span> <span class="s1">'#fe6ee0'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.2546</span><span class="p">,</span> <span class="mf">0.1044</span><span class="p">,</span> <span class="mf">0.0120</span><span class="p">,</span> <span class="mf">0.8333</span><span class="p">,</span> <span class="mf">0.1787</span><span class="p">,</span> <span class="mf">0.7471</span><span class="p">,</span> <span class="s1">'#eb75e0'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.2337</span><span class="p">,</span> <span class="mf">0.1044</span><span class="p">,</span> <span class="mf">0.0120</span><span class="p">,</span> <span class="mf">0.6667</span><span class="p">,</span> <span class="mf">0.1991</span><span class="p">,</span> <span class="mf">0.7479</span><span class="p">,</span> <span class="s1">'#d57be0'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.2129</span><span class="p">,</span> <span class="mf">0.1044</span><span class="p">,</span> <span class="mf">0.0120</span><span class="p">,</span> <span class="mf">0.5000</span><span class="p">,</span> <span class="mf">0.2194</span><span class="p">,</span> <span class="mf">0.7487</span><span class="p">,</span> <span class="s1">'#bb80e0'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1921</span><span class="p">,</span> <span class="mf">0.1044</span><span class="p">,</span> <span class="mf">0.0120</span><span class="p">,</span> <span class="mf">0.3334</span><span class="p">,</span> <span class="mf">0.2398</span><span class="p">,</span> <span class="mf">0.7496</span><span class="p">,</span> <span class="s1">'#9c86e0'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1713</span><span class="p">,</span> <span class="mf">0.1044</span><span class="p">,</span> <span class="mf">0.0120</span><span class="p">,</span> <span class="mf">0.1667</span><span class="p">,</span> <span class="mf">0.2602</span><span class="p">,</span> <span class="mf">0.7504</span><span class="p">,</span> <span class="s1">'#718be0'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1505</span><span class="p">,</span> <span class="mf">0.1044</span><span class="p">,</span> <span class="mf">0.0120</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.2805</span><span class="p">,</span> <span class="mf">0.7513</span><span class="p">,</span> <span class="s1">'#0090e0'</span><span class="p">)],</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'L'</span><span class="p">,</span> <span class="s1">'M'</span><span class="p">,</span> <span class="s1">'S'</span><span class="p">,</span> <span class="s1">'R'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">,</span> <span class="s1">'sRGB_hex'</span><span class="p">]),</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">([</span>
        <span class="p">(</span><span class="mf">0.5043</span><span class="p">,</span> <span class="mf">0.2408</span><span class="p">,</span> <span class="mf">0.0055</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">,</span> <span class="mf">0.7195</span><span class="p">,</span> <span class="mf">0.2487</span><span class="p">,</span> <span class="s1">'#fedc88'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.4835</span><span class="p">,</span> <span class="mf">0.2408</span><span class="p">,</span> <span class="mf">0.0055</span><span class="p">,</span> <span class="mf">0.8333</span><span class="p">,</span> <span class="mf">0.7398</span><span class="p">,</span> <span class="mf">0.2496</span><span class="p">,</span> <span class="s1">'#ebdf88'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.4627</span><span class="p">,</span> <span class="mf">0.2408</span><span class="p">,</span> <span class="mf">0.0055</span><span class="p">,</span> <span class="mf">0.6667</span><span class="p">,</span> <span class="mf">0.7602</span><span class="p">,</span> <span class="mf">0.2504</span><span class="p">,</span> <span class="s1">'#d5e189'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.4419</span><span class="p">,</span> <span class="mf">0.2408</span><span class="p">,</span> <span class="mf">0.0055</span><span class="p">,</span> <span class="mf">0.5000</span><span class="p">,</span> <span class="mf">0.7805</span><span class="p">,</span> <span class="mf">0.2513</span><span class="p">,</span> <span class="s1">'#bbe489'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.4211</span><span class="p">,</span> <span class="mf">0.2408</span><span class="p">,</span> <span class="mf">0.0055</span><span class="p">,</span> <span class="mf">0.3334</span><span class="p">,</span> <span class="mf">0.8009</span><span class="p">,</span> <span class="mf">0.2521</span><span class="p">,</span> <span class="s1">'#9ce789'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.4003</span><span class="p">,</span> <span class="mf">0.2408</span><span class="p">,</span> <span class="mf">0.0055</span><span class="p">,</span> <span class="mf">0.1667</span><span class="p">,</span> <span class="mf">0.8213</span><span class="p">,</span> <span class="mf">0.2529</span><span class="p">,</span> <span class="s1">'#71e989'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.3794</span><span class="p">,</span> <span class="mf">0.2408</span><span class="p">,</span> <span class="mf">0.0055</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.8416</span><span class="p">,</span> <span class="mf">0.2538</span><span class="p">,</span> <span class="s1">'#00ec89'</span><span class="p">)],</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'L'</span><span class="p">,</span> <span class="s1">'M'</span><span class="p">,</span> <span class="s1">'S'</span><span class="p">,</span> <span class="s1">'R'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">,</span> <span class="s1">'sRGB_hex'</span><span class="p">]),</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">([</span>
        <span class="p">(</span><span class="mf">0.5488</span><span class="p">,</span> <span class="mf">0.2761</span><span class="p">,</span> <span class="mf">0.0140</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">,</span> <span class="mf">0.7756</span><span class="p">,</span> <span class="mf">0.7990</span><span class="p">,</span> <span class="s1">'#fee3e6'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.5280</span><span class="p">,</span> <span class="mf">0.2761</span><span class="p">,</span> <span class="mf">0.0140</span><span class="p">,</span> <span class="mf">0.8333</span><span class="p">,</span> <span class="mf">0.7959</span><span class="p">,</span> <span class="mf">0.7998</span><span class="p">,</span> <span class="s1">'#ebe6e7'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.5072</span><span class="p">,</span> <span class="mf">0.2761</span><span class="p">,</span> <span class="mf">0.0140</span><span class="p">,</span> <span class="mf">0.6667</span><span class="p">,</span> <span class="mf">0.8163</span><span class="p">,</span> <span class="mf">0.8007</span><span class="p">,</span> <span class="s1">'#d5e9e7'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.4864</span><span class="p">,</span> <span class="mf">0.2761</span><span class="p">,</span> <span class="mf">0.0140</span><span class="p">,</span> <span class="mf">0.5000</span><span class="p">,</span> <span class="mf">0.8367</span><span class="p">,</span> <span class="mf">0.8015</span><span class="p">,</span> <span class="s1">'#bbebe7'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.4655</span><span class="p">,</span> <span class="mf">0.2761</span><span class="p">,</span> <span class="mf">0.0140</span><span class="p">,</span> <span class="mf">0.3334</span><span class="p">,</span> <span class="mf">0.8570</span><span class="p">,</span> <span class="mf">0.8023</span><span class="p">,</span> <span class="s1">'#9ceee7'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.4447</span><span class="p">,</span> <span class="mf">0.2761</span><span class="p">,</span> <span class="mf">0.0140</span><span class="p">,</span> <span class="mf">0.1667</span><span class="p">,</span> <span class="mf">0.8774</span><span class="p">,</span> <span class="mf">0.8032</span><span class="p">,</span> <span class="s1">'#71f0e7'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.4239</span><span class="p">,</span> <span class="mf">0.2761</span><span class="p">,</span> <span class="mf">0.0140</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.8977</span><span class="p">,</span> <span class="mf">0.8040</span><span class="p">,</span> <span class="s1">'#00f3e7'</span><span class="p">)],</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'L'</span><span class="p">,</span> <span class="s1">'M'</span><span class="p">,</span> <span class="s1">'S'</span><span class="p">,</span> <span class="s1">'R'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">,</span> <span class="s1">'sRGB_hex'</span><span class="p">]),</span>
<span class="p">]</span>

<span class="n">show_confusion_lines</span><span class="p">(</span><span class="s1">'Examples of protan confusion lines'</span><span class="p">,</span> <span class="n">protan_confusion_lines</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The colors of some of the 5 lines might be easier to discriminate for some protan, but overall with this point size they should be pretty difficult to differentiate on a monitor screen. Let's also visualize some lines for deuteranopes (parallel to the M axis) and tritanopes (parallel to the S axis).</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Confusion lines for Deficiency.DEUTAN</span>
<span class="n">deutan_confusion_lines</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">([</span>
        <span class="p">(</span><span class="mf">0.1310</span><span class="p">,</span> <span class="mf">0.0311</span><span class="p">,</span> <span class="mf">0.0035</span><span class="p">,</span> <span class="mf">0.6889</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">0.2151</span><span class="p">,</span> <span class="s1">'#d8007f'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1310</span><span class="p">,</span> <span class="mf">0.0400</span><span class="p">,</span> <span class="mf">0.0035</span><span class="p">,</span> <span class="mf">0.5741</span><span class="p">,</span> <span class="mf">0.0470</span><span class="p">,</span> <span class="mf">0.2116</span><span class="p">,</span> <span class="s1">'#c73d7e'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1310</span><span class="p">,</span> <span class="mf">0.0489</span><span class="p">,</span> <span class="mf">0.0035</span><span class="p">,</span> <span class="mf">0.4593</span><span class="p">,</span> <span class="mf">0.0939</span><span class="p">,</span> <span class="mf">0.2080</span><span class="p">,</span> <span class="s1">'#b4567d'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1310</span><span class="p">,</span> <span class="mf">0.0578</span><span class="p">,</span> <span class="mf">0.0035</span><span class="p">,</span> <span class="mf">0.3445</span><span class="p">,</span> <span class="mf">0.1409</span><span class="p">,</span> <span class="mf">0.2045</span><span class="p">,</span> <span class="s1">'#9e687c'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1310</span><span class="p">,</span> <span class="mf">0.0667</span><span class="p">,</span> <span class="mf">0.0035</span><span class="p">,</span> <span class="mf">0.2297</span><span class="p">,</span> <span class="mf">0.1879</span><span class="p">,</span> <span class="mf">0.2009</span><span class="p">,</span> <span class="s1">'#83787b'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1310</span><span class="p">,</span> <span class="mf">0.0756</span><span class="p">,</span> <span class="mf">0.0035</span><span class="p">,</span> <span class="mf">0.1149</span><span class="p">,</span> <span class="mf">0.2348</span><span class="p">,</span> <span class="mf">0.1974</span><span class="p">,</span> <span class="s1">'#5f857a'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1310</span><span class="p">,</span> <span class="mf">0.0846</span><span class="p">,</span> <span class="mf">0.0035</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">0.2818</span><span class="p">,</span> <span class="mf">0.1938</span><span class="p">,</span> <span class="s1">'#009079'</span><span class="p">)],</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'L'</span><span class="p">,</span> <span class="s1">'M'</span><span class="p">,</span> <span class="s1">'S'</span><span class="p">,</span> <span class="s1">'R'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">,</span> <span class="s1">'sRGB_hex'</span><span class="p">]),</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">([</span>
        <span class="p">(</span><span class="mf">0.3274</span><span class="p">,</span> <span class="mf">0.1338</span><span class="p">,</span> <span class="mf">0.0088</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">,</span> <span class="mf">0.2955</span><span class="p">,</span> <span class="mf">0.5155</span><span class="p">,</span> <span class="s1">'#fe93be'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.3274</span><span class="p">,</span> <span class="mf">0.1467</span><span class="p">,</span> <span class="mf">0.0088</span><span class="p">,</span> <span class="mf">0.8333</span><span class="p">,</span> <span class="mf">0.3636</span><span class="p">,</span> <span class="mf">0.5103</span><span class="p">,</span> <span class="s1">'#eba2bd'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.3274</span><span class="p">,</span> <span class="mf">0.1596</span><span class="p">,</span> <span class="mf">0.0088</span><span class="p">,</span> <span class="mf">0.6667</span><span class="p">,</span> <span class="mf">0.4318</span><span class="p">,</span> <span class="mf">0.5052</span><span class="p">,</span> <span class="s1">'#d5afbc'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.3274</span><span class="p">,</span> <span class="mf">0.1726</span><span class="p">,</span> <span class="mf">0.0088</span><span class="p">,</span> <span class="mf">0.5000</span><span class="p">,</span> <span class="mf">0.5000</span><span class="p">,</span> <span class="mf">0.5000</span><span class="p">,</span> <span class="s1">'#bbbbbb'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.3274</span><span class="p">,</span> <span class="mf">0.1855</span><span class="p">,</span> <span class="mf">0.0088</span><span class="p">,</span> <span class="mf">0.3334</span><span class="p">,</span> <span class="mf">0.5682</span><span class="p">,</span> <span class="mf">0.4948</span><span class="p">,</span> <span class="s1">'#9cc6ba'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.3274</span><span class="p">,</span> <span class="mf">0.1985</span><span class="p">,</span> <span class="mf">0.0088</span><span class="p">,</span> <span class="mf">0.1667</span><span class="p">,</span> <span class="mf">0.6363</span><span class="p">,</span> <span class="mf">0.4897</span><span class="p">,</span> <span class="s1">'#71d0b9'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.3274</span><span class="p">,</span> <span class="mf">0.2114</span><span class="p">,</span> <span class="mf">0.0088</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.7045</span><span class="p">,</span> <span class="mf">0.4845</span><span class="p">,</span> <span class="s1">'#00dab8'</span><span class="p">)],</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'L'</span><span class="p">,</span> <span class="s1">'M'</span><span class="p">,</span> <span class="s1">'S'</span><span class="p">,</span> <span class="s1">'R'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">,</span> <span class="s1">'sRGB_hex'</span><span class="p">]),</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">([</span>
        <span class="p">(</span><span class="mf">0.1817</span><span class="p">,</span> <span class="mf">0.0570</span><span class="p">,</span> <span class="mf">0.0120</span><span class="p">,</span> <span class="mf">0.8612</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">0.7689</span><span class="p">,</span> <span class="s1">'#ee00e3'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1817</span><span class="p">,</span> <span class="mf">0.0681</span><span class="p">,</span> <span class="mf">0.0120</span><span class="p">,</span> <span class="mf">0.7176</span><span class="p">,</span> <span class="mf">0.0587</span><span class="p">,</span> <span class="mf">0.7645</span><span class="p">,</span> <span class="s1">'#dc44e2'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1817</span><span class="p">,</span> <span class="mf">0.0792</span><span class="p">,</span> <span class="mf">0.0120</span><span class="p">,</span> <span class="mf">0.5741</span><span class="p">,</span> <span class="mf">0.1174</span><span class="p">,</span> <span class="mf">0.7600</span><span class="p">,</span> <span class="s1">'#c760e1'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1817</span><span class="p">,</span> <span class="mf">0.0904</span><span class="p">,</span> <span class="mf">0.0120</span><span class="p">,</span> <span class="mf">0.4306</span><span class="p">,</span> <span class="mf">0.1761</span><span class="p">,</span> <span class="mf">0.7556</span><span class="p">,</span> <span class="s1">'#af74e1'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1817</span><span class="p">,</span> <span class="mf">0.1015</span><span class="p">,</span> <span class="mf">0.0120</span><span class="p">,</span> <span class="mf">0.2871</span><span class="p">,</span> <span class="mf">0.2348</span><span class="p">,</span> <span class="mf">0.7511</span><span class="p">,</span> <span class="s1">'#9185e0'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1817</span><span class="p">,</span> <span class="mf">0.1127</span><span class="p">,</span> <span class="mf">0.0120</span><span class="p">,</span> <span class="mf">0.1436</span><span class="p">,</span> <span class="mf">0.2935</span><span class="p">,</span> <span class="mf">0.7467</span><span class="p">,</span> <span class="s1">'#6993e0'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1817</span><span class="p">,</span> <span class="mf">0.1238</span><span class="p">,</span> <span class="mf">0.0120</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.3522</span><span class="p">,</span> <span class="mf">0.7423</span><span class="p">,</span> <span class="s1">'#00a0df'</span><span class="p">)],</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'L'</span><span class="p">,</span> <span class="s1">'M'</span><span class="p">,</span> <span class="s1">'S'</span><span class="p">,</span> <span class="s1">'R'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">,</span> <span class="s1">'sRGB_hex'</span><span class="p">]),</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">([</span>
        <span class="p">(</span><span class="mf">0.4731</span><span class="p">,</span> <span class="mf">0.2214</span><span class="p">,</span> <span class="mf">0.0055</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">,</span> <span class="mf">0.6477</span><span class="p">,</span> <span class="mf">0.2577</span><span class="p">,</span> <span class="s1">'#fed28a'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.4731</span><span class="p">,</span> <span class="mf">0.2325</span><span class="p">,</span> <span class="mf">0.0055</span><span class="p">,</span> <span class="mf">0.8565</span><span class="p">,</span> <span class="mf">0.7064</span><span class="p">,</span> <span class="mf">0.2533</span><span class="p">,</span> <span class="s1">'#eeda89'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.4731</span><span class="p">,</span> <span class="mf">0.2436</span><span class="p">,</span> <span class="mf">0.0055</span><span class="p">,</span> <span class="mf">0.7130</span><span class="p">,</span> <span class="mf">0.7652</span><span class="p">,</span> <span class="mf">0.2489</span><span class="p">,</span> <span class="s1">'#dbe288'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.4731</span><span class="p">,</span> <span class="mf">0.2548</span><span class="p">,</span> <span class="mf">0.0055</span><span class="p">,</span> <span class="mf">0.5694</span><span class="p">,</span> <span class="mf">0.8239</span><span class="p">,</span> <span class="mf">0.2444</span><span class="p">,</span> <span class="s1">'#c6ea87'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.4731</span><span class="p">,</span> <span class="mf">0.2659</span><span class="p">,</span> <span class="mf">0.0055</span><span class="p">,</span> <span class="mf">0.4259</span><span class="p">,</span> <span class="mf">0.8826</span><span class="p">,</span> <span class="mf">0.2400</span><span class="p">,</span> <span class="s1">'#aef186'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.4731</span><span class="p">,</span> <span class="mf">0.2771</span><span class="p">,</span> <span class="mf">0.0055</span><span class="p">,</span> <span class="mf">0.2824</span><span class="p">,</span> <span class="mf">0.9413</span><span class="p">,</span> <span class="mf">0.2355</span><span class="p">,</span> <span class="s1">'#90f885'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.4731</span><span class="p">,</span> <span class="mf">0.2882</span><span class="p">,</span> <span class="mf">0.0055</span><span class="p">,</span> <span class="mf">0.1389</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">,</span> <span class="mf">0.2311</span><span class="p">,</span> <span class="s1">'#68fe84'</span><span class="p">)],</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'L'</span><span class="p">,</span> <span class="s1">'M'</span><span class="p">,</span> <span class="s1">'S'</span><span class="p">,</span> <span class="s1">'R'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">,</span> <span class="s1">'sRGB_hex'</span><span class="p">]),</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">([</span>
        <span class="p">(</span><span class="mf">0.5238</span><span class="p">,</span> <span class="mf">0.3141</span><span class="p">,</span> <span class="mf">0.0140</span><span class="p">,</span> <span class="mf">0.3111</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">,</span> <span class="mf">0.7849</span><span class="p">,</span> <span class="s1">'#97fee5'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.5238</span><span class="p">,</span> <span class="mf">0.3052</span><span class="p">,</span> <span class="mf">0.0140</span><span class="p">,</span> <span class="mf">0.4259</span><span class="p">,</span> <span class="mf">0.9530</span><span class="p">,</span> <span class="mf">0.7884</span><span class="p">,</span> <span class="s1">'#aef9e5'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.5238</span><span class="p">,</span> <span class="mf">0.2963</span><span class="p">,</span> <span class="mf">0.0140</span><span class="p">,</span> <span class="mf">0.5407</span><span class="p">,</span> <span class="mf">0.9061</span><span class="p">,</span> <span class="mf">0.7920</span><span class="p">,</span> <span class="s1">'#c2f4e6'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.5238</span><span class="p">,</span> <span class="mf">0.2873</span><span class="p">,</span> <span class="mf">0.0140</span><span class="p">,</span> <span class="mf">0.6555</span><span class="p">,</span> <span class="mf">0.8591</span><span class="p">,</span> <span class="mf">0.7955</span><span class="p">,</span> <span class="s1">'#d3eee6'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.5238</span><span class="p">,</span> <span class="mf">0.2784</span><span class="p">,</span> <span class="mf">0.0140</span><span class="p">,</span> <span class="mf">0.7703</span><span class="p">,</span> <span class="mf">0.8121</span><span class="p">,</span> <span class="mf">0.7991</span><span class="p">,</span> <span class="s1">'#e3e8e6'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.5238</span><span class="p">,</span> <span class="mf">0.2695</span><span class="p">,</span> <span class="mf">0.0140</span><span class="p">,</span> <span class="mf">0.8851</span><span class="p">,</span> <span class="mf">0.7652</span><span class="p">,</span> <span class="mf">0.8026</span><span class="p">,</span> <span class="s1">'#f1e2e7'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.5238</span><span class="p">,</span> <span class="mf">0.2606</span><span class="p">,</span> <span class="mf">0.0140</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">,</span> <span class="mf">0.7182</span><span class="p">,</span> <span class="mf">0.8062</span><span class="p">,</span> <span class="s1">'#fedce7'</span><span class="p">)],</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'L'</span><span class="p">,</span> <span class="s1">'M'</span><span class="p">,</span> <span class="s1">'S'</span><span class="p">,</span> <span class="s1">'R'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">,</span> <span class="s1">'sRGB_hex'</span><span class="p">]),</span>
<span class="p">]</span>

<span class="n">show_confusion_lines</span><span class="p">(</span><span class="s1">'Examples of deutan confusion lines'</span><span class="p">,</span> <span class="n">deutan_confusion_lines</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Confusion lines for Deficiency.TRITAN</span>
<span class="n">tritan_confusion_lines</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">([</span>
        <span class="p">(</span><span class="mf">0.1310</span><span class="p">,</span> <span class="mf">0.0690</span><span class="p">,</span> <span class="mf">0.0005</span><span class="p">,</span> <span class="mf">0.1649</span><span class="p">,</span> <span class="mf">0.2306</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="s1">'#708300'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1310</span><span class="p">,</span> <span class="mf">0.0690</span><span class="p">,</span> <span class="mf">0.0030</span><span class="p">,</span> <span class="mf">0.1941</span><span class="p">,</span> <span class="mf">0.2051</span><span class="p">,</span> <span class="mf">0.1667</span><span class="p">,</span> <span class="s1">'#797d71'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1310</span><span class="p">,</span> <span class="mf">0.0690</span><span class="p">,</span> <span class="mf">0.0055</span><span class="p">,</span> <span class="mf">0.2234</span><span class="p">,</span> <span class="mf">0.1796</span><span class="p">,</span> <span class="mf">0.3333</span><span class="p">,</span> <span class="s1">'#82759c'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1310</span><span class="p">,</span> <span class="mf">0.0690</span><span class="p">,</span> <span class="mf">0.0080</span><span class="p">,</span> <span class="mf">0.2527</span><span class="p">,</span> <span class="mf">0.1541</span><span class="p">,</span> <span class="mf">0.5000</span><span class="p">,</span> <span class="s1">'#896dbb'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1310</span><span class="p">,</span> <span class="mf">0.0690</span><span class="p">,</span> <span class="mf">0.0105</span><span class="p">,</span> <span class="mf">0.2820</span><span class="p">,</span> <span class="mf">0.1285</span><span class="p">,</span> <span class="mf">0.6666</span><span class="p">,</span> <span class="s1">'#9064d5'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1310</span><span class="p">,</span> <span class="mf">0.0690</span><span class="p">,</span> <span class="mf">0.0130</span><span class="p">,</span> <span class="mf">0.3113</span><span class="p">,</span> <span class="mf">0.1030</span><span class="p">,</span> <span class="mf">0.8333</span><span class="p">,</span> <span class="s1">'#975aeb'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1310</span><span class="p">,</span> <span class="mf">0.0690</span><span class="p">,</span> <span class="mf">0.0155</span><span class="p">,</span> <span class="mf">0.3405</span><span class="p">,</span> <span class="mf">0.0775</span><span class="p">,</span> <span class="mf">0.9999</span><span class="p">,</span> <span class="s1">'#9d4efe'</span><span class="p">)],</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'L'</span><span class="p">,</span> <span class="s1">'M'</span><span class="p">,</span> <span class="s1">'S'</span><span class="p">,</span> <span class="s1">'R'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">,</span> <span class="s1">'sRGB_hex'</span><span class="p">]),</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">([</span>
        <span class="p">(</span><span class="mf">0.3274</span><span class="p">,</span> <span class="mf">0.1726</span><span class="p">,</span> <span class="mf">0.0163</span><span class="p">,</span> <span class="mf">0.5878</span><span class="p">,</span> <span class="mf">0.4234</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">,</span> <span class="s1">'#c9aefe'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.3274</span><span class="p">,</span> <span class="mf">0.1726</span><span class="p">,</span> <span class="mf">0.0138</span><span class="p">,</span> <span class="mf">0.5586</span><span class="p">,</span> <span class="mf">0.4489</span><span class="p">,</span> <span class="mf">0.8333</span><span class="p">,</span> <span class="s1">'#c5b2eb'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.3274</span><span class="p">,</span> <span class="mf">0.1726</span><span class="p">,</span> <span class="mf">0.0113</span><span class="p">,</span> <span class="mf">0.5293</span><span class="p">,</span> <span class="mf">0.4745</span><span class="p">,</span> <span class="mf">0.6667</span><span class="p">,</span> <span class="s1">'#c0b7d5'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.3274</span><span class="p">,</span> <span class="mf">0.1726</span><span class="p">,</span> <span class="mf">0.0088</span><span class="p">,</span> <span class="mf">0.5000</span><span class="p">,</span> <span class="mf">0.5000</span><span class="p">,</span> <span class="mf">0.5000</span><span class="p">,</span> <span class="s1">'#bbbbbb'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.3274</span><span class="p">,</span> <span class="mf">0.1726</span><span class="p">,</span> <span class="mf">0.0062</span><span class="p">,</span> <span class="mf">0.4707</span><span class="p">,</span> <span class="mf">0.5255</span><span class="p">,</span> <span class="mf">0.3334</span><span class="p">,</span> <span class="s1">'#b6bf9c'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.3274</span><span class="p">,</span> <span class="mf">0.1726</span><span class="p">,</span> <span class="mf">0.0037</span><span class="p">,</span> <span class="mf">0.4414</span><span class="p">,</span> <span class="mf">0.5510</span><span class="p">,</span> <span class="mf">0.1667</span><span class="p">,</span> <span class="s1">'#b1c371'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.3274</span><span class="p">,</span> <span class="mf">0.1726</span><span class="p">,</span> <span class="mf">0.0012</span><span class="p">,</span> <span class="mf">0.4122</span><span class="p">,</span> <span class="mf">0.5766</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="s1">'#abc700'</span><span class="p">)],</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'L'</span><span class="p">,</span> <span class="s1">'M'</span><span class="p">,</span> <span class="s1">'S'</span><span class="p">,</span> <span class="s1">'R'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">,</span> <span class="s1">'sRGB_hex'</span><span class="p">]),</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">([</span>
        <span class="p">(</span><span class="mf">0.1817</span><span class="p">,</span> <span class="mf">0.1044</span><span class="p">,</span> <span class="mf">0.0158</span><span class="p">,</span> <span class="mf">0.2939</span><span class="p">,</span> <span class="mf">0.2117</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">,</span> <span class="s1">'#937efe'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1817</span><span class="p">,</span> <span class="mf">0.1044</span><span class="p">,</span> <span class="mf">0.0133</span><span class="p">,</span> <span class="mf">0.2646</span><span class="p">,</span> <span class="mf">0.2372</span><span class="p">,</span> <span class="mf">0.8333</span><span class="p">,</span> <span class="s1">'#8c85eb'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1817</span><span class="p">,</span> <span class="mf">0.1044</span><span class="p">,</span> <span class="mf">0.0108</span><span class="p">,</span> <span class="mf">0.2354</span><span class="p">,</span> <span class="mf">0.2628</span><span class="p">,</span> <span class="mf">0.6667</span><span class="p">,</span> <span class="s1">'#858cd5'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1817</span><span class="p">,</span> <span class="mf">0.1044</span><span class="p">,</span> <span class="mf">0.0083</span><span class="p">,</span> <span class="mf">0.2061</span><span class="p">,</span> <span class="mf">0.2883</span><span class="p">,</span> <span class="mf">0.5000</span><span class="p">,</span> <span class="s1">'#7d92bb'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1817</span><span class="p">,</span> <span class="mf">0.1044</span><span class="p">,</span> <span class="mf">0.0058</span><span class="p">,</span> <span class="mf">0.1768</span><span class="p">,</span> <span class="mf">0.3138</span><span class="p">,</span> <span class="mf">0.3334</span><span class="p">,</span> <span class="s1">'#74979c'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1817</span><span class="p">,</span> <span class="mf">0.1044</span><span class="p">,</span> <span class="mf">0.0032</span><span class="p">,</span> <span class="mf">0.1475</span><span class="p">,</span> <span class="mf">0.3393</span><span class="p">,</span> <span class="mf">0.1667</span><span class="p">,</span> <span class="s1">'#6b9d71'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1817</span><span class="p">,</span> <span class="mf">0.1044</span><span class="p">,</span> <span class="mf">0.0007</span><span class="p">,</span> <span class="mf">0.1182</span><span class="p">,</span> <span class="mf">0.3649</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="s1">'#60a200'</span><span class="p">)],</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'L'</span><span class="p">,</span> <span class="s1">'M'</span><span class="p">,</span> <span class="s1">'S'</span><span class="p">,</span> <span class="s1">'R'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">,</span> <span class="s1">'sRGB_hex'</span><span class="p">]),</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">([</span>
        <span class="p">(</span><span class="mf">0.4731</span><span class="p">,</span> <span class="mf">0.2408</span><span class="p">,</span> <span class="mf">0.0168</span><span class="p">,</span> <span class="mf">0.8818</span><span class="p">,</span> <span class="mf">0.6351</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">,</span> <span class="s1">'#f1d0fe'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.4731</span><span class="p">,</span> <span class="mf">0.2408</span><span class="p">,</span> <span class="mf">0.0143</span><span class="p">,</span> <span class="mf">0.8525</span><span class="p">,</span> <span class="mf">0.6606</span><span class="p">,</span> <span class="mf">0.8333</span><span class="p">,</span> <span class="s1">'#edd4eb'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.4731</span><span class="p">,</span> <span class="mf">0.2408</span><span class="p">,</span> <span class="mf">0.0118</span><span class="p">,</span> <span class="mf">0.8232</span><span class="p">,</span> <span class="mf">0.6862</span><span class="p">,</span> <span class="mf">0.6667</span><span class="p">,</span> <span class="s1">'#ead7d5'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.4731</span><span class="p">,</span> <span class="mf">0.2408</span><span class="p">,</span> <span class="mf">0.0093</span><span class="p">,</span> <span class="mf">0.7939</span><span class="p">,</span> <span class="mf">0.7117</span><span class="p">,</span> <span class="mf">0.5000</span><span class="p">,</span> <span class="s1">'#e6dbbb'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.4731</span><span class="p">,</span> <span class="mf">0.2408</span><span class="p">,</span> <span class="mf">0.0067</span><span class="p">,</span> <span class="mf">0.7646</span><span class="p">,</span> <span class="mf">0.7372</span><span class="p">,</span> <span class="mf">0.3334</span><span class="p">,</span> <span class="s1">'#e2de9c'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.4731</span><span class="p">,</span> <span class="mf">0.2408</span><span class="p">,</span> <span class="mf">0.0042</span><span class="p">,</span> <span class="mf">0.7354</span><span class="p">,</span> <span class="mf">0.7628</span><span class="p">,</span> <span class="mf">0.1667</span><span class="p">,</span> <span class="s1">'#dee271'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.4731</span><span class="p">,</span> <span class="mf">0.2408</span><span class="p">,</span> <span class="mf">0.0017</span><span class="p">,</span> <span class="mf">0.7061</span><span class="p">,</span> <span class="mf">0.7883</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="s1">'#dae500'</span><span class="p">)],</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'L'</span><span class="p">,</span> <span class="s1">'M'</span><span class="p">,</span> <span class="s1">'S'</span><span class="p">,</span> <span class="s1">'R'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">,</span> <span class="s1">'sRGB_hex'</span><span class="p">]),</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">([</span>
        <span class="p">(</span><span class="mf">0.5238</span><span class="p">,</span> <span class="mf">0.2761</span><span class="p">,</span> <span class="mf">0.0170</span><span class="p">,</span> <span class="mf">0.8351</span><span class="p">,</span> <span class="mf">0.7694</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">,</span> <span class="s1">'#ebe3fe'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.5238</span><span class="p">,</span> <span class="mf">0.2761</span><span class="p">,</span> <span class="mf">0.0145</span><span class="p">,</span> <span class="mf">0.8059</span><span class="p">,</span> <span class="mf">0.7949</span><span class="p">,</span> <span class="mf">0.8333</span><span class="p">,</span> <span class="s1">'#e7e6eb'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.5238</span><span class="p">,</span> <span class="mf">0.2761</span><span class="p">,</span> <span class="mf">0.0120</span><span class="p">,</span> <span class="mf">0.7766</span><span class="p">,</span> <span class="mf">0.8204</span><span class="p">,</span> <span class="mf">0.6667</span><span class="p">,</span> <span class="s1">'#e4e9d5'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.5238</span><span class="p">,</span> <span class="mf">0.2761</span><span class="p">,</span> <span class="mf">0.0095</span><span class="p">,</span> <span class="mf">0.7473</span><span class="p">,</span> <span class="mf">0.8459</span><span class="p">,</span> <span class="mf">0.5000</span><span class="p">,</span> <span class="s1">'#e0ecbb'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.5238</span><span class="p">,</span> <span class="mf">0.2761</span><span class="p">,</span> <span class="mf">0.0070</span><span class="p">,</span> <span class="mf">0.7180</span><span class="p">,</span> <span class="mf">0.8715</span><span class="p">,</span> <span class="mf">0.3334</span><span class="p">,</span> <span class="s1">'#dcf09c'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.5238</span><span class="p">,</span> <span class="mf">0.2761</span><span class="p">,</span> <span class="mf">0.0045</span><span class="p">,</span> <span class="mf">0.6887</span><span class="p">,</span> <span class="mf">0.8970</span><span class="p">,</span> <span class="mf">0.1667</span><span class="p">,</span> <span class="s1">'#d8f371'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.5238</span><span class="p">,</span> <span class="mf">0.2761</span><span class="p">,</span> <span class="mf">0.0020</span><span class="p">,</span> <span class="mf">0.6595</span><span class="p">,</span> <span class="mf">0.9225</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="s1">'#d4f600'</span><span class="p">)],</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'L'</span><span class="p">,</span> <span class="s1">'M'</span><span class="p">,</span> <span class="s1">'S'</span><span class="p">,</span> <span class="s1">'R'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">,</span> <span class="s1">'sRGB_hex'</span><span class="p">]),</span>
<span class="p">]</span>

<span class="n">show_confusion_lines</span><span class="p">(</span><span class="s1">'Examples of tritan confusion lines'</span><span class="p">,</span> <span class="n">tritan_confusion_lines</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>At this stage if you are affected by a color vision deficiency you might already have a more precise idea of what kind of dichromacy better models your color vision. For me the colors of the protan confusion lines look pretty similar for such a small point size, but I can better distinguish the deutan lines and very well the tritan ones.</p>
<p>So now that we can compute these confusion lines for each kind of dichromacy, can we simulate how a person with a CVD sees? Since it's related to perception it's impossible to know how another person "feels" the colors, but to understand the loss of color sensitivity we can transform images so that all the colors on each confusion line projects to a single one, essentially making the color space 2D. If the models are correct then the transformed image should still appear identical to a dichromat, and a trichromat will get a sense of the color differences that get lost for the dichromat.</p>
<p>The remaining question is what color should we pick to represent each confusion line? That will be the subject of the <a href="#Simulating-dichromacy-in-LMS">Simulating dichromacy in LMS</a> section.</p>
<p>Finally once the LMS colors are projected along the confusion lines, we can transform them back to the linearRGB and then sRGB color spaces to get the final simulated image. The overall process is summarized in the diagram below, and we're going to dive into each part in the next sections.</p>
<p><img src="/images/copied_from_nb/simulation_images/CVD_Simulation_Pipeline.svg" alt="image" title="CVS Simulation Pipeline"></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="From-sRGB-to-LMS">
<a class="anchor" href="#From-sRGB-to-LMS" aria-hidden="true"><span class="octicon octicon-link"></span></a>From sRGB to LMS<a class="anchor-link" href="#From-sRGB-to-LMS"> </a>
</h2>
<p>In this section we're going to review the steps to go to that nice LMS color space. Several models have been proposed in the litterature, so there is not just one way to do it.</p>
<h3 id="From-sRGB-to-linearRGB">
<a class="anchor" href="#From-sRGB-to-linearRGB" aria-hidden="true"><span class="octicon octicon-link"></span></a>From sRGB to linearRGB<a class="anchor-link" href="#From-sRGB-to-linearRGB"> </a>
</h3>
<p>Most digital images are encoded with 3 values per pixel: red, green and blue. But what is often neglected is that this "RGB" usually corresponds to the sRGB standard that precisely define how these values should be interpreted. sRGB is not a linear space because it tries to compensate the non-linear gamma factor applied by monitors, so that the image captured by a digital camera and then rendered on a monitor will look like the original scene.</p>
<p>We'll call the RGB color space after removing that non-linearity the <em>linearRGB</em> color space. The transformation roughly corresponds to applying a gamma exponent of 2.4 on each channel like a typical monitor would do, with a special linear slope for very small values. So unlike all the other color transformations of that notebook it is non-linear and cannot be expressed as a matrix.</p>
<p>The good news is that sRGB is a well-defined standard now, so we just need to implement the function given by the standard. For more details see <a href="https://en.wikipedia.org/wiki/SRGB">the wikipedia page</a>.</p>
<p>Since both Brettel 1997 and Viénot 1999 were published before the sRGB standard became mainstream, they had to calibrate their old CRT monitor and publish their own model in the paper. So their matrices must be adapted to use the new sRGB model. Even worse, even if the Viénot 1999 paper explicitely mentions the required non-linear transform for their CRT monitor, the most widely replicated matlab code from <a class="citation" href="#fidaner_analysis_2005">(Fidaner, Lin, &amp; Ozguven, 2005)</a> does not take it into account and directly treat the input image as linear RGB. As a consequence this is also the case of most of the source code listed on <a class="citation" href="#daltonize_org">(<i>Daltonize.org</i>, 2010)</a>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Does-it-matter?-Yes!">
<a class="anchor" href="#Does-it-matter?-Yes!" aria-hidden="true"><span class="octicon octicon-link"></span></a>Does it matter? Yes!<a class="anchor-link" href="#Does-it-matter?-Yes!"> </a>
</h4>
<p>As you can see in the image below forgetting the sRGB -&gt; linearRGB transform makes a big difference and it can invalidate perceptual experiments. The first row has 4 sRGB colors, and the second row shows the same colors wrongly interpreted as linear RGB.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">im_sRGB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[[</span><span class="mi">127</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">64</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">192</span><span class="p">],</span> <span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">192</span><span class="p">]]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span>
<span class="n">px</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">im_sRGB</span><span class="p">,</span> <span class="c1"># First row is the sRGB content</span>
                     <span class="n">convert</span><span class="o">.</span><span class="n">linearRGB_from_sRGB</span><span class="p">(</span><span class="n">im_sRGB</span><span class="p">)]),</span> 
          <span class="n">title</span><span class="o">=</span><span class="s1">'sRGB(first row) vs linear RGB (second row)'</span><span class="p">)</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">hide_image_axes</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>And the impact is also significant on the final simulation, here is a comparison of Vienot 1999 implemented with and without the proper sRGB decoding / encoding. Note how a bunch of colors appear too dark in the simulation without sRGB.</p>
<p><!-- Image tags have to be unindented for nbdev to catch them :-( --></p>
<table>
    <tr>
<th>Original</th>
<th> Viénot 1999</th>
<th>Viénot 1999 without sRGB</th>
</tr>
    <tr>
<td>
<figure>
  
    <img class="docimage" src="/images/copied_from_nb/simulation_images/rgbspan.png" alt="">
    
    
</figure>
</td>
<td>
<figure>
  
    <img class="docimage" src="/images/copied_from_nb/simulation_images/rgbspan_protan_vienot1999.png" alt="">
    
    
</figure>
</td>
<td>
<figure>
  
    <img class="docimage" src="/images/copied_from_nb/simulation_images/rgbspan_protan_vienot1999_missing_srgb.png" alt="">
    
    
</figure>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="From-linearRGB-to-CIE-XYZ">
<a class="anchor" href="#From-linearRGB-to-CIE-XYZ" aria-hidden="true"><span class="octicon octicon-link"></span></a>From linearRGB to CIE XYZ<a class="anchor-link" href="#From-linearRGB-to-CIE-XYZ"> </a>
</h3>
<p>So far we only mentioned the LMS color space, saying that we'd just go from linearRGB to LMS. But to understand the litterature around that transform it is necessary to add an intermediate step which is the CIE XYZ color space. The reason is historical, this color space was standardized in 1931 and it has been used as the main space for color science research since. The main reason is that it can (almost) represent the full range of colors that can be perceived by an average human observer with just 3 values, is device-independent, and has a well-defined relationship w.r.t the input light spectrum.
</p>
<div class="flash">
    <svg class="octicon octicon-info octicon octicon-info" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z"></path></svg>
    <strong>Note: </strong>dichromats confusion lines are sometimes shown in the CIE XYZ color space (e.g. on <a href="http://www.color-blindness.com/2009/01/19/colorblind-colors-of-confusion/">color-blindness.com</a>), usually drawing the lines on a so-called chromaticity diagram. These diagram are a 2d projection of the CIE XYZ color space for a constant maximal luminance. I always got confused about those because I could clearly see differences along these lines, especially when they transition from green to red. The reason is that the confusion lines are actually 3d in CIE XYZ and the luminance needs to get adjusted as the hue/chroma changes along the line to actually get confused by a dichromat.
</div>
The <a href="https://en.wikipedia.org/wiki/SRGB#The_reverse_transformation_(sRGB_to_CIE_XYZ">sRGB wikipedia page</a> gives the <code>XYZ_from_linearRGB</code> matrix defined by the standard itself. As we noted Viénot 1999 used a different matrix resulting from a generic CRT monitor. That matrix was kept in <a class="citation" href="#fidaner_analysis_2005">(Fidaner, Lin, &amp; Ozguven, 2005)</a> and is thus still widespread today.
<p>However as <a class="citation" href="#simon_liedtke_using_2016">(Simon-Liedtke &amp; Farup, 2016)</a> noted, we should now use the modern sRGB-induced transform for LCD monitors. This is also the model correctly used by <a class="citation" href="#dietrich_daltonize_2020">(Dietrich &amp; daltonize.py, 2020)</a> and <a class="citation" href="#jim_ixora_2021">(Jim &amp; Ixora, 2021)</a>.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">printMatrix</span><span class="p">(</span><span class="s1">'Vienot1999 XYZ_from_linearRGB'</span><span class="p">,</span> <span class="n">convert</span><span class="o">.</span><span class="n">LMSModel_Vienot1999_SmithPokorny75</span><span class="p">()</span><span class="o">.</span><span class="n">XYZ_from_linearRGB</span><span class="o">*</span><span class="mf">255.0</span><span class="p">);</span> <span class="nb">print</span><span class="p">()</span>
<span class="n">printMatrix</span><span class="p">(</span><span class="s1">'sRGB XYZ_from_linearRGB'</span><span class="p">,</span> <span class="n">convert</span><span class="o">.</span><span class="n">LMSModel_sRGB_SmithPokorny75</span><span class="p">()</span><span class="o">.</span><span class="n">XYZ_from_linearRGB</span><span class="o">*</span><span class="mi">255</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="From-CIE-XYZ-to-LMS">
<a class="anchor" href="#From-CIE-XYZ-to-LMS" aria-hidden="true"><span class="octicon octicon-link"></span></a>From CIE XYZ to LMS<a class="anchor-link" href="#From-CIE-XYZ-to-LMS"> </a>
</h3>
<p>That conversion is less clear as many more transforms have been proposed, with different motivations. The most relevant models for CVD simulations are based on color matching experiments with people who happen to have one normal trichromat eye and one dichromat eye (unilateral dichromats).</p>
<p>The most widely used conversion for CVD simulation is still <a class="citation" href="#smith_spectral_1975">(Smith &amp; Pokorny, 1975)</a>, which is the one used by Brettel 1997 and Viénot 1999. The earlier seminal work of <a class="citation" href="#meyer_color_defective_1988">(Meyer &amp; Greenberg, 1988)</a> used another transform from <a class="citation" href="#estevez1981fundamental">(Estévez, 1981)</a> but it already mentioned <a class="citation" href="#smith_spectral_1975">(Smith &amp; Pokorny, 1975)</a> as being a good candidate. Another popular reference model in the litterature is the Hunt-Pointer-Esterez one (missing reference). It is used a lot for chromatic adaptation (predicting how a perceived color will change with the illumination conditions), but less for CVD simulation experiments.</p>
<p><a class="citation" href="#stockman_spectral_2000">(Stockman &amp; Sharpe, 2000)</a> made a thorough comparison of the models, and they also propose a new matrix (for a 10 degree standard observer). But overall they are in good agreement with <a class="citation" href="#smith_spectral_1975">(Smith &amp; Pokorny, 1975)</a> once adjusted for a 2 degree observer, with larger differences compared to Hunt-Pointer-Esterez. All 3 are probably reasonable options, but since the CVD simulation evaluations were most often made and evaluated with Smith &amp; Pokorny it's probably still the most solid choice, despite its age. It is also interesting to note that both Pokorny and Viénot continue to promote that transform in more recent papers <a class="citation" href="#vienot_colorimetry_2013">(Viénot &amp; Le Rohellec, 2013)</a> <a class="citation" href="#smith_color_2003">(Smith &amp; Pokorny, 2003)</a>, and other recent papers in the color science research litterature do the same <a class="citation" href="#machado_physiologically_based_2009">(Machado, Oliveira, &amp; Fernandes, 2009)</a> <a class="citation" href="#simon_liedtke_using_2016">(Simon-Liedtke &amp; Farup, 2016)</a>.</p>
<p>Most opensource code uses the Smith and Pokorny since they did not modify the original code, but <a class="citation" href="#jim_ixora_2021">(Jim &amp; Ixora, 2021)</a> uses the Hunt-Pointer-Estevez matrix and <a class="citation" href="#dietrich_daltonize_2020">(Dietrich &amp; daltonize.py, 2020)</a> uses the sharpened transformation matrix of CIECAM02. These two matrices are on the Wikipedia page and look attractive as they are more recent. But at least the "sharpened" matrices variants are not meant to match the physiological cone responses but to perform hue-preserving chromatic adaptation (see the discussion p181 of <a class="citation" href="#fairchild2013color">(Fairchild, 2013)</a>). So I would argue that we should keep using Smith &amp; Pokorny transform until a proper validation of newer matrices gets done for CVD simulation.
</p>
<div class="flash">
    <svg class="octicon octicon-info octicon octicon-info octicon octicon-info" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z"></path></svg>
    <strong>Note: </strong>the XYZ&lt;-&gt;LMS matrices of the different models can look very different, but the main reason is the normalization factor. There is no unique "scale" for each axis, so each model picked a convention. For example Smith &amp; Pokorny made it so L+S=Y and S/Y=1 at the 400nm wavelengths. For Hunt-Pointer-Esterez they normalize it so that L=M=S for the equal-energy illuminant E (X=Y=Z=1/3), which means that the sum of each rows equals to 1. One reason for this scale variance is that the human vision system can actually change it independently for each axis depending on the illumination conditions. This process is called <em>chromatic adaptation</em> and explains why we still perceive a white sheet of paper as white under an incandescent indoor lighting that makes it actually yellow-ish. It’s a bit similar to the white balance correction of digital cameras. These normalizations do not really matter for CVD simulation since the angles between the axis do not change with it and the scale factor will get removed when we go back to RGB.
</div>
Below are some example of those <code>LMS_from_XYZ</code> matrices.

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">printMatrix</span><span class="p">(</span><span class="s1">'Smith &amp; Pokorny (Viénot) LMS_from_XYZ'</span><span class="p">,</span> <span class="n">convert</span><span class="o">.</span><span class="n">LMSModel_Vienot1999_SmithPokorny75</span><span class="p">()</span><span class="o">.</span><span class="n">LMS_from_XYZ</span><span class="p">);</span> <span class="nb">print</span><span class="p">()</span>
<span class="n">printMatrix</span><span class="p">(</span><span class="s1">'Hunt-Pointer-Estevez LMS_from_XYZ'</span><span class="p">,</span> <span class="n">convert</span><span class="o">.</span><span class="n">LMSModel_sRGB_HuntPointerEstevez</span><span class="p">()</span><span class="o">.</span><span class="n">LMS_from_XYZ</span><span class="p">);</span> <span class="nb">print</span><span class="p">()</span>
<span class="n">printMatrix</span><span class="p">(</span><span class="s1">'Stockman-Sharpe LMS_from_XYZ'</span><span class="p">,</span> <span class="n">convert</span><span class="o">.</span><span class="n">LMSModel_sRGB_StockmanSharpe2000</span><span class="p">()</span><span class="o">.</span><span class="n">LMS_from_XYZ</span><span class="p">);</span> <span class="nb">print</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Putting-it-together">
<a class="anchor" href="#Putting-it-together" aria-hidden="true"><span class="octicon octicon-link"></span></a>Putting it together<a class="anchor-link" href="#Putting-it-together"> </a>
</h3>
<p>Since both <code>XYZ_from_linearRGB</code> and <code>LMS_from_XYZ</code> are linear transforms, we can just combine the two matrices to get a final <code>LMS_from_linearRGB = LMS_from_XYZ . XYZ_from_linearRGB</code> transform. Here are some of the models implemented in DaltonLens, scaled by 255 for an easier comparison with existing opensource code:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">printMatrix</span><span class="p">(</span><span class="s1">'Viénot 1999</span><span class="se">\n</span><span class="s1">LMS_from_linearRGB'</span><span class="p">,</span> <span class="n">convert</span><span class="o">.</span><span class="n">LMSModel_Vienot1999_SmithPokorny75</span><span class="p">()</span><span class="o">.</span><span class="n">LMS_from_linearRGB</span><span class="o">*</span><span class="mf">255.0</span><span class="p">);</span> <span class="nb">print</span><span class="p">()</span>
<span class="n">printMatrix</span><span class="p">(</span><span class="s1">'sRGB Viénot</span><span class="se">\n</span><span class="s1">LMS_from_linearRGB'</span><span class="p">,</span> <span class="n">convert</span><span class="o">.</span><span class="n">LMSModel_sRGB_SmithPokorny75</span><span class="p">()</span><span class="o">.</span><span class="n">LMS_from_linearRGB</span><span class="o">*</span><span class="mf">255.0</span><span class="p">);</span> <span class="nb">print</span><span class="p">()</span>
<span class="n">printMatrix</span><span class="p">(</span><span class="s1">'Hunt-Pointer-Esterez</span><span class="se">\n</span><span class="s1">LMS_from_linearRGB'</span><span class="p">,</span> <span class="n">convert</span><span class="o">.</span><span class="n">LMSModel_sRGB_HuntPointerEstevez</span><span class="p">()</span><span class="o">.</span><span class="n">LMS_from_linearRGB</span><span class="o">*</span><span class="mf">255.0</span><span class="p">);</span> <span class="nb">print</span><span class="p">()</span>
<span class="n">printMatrix</span><span class="p">(</span><span class="s1">'Stockman &amp; Sharpe</span><span class="se">\n</span><span class="s1">LMS_from_linearRGB'</span><span class="p">,</span> <span class="n">convert</span><span class="o">.</span><span class="n">LMSModel_sRGB_StockmanSharpe2000</span><span class="p">()</span><span class="o">.</span><span class="n">LMS_from_linearRGB</span><span class="o">*</span><span class="mf">255.0</span><span class="p">);</span> <span class="nb">print</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Simulating-dichromacy-in-LMS-(Brettel-&amp;-Mollon-1997)">
<a class="anchor" href="#Simulating-dichromacy-in-LMS-(Brettel-&amp;-Mollon-1997)" aria-hidden="true"><span class="octicon octicon-link"></span></a>Simulating dichromacy in LMS (Brettel &amp; Mollon 1997)<a class="anchor-link" href="#Simulating-dichromacy-in-LMS-(Brettel-&amp;-Mollon-1997)"> </a>
</h2>
<p>Let's rebuild the seminal paper of <a class="citation" href="#brettel_computerized_1997">(Brettel &amp; Mollon, 1997)</a> that built a precise model based on perceptual experiments. <a class="citation" href="#vienot_digital_1999">(Viénot, Brettel, &amp; Mollon, 1999)</a> then simplified it for its use with digital monitors, reducing the whole pipeline to a single matrix multiplication, and we'll see it right after.</p>
<h3 id="Projection-planes-in-LMS">
<a class="anchor" href="#Projection-planes-in-LMS" aria-hidden="true"><span class="octicon octicon-link"></span></a>Projection planes in LMS<a class="anchor-link" href="#Projection-planes-in-LMS"> </a>
</h3>
<p>Now that we are in a color space that better matches the human physiology, the question becomes how to transform the LMS coordinates to simulate what a color blind person perceives. As discussed in the FIXME: introduction, we want all the colors along the confusion lines to project to the same one, so that a dichromat won't see a difference in the transformed image, but a trichromat will see how much of the color information is lost by the dichromat.</p>
<p>As <a class="citation" href="#jim_ixora_2021">(Jim &amp; Ixora, 2021)</a> points out, a first idea is to just set the deficient axis to 0. But that won't work for several reasons:</p>
<p>1) The new point with L=0, S=0 or M=0 is likely to be outside of the sRGB gamut (the parallelepiped we visualized before in LMS), so most of these transformed color would not be valid once transformed back to sRGB.</p>
<p>2) Experiments on unilateral dichromats (people who have one normal trichromat eye and one dichromat eye) show that they perceive some colors similarly with both eyes. Unsurprisingly among these invariant stimulus we find shades of gray (black to white). Then the similar colors for the two eyes are observed along the 475nm (blue-greenish) and 575nm (yellow) axes for protans and deutans, and along the 485nm (cyan) and 660nm (red) axes for tritans. <a class="citation" href="#meyer_color_defective_1988">(Meyer &amp; Greenberg, 1988)</a> has solid references for some of these experiments, made in the 1950s. Intuitively it makes sense that the dichromat eye of a protan or deutan does a good job on colors that only differ by the amount of blue (S cone). Indeed in LMS going from black to blue or white to yellow is just a change in the S coordinate.</p>
<p>Based on that that data it is possible to design a projection that respect these constraints. <a class="citation" href="#brettel_computerized_1997">(Brettel &amp; Mollon, 1997)</a> proposed the first modern algorithm to compute that. It consists in creating two half-planes around the Black-White diagonal. For protanopes and deuteranopes the wings go through the LMS coordinates of the 475nm and 575nm wavelengths, and for tritanopes towards the coordinates of the 485nm and 660nm wavelenghts. By construction colors that lie on these invariant axes are thus preserved.</p>
<p>While black just has a (0,0,0) coordinate in LMS, "white" needs a more careful definition. In <a class="citation" href="#brettel_computerized_1997">(Brettel &amp; Mollon, 1997)</a> they take the white point of the equal-energy illuminant as the neutral axis. That illuminant (called <code>E</code> in <a href="https://en.wikipedia.org/wiki/Standard_illuminant#Illuminant_E">CIE XYZ terminology</a>) has the same amount of energy on all the visible light wavelenghts, so it presents a perfectly even color. It differs a bit from the "white" of a sRGB monitor which is the white point of the <a href="https://en.wikipedia.org/wiki/Illuminant_D65">D65 illuminant</a>, which roughly corresponds to the stimulus we'd perceive as white under average outdoor daylight. So to stay close to the best theoretical value we'll start by considering Black to E as the neutral axis that dichromats perceive similarly as trichromats.</p>
<p>Let's first visualize how these planes look like in 3D for protans/deutans (they share the same plane) and for tritans. Note that the colors corresponding to pure 475nm, 485nm, 575nm and 660nm cannot be represented on a sRGB monitor, so I use their closest approximation in the plot by desaturating them (adding "white" to them until they fit in the gamut).</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">lms_model</span> <span class="o">=</span> <span class="n">convert</span><span class="o">.</span><span class="n">LMSModel_sRGB_SmithPokorny75</span><span class="p">()</span>
<span class="c1"># lms_model = convert.LMSModel_Vienot1999_SmithPokorny75()</span>
<span class="c1"># lms_model = convert.LMSModel_sRGB_StockmanSharpe2000()</span>

<span class="kn">import</span> <span class="nn">colour</span> <span class="c1"># from pip install colour-science</span>
<span class="kn">from</span> <span class="nn">colour</span> <span class="kn">import</span> <span class="n">MSDS_CMFS</span>
<span class="n">cmfs</span> <span class="o">=</span> <span class="n">MSDS_CMFS</span><span class="p">[</span><span class="s1">'CIE 1931 2 Degree Standard Observer'</span><span class="p">]</span>
<span class="n">xyz_475</span> <span class="o">=</span> <span class="n">colour</span><span class="o">.</span><span class="n">wavelength_to_XYZ</span><span class="p">(</span><span class="mi">475</span><span class="p">,</span> <span class="n">cmfs</span><span class="p">)</span>
<span class="n">xyz_575</span> <span class="o">=</span> <span class="n">colour</span><span class="o">.</span><span class="n">wavelength_to_XYZ</span><span class="p">(</span><span class="mi">575</span><span class="p">,</span> <span class="n">cmfs</span><span class="p">)</span>
<span class="n">xyz_485</span> <span class="o">=</span> <span class="n">colour</span><span class="o">.</span><span class="n">wavelength_to_XYZ</span><span class="p">(</span><span class="mi">485</span><span class="p">,</span> <span class="n">cmfs</span><span class="p">)</span>
<span class="n">xyz_660</span> <span class="o">=</span> <span class="n">colour</span><span class="o">.</span><span class="n">wavelength_to_XYZ</span><span class="p">(</span><span class="mi">660</span><span class="p">,</span> <span class="n">cmfs</span><span class="p">)</span>

<span class="c1"># From https://www.johndcook.com/wavelength_to_RGB.html</span>
<span class="c1"># Approximate since the XYZ coordinates are not actually in the RGB gamut</span>
<span class="c1"># The correspondence has to be done projecting in the direction of the</span>
<span class="c1"># whitepoint until reaching the gamut.</span>
<span class="c1"># http://www.fourmilab.ch/documents/specrend/</span>

<span class="n">lms_475</span> <span class="o">=</span> <span class="n">lms_model</span><span class="o">.</span><span class="n">LMS_from_XYZ</span> <span class="o">@</span> <span class="n">xyz_475</span>
<span class="n">lms_575</span> <span class="o">=</span> <span class="n">lms_model</span><span class="o">.</span><span class="n">LMS_from_XYZ</span> <span class="o">@</span> <span class="n">xyz_575</span>
<span class="n">lms_485</span> <span class="o">=</span> <span class="n">lms_model</span><span class="o">.</span><span class="n">LMS_from_XYZ</span> <span class="o">@</span> <span class="n">xyz_485</span>
<span class="n">lms_660</span> <span class="o">=</span> <span class="n">lms_model</span><span class="o">.</span><span class="n">LMS_from_XYZ</span> <span class="o">@</span> <span class="n">xyz_660</span>

<span class="c1"># The equal-energy white point. By construction of CIE XYZ</span>
<span class="c1"># it has X=Y=Z. The normalization does not matter to define</span>
<span class="c1"># the diagonal direction, picking 0.8 to make it close to</span>
<span class="c1"># sRGB white.</span>
<span class="n">xyz_E</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">]</span>
<span class="n">rgb_E</span> <span class="o">=</span> <span class="n">lms_model</span><span class="o">.</span><span class="n">linearRGB_from_XYZ</span> <span class="o">@</span> <span class="n">xyz_E</span>
<span class="n">srgb_E</span> <span class="o">=</span> <span class="n">convert</span><span class="o">.</span><span class="n">sRGB_from_linearRGB</span><span class="p">([</span><span class="n">rgb_E</span><span class="p">])</span>
<span class="n">lms_E</span> <span class="o">=</span> <span class="n">lms_model</span><span class="o">.</span><span class="n">LMS_from_XYZ</span> <span class="o">@</span> <span class="n">xyz_E</span>

<span class="n">rgb_wavelengths</span> <span class="o">=</span> <span class="n">convert</span><span class="o">.</span><span class="n">apply_color_matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xyz_475</span><span class="p">,</span> <span class="n">xyz_575</span><span class="p">,</span> <span class="n">xyz_485</span><span class="p">,</span> <span class="n">xyz_660</span><span class="p">]),</span> <span class="n">lms_model</span><span class="o">.</span><span class="n">linearRGB_from_XYZ</span><span class="p">)</span>
<span class="n">rgb_wavelengths</span> <span class="o">=</span> <span class="n">convert</span><span class="o">.</span><span class="n">desaturate_linearRGB_to_fit_in_gamut</span><span class="p">(</span><span class="n">rgb_wavelengths</span><span class="p">)</span>
<span class="n">srgb_wavelengths</span> <span class="o">=</span> <span class="n">convert</span><span class="o">.</span><span class="n">sRGB_from_linearRGB</span><span class="p">(</span><span class="n">rgb_wavelengths</span><span class="p">)</span>

<span class="n">rgb_475</span><span class="p">,</span> <span class="n">rgb_575</span><span class="p">,</span> <span class="n">rgb_485</span><span class="p">,</span> <span class="n">rgb_660</span> <span class="o">=</span> <span class="n">srgb_wavelengths</span>

<span class="n">rgb_gamut</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]),</span> <span class="s1">'K'</span><span class="p">,</span> <span class="s1">'black'</span><span class="p">),</span>
    <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]),</span> <span class="s1">'B'</span><span class="p">,</span> <span class="s1">'blue'</span><span class="p">),</span>
    <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]),</span> <span class="s1">'M'</span><span class="p">,</span> <span class="s1">'magenta'</span><span class="p">),</span>
    <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]),</span> <span class="s1">'R'</span><span class="p">,</span> <span class="s1">'red'</span><span class="p">),</span>    
    <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]),</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'green'</span><span class="p">),</span>
    <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]),</span> <span class="s1">'C'</span><span class="p">,</span> <span class="s1">'cyan'</span><span class="p">),</span>
    <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]),</span> <span class="s1">'W'</span><span class="p">,</span> <span class="s1">'white'</span><span class="p">),</span>    
    <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]),</span> <span class="s1">'Y'</span><span class="p">,</span> <span class="s1">'yellow'</span><span class="p">),</span>
<span class="p">]</span>

<span class="k">def</span> <span class="nf">dataframe_row</span><span class="p">(</span><span class="n">rgb</span><span class="p">,</span> <span class="n">lms</span><span class="p">,</span> <span class="n">short_name</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">int_rgb255</span> <span class="o">=</span> <span class="p">(</span><span class="n">rgb</span><span class="o">*</span><span class="mf">255.0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">name</span><span class="p">,</span> <span class="n">short_name</span><span class="p">,</span> <span class="o">*</span><span class="n">rgb</span><span class="p">,</span> <span class="o">*</span><span class="n">lms</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'#</span><span class="si">{</span><span class="n">int_rgb255</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">02x</span><span class="si">}{</span><span class="n">int_rgb255</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">02x</span><span class="si">}{</span><span class="n">int_rgb255</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s1">02x</span><span class="si">}</span><span class="s1">'</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">lms_of_key</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="p">[</span><span class="s1">'L'</span><span class="p">,</span><span class="s1">'M'</span><span class="p">,</span><span class="s1">'S'</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

<span class="c1"># RGB parallelepiped gamut in LMS</span>
<span class="n">df_rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">dataframe_row</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lms_model</span><span class="o">.</span><span class="n">LMS_from_linearRGB</span> <span class="o">@</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rgb_gamut</span><span class="p">]</span>
<span class="n">df_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataframe_row</span><span class="p">(</span><span class="n">rgb_E</span><span class="p">,</span> <span class="n">lms_E</span><span class="p">,</span> <span class="s1">'E'</span><span class="p">,</span> <span class="s1">'Equal-Energy'</span><span class="p">))</span>
<span class="n">df_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataframe_row</span><span class="p">(</span><span class="n">rgb_475</span><span class="p">,</span> <span class="n">lms_475</span><span class="p">,</span> <span class="s1">'475nm'</span><span class="p">,</span> <span class="s1">'475nm'</span><span class="p">))</span>
<span class="n">df_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataframe_row</span><span class="p">(</span><span class="n">rgb_575</span><span class="p">,</span> <span class="n">lms_575</span><span class="p">,</span> <span class="s1">'575nm'</span><span class="p">,</span> <span class="s1">'575nm'</span><span class="p">))</span>
<span class="n">df_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataframe_row</span><span class="p">(</span><span class="n">rgb_485</span><span class="p">,</span> <span class="n">lms_485</span><span class="p">,</span> <span class="s1">'485nm'</span><span class="p">,</span> <span class="s1">'485nm'</span><span class="p">))</span>
<span class="n">df_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataframe_row</span><span class="p">(</span><span class="n">rgb_660</span><span class="p">,</span> <span class="n">lms_660</span><span class="p">,</span> <span class="s1">'660nm'</span><span class="p">,</span> <span class="s1">'660nm'</span><span class="p">))</span>
<span class="n">KBMRGCWY</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df_rows</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">'name'</span><span class="p">,</span> <span class="s1">'short_name'</span><span class="p">,</span> <span class="s1">'R'</span><span class="p">,</span><span class="s1">'G'</span><span class="p">,</span><span class="s1">'B'</span><span class="p">,</span><span class="s1">'L'</span><span class="p">,</span><span class="s1">'M'</span><span class="p">,</span><span class="s1">'S'</span><span class="p">,</span><span class="s1">'colorhex'</span><span class="p">])</span>
<span class="n">KBMRGCWY</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">'short_name'</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">KBMRGCWY</span><span class="p">[</span><span class="s1">'short_name'</span><span class="p">]</span> <span class="o">=</span> <span class="n">KBMRGCWY</span><span class="o">.</span><span class="n">index</span>

<span class="n">KBMRGCWY_red_green</span> <span class="o">=</span> <span class="n">KBMRGCWY</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="c1"># drop 485 and 660nm</span>
<span class="n">KBMRGCWY_tritan</span> <span class="o">=</span> <span class="n">KBMRGCWY</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">KBMRGCWY</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="c1"># drop 475 and 575nm    </span>
   
<span class="n">figs</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">px</span><span class="o">.</span><span class="n">scatter_3d</span><span class="p">(</span><span class="n">KBMRGCWY_red_green</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">'L'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">'M'</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="s1">'S'</span><span class="p">,</span> 
                  <span class="n">color</span><span class="o">=</span><span class="s1">'colorhex'</span><span class="p">,</span> <span class="n">color_discrete_map</span><span class="o">=</span><span class="s1">'identity'</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s1">'short_name'</span><span class="p">,</span>
                  <span class="n">width</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span> 
                  <span class="n">title</span><span class="o">=</span><span class="s1">'Protan and Deutan Projection Half-Planes according to (Brettel &amp; Mollon, 1997)'</span><span class="p">),</span>
    
    <span class="n">px</span><span class="o">.</span><span class="n">scatter_3d</span><span class="p">(</span><span class="n">KBMRGCWY_tritan</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">'L'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">'M'</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="s1">'S'</span><span class="p">,</span> 
                  <span class="n">color</span><span class="o">=</span><span class="s1">'colorhex'</span><span class="p">,</span> <span class="n">color_discrete_map</span><span class="o">=</span><span class="s1">'identity'</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s1">'short_name'</span><span class="p">,</span>
                  <span class="n">width</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
                  <span class="n">title</span><span class="o">=</span><span class="s1">'Tritan Projection Half-Planes according to (Brettel &amp; Mollon, 1997)'</span><span class="p">)</span>
<span class="p">]</span>
    

<span class="c1"># Add the parallelepiped lines</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">KBMRGCWY</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="s1">'K'</span><span class="p">,</span><span class="s1">'B'</span><span class="p">,</span><span class="s1">'M'</span><span class="p">,</span><span class="s1">'R'</span><span class="p">,</span> <span class="s1">'K'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'Y'</span><span class="p">,</span> <span class="s1">'W'</span><span class="p">,</span> <span class="s1">'C'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'Y'</span><span class="p">,</span> <span class="s1">'R'</span><span class="p">,</span> <span class="s1">'M'</span><span class="p">,</span> <span class="s1">'W'</span><span class="p">,</span> <span class="s1">'C'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">]]</span>
<span class="k">for</span> <span class="n">fig</span> <span class="ow">in</span> <span class="n">figs</span><span class="p">:</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_scatter3d</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'L'</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'M'</span><span class="p">],</span> <span class="n">z</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'S'</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">'lines'</span><span class="p">,</span> <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Add the black-E diagonal, dashed</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">KBMRGCWY</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="s1">'K'</span><span class="p">,</span><span class="s1">'E'</span><span class="p">]]</span>
<span class="k">for</span> <span class="n">fig</span> <span class="ow">in</span> <span class="n">figs</span><span class="p">:</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_scatter3d</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'L'</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'M'</span><span class="p">],</span> <span class="n">z</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'S'</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">'lines'</span><span class="p">,</span> <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">dash</span><span class="o">=</span><span class="s1">'dash'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">),</span> <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">add_half_plane</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">wavelength_key</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">U_norm</span><span class="p">,</span> <span class="n">V_norm</span><span class="p">,</span> <span class="n">delaunayaxis</span><span class="o">=</span><span class="s1">'x'</span><span class="p">):</span>
    <span class="c1"># The plane is defined by two vectors starting from the origin</span>
    <span class="c1"># U is the black-white diagonal, and V is </span>
    <span class="n">U</span> <span class="o">=</span>  <span class="n">lms_of_key</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">'E'</span><span class="p">)</span> <span class="o">-</span> <span class="n">lms_of_key</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">'K'</span><span class="p">)</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">U_norm</span> <span class="o">*</span> <span class="p">(</span><span class="n">U</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">U</span><span class="p">))</span>
    <span class="n">V</span> <span class="o">=</span>  <span class="n">lms_of_key</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">wavelength_key</span><span class="p">)</span> <span class="o">-</span> <span class="n">lms_of_key</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">'K'</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">U</span><span class="p">,</span><span class="n">V</span><span class="p">)</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">U</span><span class="p">)</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">V_norm</span> <span class="o">*</span> <span class="p">(</span><span class="n">V</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">V</span><span class="p">))</span>
    <span class="n">u</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">50</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">50</span><span class="n">j</span><span class="p">]</span>
    <span class="n">xyz</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">*</span><span class="n">U</span> <span class="o">+</span> <span class="n">v</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">*</span><span class="n">V</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">xyz</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">xyz</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">xyz</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">surfacecolor</span> <span class="o">=</span> <span class="n">convert</span><span class="o">.</span><span class="n">apply_color_matrix</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">lms_model</span><span class="o">.</span><span class="n">linearRGB_from_LMS</span><span class="p">)</span>
    <span class="n">surfacecolor</span> <span class="o">=</span> <span class="n">convert</span><span class="o">.</span><span class="n">desaturate_linearRGB_to_fit_in_gamut</span><span class="p">(</span><span class="n">surfacecolor</span><span class="p">)</span>
    <span class="n">surfacecolor</span> <span class="o">=</span> <span class="n">surfacecolor</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
    <span class="c1">#display(surfacecolor)</span>
    <span class="n">surfacecolor</span> <span class="o">=</span> <span class="n">convert</span><span class="o">.</span><span class="n">sRGB_from_linearRGB</span><span class="p">(</span><span class="n">surfacecolor</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_mesh3d</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">delaunayaxis</span><span class="o">=</span><span class="n">delaunayaxis</span><span class="p">,</span> <span class="n">alphahull</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vertexcolor</span><span class="o">=</span><span class="n">surfacecolor</span><span class="p">,</span> 
                   <span class="n">lighting</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">ambient</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">specular</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="n">diffuse</span><span class="o">=</span><span class="mf">0.0</span><span class="p">),</span> 
                   <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
<span class="n">df</span> <span class="o">=</span> <span class="n">KBMRGCWY_red_green</span>
<span class="n">add_half_plane</span><span class="p">(</span><span class="n">figs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">df</span><span class="p">,</span> <span class="s1">'475nm'</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">lms_of_key</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">'E'</span><span class="p">))</span><span class="o">*</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">lms_of_key</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span>
<span class="n">add_half_plane</span><span class="p">(</span><span class="n">figs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">df</span><span class="p">,</span> <span class="s1">'575nm'</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">lms_of_key</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">'E'</span><span class="p">))</span><span class="o">*</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">lms_of_key</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">KBMRGCWY_tritan</span>
<span class="n">add_half_plane</span><span class="p">(</span><span class="n">figs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">df</span><span class="p">,</span> <span class="s1">'485nm'</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">lms_of_key</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">'E'</span><span class="p">))</span><span class="o">*</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">lms_of_key</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">))</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="s1">'y'</span><span class="p">)</span>
<span class="n">add_half_plane</span><span class="p">(</span><span class="n">figs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">df</span><span class="p">,</span> <span class="s1">'660nm'</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">lms_of_key</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">'E'</span><span class="p">))</span><span class="o">*</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">lms_of_key</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">'R'</span><span class="p">))</span><span class="o">*</span><span class="mf">0.5</span><span class="p">,</span> <span class="s1">'y'</span><span class="p">)</span>

<span class="n">camera</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">up</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">center</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
    <span class="n">eye</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=-</span><span class="mf">1.75</span><span class="p">,</span> <span class="n">y</span><span class="o">=-</span><span class="mf">1.75</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mf">0.75</span><span class="p">),</span>
<span class="p">)</span>
<span class="k">for</span> <span class="n">fig</span> <span class="ow">in</span> <span class="n">figs</span><span class="p">:</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">scene_camera</span><span class="o">=</span><span class="n">camera</span><span class="p">,</span> <span class="n">dragmode</span><span class="o">=</span><span class="s1">'orbit'</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>If the model were perfect then these planes would show the entire set of colors that can be perceived by a dichromat. The idea of <a class="citation" href="#brettel_computerized_1997">(Brettel &amp; Mollon, 1997)</a> is then to project every LMS color into these planes along the dichromat missing axis, picking the closest of the 2 planes. But from these 3d plots we observe two things:</p>
<ul>
<li>
<p>For protans and deutans the two wings are almost co-planar, and the plane is very close to passing through the white, blue and yellow limits of the sRGB parallelepiped. So <a class="citation" href="#vienot_digital_1999">(Viénot, Brettel, &amp; Mollon, 1999)</a> proposed to simplify the algorithm by using a single diagonal plane black-white-blue-yellow. As we'll see next this makes it possible to include the projection as a single 3x3 matrix and keep a fully linear pipeline.</p>
</li>
<li>
<p><a class="citation" href="#vienot_digital_1999">(Viénot, Brettel, &amp; Mollon, 1999)</a> did not address the tritanope case though, and we can see that such an approximation would not be as good. Several opensource implementations of the paper just use the same black-white-blue-yellow diagonal plane as the protan/deutan one, which is completely wrong, as <a class="citation" href="#jim_ixora_2021">(Jim &amp; Ixora, 2021)</a> mentions. A better single plane approximation would be black-white-red-cyan, but it's still a rough approximation and unclear how accurate this is as evaluation studies are rare for tritanopes.</p>
</li>
</ul>
<p>Let's visualize how the Viénot simplication looks like and derive their full algorithm.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="The-simplification-of-(Viénot,-Brettel-and-Mollon-1999)-for-protanopes-and-deuteranopes">
<a class="anchor" href="#The-simplification-of-(Vi%C3%A9not,-Brettel-and-Mollon-1999)-for-protanopes-and-deuteranopes" aria-hidden="true"><span class="octicon octicon-link"></span></a>The simplification of (Viénot, Brettel and Mollon 1999) for protanopes and deuteranopes<a class="anchor-link" href="#The-simplification-of-(Vi%C3%A9not,-Brettel-and-Mollon-1999)-for-protanopes-and-deuteranopes"> </a>
</h3>
<p>In <a class="citation" href="#vienot_digital_1999">(Viénot, Brettel, &amp; Mollon, 1999)</a> a single plane black-white-blue-yellow is created and all the colors will get projected onto it. Let's visualize that plane in 3D.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># RGB parallelepiped gamut in LMS</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">scatter_3d</span><span class="p">(</span><span class="n">KBMRGCWY</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">'K'</span><span class="p">:</span><span class="s1">'Y'</span><span class="p">],</span> <span class="n">x</span><span class="o">=</span><span class="s1">'L'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">'M'</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="s1">'S'</span><span class="p">,</span> 
                  <span class="n">color</span><span class="o">=</span><span class="s1">'colorhex'</span><span class="p">,</span> <span class="n">color_discrete_map</span><span class="o">=</span><span class="s1">'identity'</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s1">'short_name'</span><span class="p">,</span>
                  <span class="n">width</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span> 
                  <span class="n">title</span><span class="o">=</span><span class="s1">'Protan and Deutan Projection Plane according to (Viénot &amp; Brettel &amp; Mollon, 1999)'</span><span class="p">)</span>

<span class="c1"># Add the parallelepiped lines</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">KBMRGCWY</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="s1">'K'</span><span class="p">,</span><span class="s1">'B'</span><span class="p">,</span><span class="s1">'M'</span><span class="p">,</span><span class="s1">'R'</span><span class="p">,</span> <span class="s1">'K'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'Y'</span><span class="p">,</span> <span class="s1">'W'</span><span class="p">,</span> <span class="s1">'C'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'Y'</span><span class="p">,</span> <span class="s1">'R'</span><span class="p">,</span> <span class="s1">'M'</span><span class="p">,</span> <span class="s1">'W'</span><span class="p">,</span> <span class="s1">'C'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">]]</span>
<span class="n">fig</span><span class="o">.</span><span class="n">add_scatter3d</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'L'</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'M'</span><span class="p">],</span> <span class="n">z</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'S'</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">'lines'</span><span class="p">,</span> <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Add the black-white diagonal, dashed</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">KBMRGCWY</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="s1">'K'</span><span class="p">,</span><span class="s1">'W'</span><span class="p">]]</span>
<span class="n">fig</span><span class="o">.</span><span class="n">add_scatter3d</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'L'</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'M'</span><span class="p">],</span> <span class="n">z</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'S'</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">'lines'</span><span class="p">,</span> <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">dash</span><span class="o">=</span><span class="s1">'dash'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">),</span> <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">add_black_white_yellow_blue_plane</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
    <span class="c1"># The plane is defined by two vectors starting from the origin</span>
    <span class="c1"># U is the black-white diagonal, and V is </span>
    <span class="n">U</span> <span class="o">=</span>  <span class="n">lms_of_key</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">'Y'</span><span class="p">)</span> <span class="o">-</span> <span class="n">lms_of_key</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">'K'</span><span class="p">)</span>
    <span class="n">V</span> <span class="o">=</span>  <span class="n">lms_of_key</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">)</span> <span class="o">-</span> <span class="n">lms_of_key</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">'K'</span><span class="p">)</span>
    <span class="n">u</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">50</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">50</span><span class="n">j</span><span class="p">]</span>
    <span class="n">xyz</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">*</span><span class="n">U</span> <span class="o">+</span> <span class="n">v</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">*</span><span class="n">V</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">xyz</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">xyz</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">xyz</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">surfacecolor</span> <span class="o">=</span> <span class="n">convert</span><span class="o">.</span><span class="n">apply_color_matrix</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">lms_model</span><span class="o">.</span><span class="n">linearRGB_from_LMS</span><span class="p">)</span>
    <span class="n">surfacecolor</span> <span class="o">=</span> <span class="n">convert</span><span class="o">.</span><span class="n">desaturate_linearRGB_to_fit_in_gamut</span><span class="p">(</span><span class="n">surfacecolor</span><span class="p">)</span>
    <span class="n">surfacecolor</span> <span class="o">=</span> <span class="n">surfacecolor</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">surfacecolor</span> <span class="o">=</span> <span class="n">convert</span><span class="o">.</span><span class="n">sRGB_from_linearRGB</span><span class="p">(</span><span class="n">surfacecolor</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_mesh3d</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">delaunayaxis</span><span class="o">=</span><span class="s1">'x'</span><span class="p">,</span> <span class="n">alphahull</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vertexcolor</span><span class="o">=</span><span class="n">surfacecolor</span><span class="p">,</span> 
                   <span class="n">lighting</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">ambient</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">specular</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="n">diffuse</span><span class="o">=</span><span class="mf">0.0</span><span class="p">),</span> 
                   <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">KBMRGCWY</span>
<span class="n">add_black_white_yellow_blue_plane</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>

<span class="n">camera</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">up</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">center</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
    <span class="n">eye</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="o">=-</span><span class="mf">1.75</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mf">0.75</span><span class="p">),</span>
<span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">scene_camera</span><span class="o">=</span><span class="n">camera</span><span class="p">,</span> <span class="n">dragmode</span><span class="o">=</span><span class="s1">'orbit'</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This plane represents all the colors that can be output by the simulation algorithm. If the theory is right, protans and deutans dichromats can always find a color on that plane that they perceive as similary to any color of the full gamut. Now let's do the math to actually compute the projection of any color into that plane and get the final pipeline.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Plane-projection-as-a-3x3-matrix">
<a class="anchor" href="#Plane-projection-as-a-3x3-matrix" aria-hidden="true"><span class="octicon octicon-link"></span></a>Plane projection as a 3x3 matrix<a class="anchor-link" href="#Plane-projection-as-a-3x3-matrix"> </a>
</h4>
<p>Let $p = (p_l, p_m, p_s)$ be the LMS color to transform, and $n$ the normal of the plane. Our planes always go through the origin <code>K=(0,0,0)</code>(black), so the plane equations are just given by their normal $n = (n_l, n_m, n_s)$ as $n.p = n_l.p_l + n_m.p_m + n_s.p_s = 0$. Let's call $p' = (p_l', p_m', p_s')$ the transformed point, projected on the plane. Since only the coordinate along the dichromacy axis changes, we just need to compute the missing axis coordinate and keep the other two unchanged. For example for a protan, we have $p_m' = p_m$ and $p_s' = p_s$, and plugging them into the plane equation we can calculate $p_l'$:</p>
$$
n_l . p_l' + n_m . p_m' + n_s . p_s' = 0 \\
p_l'  = -\frac{n_m}{n_l} . p_m - \frac{n_s}{n_l} . p_s
$$<p>So we just need the normal of the plane, which is given by the cross-product of two vectors on the plane. Here are the normal of the protan/deutan black-white-blue-yellow plane and the resulting $-\frac{n_m}{n_l}$ and $- \frac{n_s}{n_l}$ factors for a protan:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">v_blue</span> <span class="o">=</span> <span class="n">lms_of_key</span><span class="p">(</span><span class="n">KBMRGCWY</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">)</span> <span class="c1"># - K which is ommitted since it's zero</span>
<span class="n">v_yellow</span> <span class="o">=</span> <span class="n">lms_of_key</span><span class="p">(</span><span class="n">KBMRGCWY</span><span class="p">,</span> <span class="s1">'Y'</span><span class="p">)</span>  <span class="c1"># - K which is ommitted since it's zero</span>
<span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">v_yellow</span><span class="p">,</span> <span class="n">v_blue</span><span class="p">)</span>
<span class="nb">print</span> <span class="p">(</span><span class="s1">'Normal (protan &amp; deutan) = '</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

<span class="nb">print</span> <span class="p">(</span><span class="s1">'n_m / n_l = '</span><span class="p">,</span> <span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span> <span class="p">(</span><span class="s1">'n_s / n_l = '</span><span class="p">,</span> <span class="n">n</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>These factors can be put into a matrix $H$ so that $p' = H . p$:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">H_protan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
    <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="o">-</span><span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="n">n</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> 
<span class="p">])</span>

<span class="nb">print</span><span class="p">()</span>
<span class="n">printMatrix</span><span class="p">(</span><span class="s1">'Projection matrix for protan'</span><span class="p">,</span> <span class="n">H_protan</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Similarly we can get the deutan projection matrix, with $p_l' = p_l$, $p_s' = p_s$ and $p_m' = -\frac{n_l}{n_m} . p_l - \frac{n_s}{n_m} . p_s$ this time:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">H_deutan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
    <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="o">-</span><span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">n</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> 
<span class="p">])</span>

<span class="nb">print</span><span class="p">()</span>
<span class="n">printMatrix</span><span class="p">(</span><span class="s1">'Projection matrix for deutan'</span><span class="p">,</span> <span class="n">H_deutan</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p></p>
<div class="flash">
    <svg class="octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z"></path></svg>
    <strong>Note: </strong>these matrices don’t exactly match the Viénot 1999 paper because we used the sRGB version of the model (<code>convert.LMSModel_sRGB_SmithPokorny75</code>). They would match if we used <code>lms_model = LMSModel_Vienot1999_SmithPokorny75</code> instead at the beginning of the code section.
</div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Putting-it-together">
<a class="anchor" href="#Putting-it-together" aria-hidden="true"><span class="octicon octicon-link"></span></a>Putting it together<a class="anchor-link" href="#Putting-it-together"> </a>
</h4>
<p>Since the projection is just a 3x3 linear matrix, we can combine all the matrices to transform a linear RGB point into its dichromat counterpart and then go back to linear RGB. We also need to add the non-linear from/to conversion between sRGB and linearRGB to get the final Viénot 1999 pipeline:</p>
<p><code>srgb_protan = sRGB_from_linearRGB(linearRGB_from_LMS . H_protan . LMS_from_linearRGB . linearRGB_from_sRGB(srgb))</code></p>
<p><code>srgb_deutan = sRGB_from_linearRGB(linearRGB_from_LMS . H_deutan . LMS_from_linearRGB . linearRGB_from_sRGB(srgb))</code></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We are almost done, we just need to deal with a last hiccup. Some LMS coordinates of the sRGB gamut might fall outside of the parallelepiped once projected onto the plane. For example if we apply the pipeline to the pure green color <code>[0,1,0]</code> we get:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">green_protan</span> <span class="o">=</span> <span class="n">lms_model</span><span class="o">.</span><span class="n">linearRGB_from_LMS</span> <span class="o">@</span> <span class="n">H_protan</span> <span class="o">@</span> <span class="n">lms_model</span><span class="o">.</span><span class="n">LMS_from_linearRGB</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
<span class="n">green_protan</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The blue coordinate becomes negative because green falls slighly outside of the parallelepiped once projected along the L axis onto the black-white-blue-yellow plane. Here the error is very small so it's ok to just clip the final values to [0,1]. This is the approach taken by <a class="citation" href="#simon_liedtke_using_2016">(Simon-Liedtke &amp; Farup, 2016)</a>.</p>
<p>Another way if we use models where we can have larger errors is to desaturate the color by adding a white component until all the coordinates become positive. This is what we did for the <code>rgb_475</code>, <code>rgb_575</code>, <code>rgb_485</code> and <code>rgb_660</code> visualization of the wavelengths. Just clipping was totally wrong for those as some had large negative values. See <a href="https://www.fourmilab.ch/documents/specrend/">this page of the fourmilab</a> for more details, it's implemented as <code>convert.desaturate_linearRGB_to_fit_in_gamut</code> in DaltonLens.</p>
<p>Now it's time to see what kind of results we can get!</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">simulate_dichromacy_vienot</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">projection_matrix</span><span class="p">):</span>
    <span class="n">color_mat</span> <span class="o">=</span> <span class="n">lms_model</span><span class="o">.</span><span class="n">linearRGB_from_LMS</span> <span class="o">@</span> <span class="n">projection_matrix</span> <span class="o">@</span> <span class="n">lms_model</span><span class="o">.</span><span class="n">LMS_from_linearRGB</span>
    <span class="n">im_linear_rgb</span> <span class="o">=</span> <span class="n">convert</span><span class="o">.</span><span class="n">linearRGB_from_sRGB</span><span class="p">(</span><span class="n">convert</span><span class="o">.</span><span class="n">as_float32</span><span class="p">(</span><span class="n">im</span><span class="p">))</span>
    <span class="n">im_protan_linear_rgb</span> <span class="o">=</span> <span class="n">convert</span><span class="o">.</span><span class="n">apply_color_matrix</span><span class="p">(</span><span class="n">im_linear_rgb</span><span class="p">,</span> <span class="n">color_mat</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">convert</span><span class="o">.</span><span class="n">as_uint8</span><span class="p">(</span><span class="n">convert</span><span class="o">.</span><span class="n">sRGB_from_linearRGB</span><span class="p">(</span><span class="n">im_protan_linear_rgb</span><span class="p">))</span>

<span class="kn">import</span> <span class="nn">urllib.request</span>
<span class="kn">import</span> <span class="nn">cv2</span>

<span class="n">pngdata</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="s1">'https://upload.wikimedia.org/wikipedia/commons/d/d7/Byrcolorwheel.png'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="c1"># pngdata = urllib.request.urlopen('http://www.vischeck.com/images//poppies.jpg').read()</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imdecode</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">pngdata</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_COLOR</span><span class="p">)</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span> <span class="c1"># OpenCV flips the channels by default.</span>

<span class="n">im_protan</span> <span class="o">=</span> <span class="n">simulate_dichromacy_vienot</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">H_protan</span><span class="p">)</span>
<span class="n">im_deutan</span> <span class="o">=</span> <span class="n">simulate_dichromacy_vienot</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">H_deutan</span><span class="p">)</span>
<span class="n">im_original</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">im_original</span><span class="p">,</span> <span class="s1">'Original'</span><span class="p">,</span>        <span class="p">(</span><span class="mi">157</span><span class="p">,</span><span class="mi">190</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_COMPLEX</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="p">(</span><span class="mi">64</span><span class="p">,</span><span class="mi">64</span><span class="p">,</span><span class="mi">64</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">LINE_AA</span><span class="p">)</span>
<span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">im_protan</span><span class="p">,</span>   <span class="s1">'Protan (Vienot)'</span><span class="p">,</span> <span class="p">(</span><span class="mi">125</span><span class="p">,</span><span class="mi">190</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_COMPLEX</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="p">(</span><span class="mi">64</span><span class="p">,</span><span class="mi">64</span><span class="p">,</span><span class="mi">64</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">LINE_AA</span><span class="p">)</span>
<span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">im_deutan</span><span class="p">,</span>   <span class="s1">'Deutan (Vienot)'</span><span class="p">,</span> <span class="p">(</span><span class="mi">125</span><span class="p">,</span><span class="mi">190</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_COMPLEX</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="p">(</span><span class="mi">64</span><span class="p">,</span><span class="mi">64</span><span class="p">,</span><span class="mi">64</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">LINE_AA</span><span class="p">)</span>
<span class="n">px</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">im_original</span><span class="p">,</span> <span class="n">im_protan</span><span class="p">,</span> <span class="n">im_deutan</span><span class="p">]))</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="What-about-tritanopes?">
<a class="anchor" href="#What-about-tritanopes?" aria-hidden="true"><span class="octicon octicon-link"></span></a>What about tritanopes?<a class="anchor-link" href="#What-about-tritanopes?"> </a>
</h4>
<p>If we want a one-plane solution for tritanopes we can use the same method but using the black-white-red-cyan plane instead of the black-white-blue-yellow plane we used for protanopes and deuteranopes. As we observed before it's not a very nice fit, but let's try it anyway and we'll compare that with the Bretell method next.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">v_red</span> <span class="o">=</span> <span class="n">lms_of_key</span><span class="p">(</span><span class="n">KBMRGCWY</span><span class="p">,</span> <span class="s1">'R'</span><span class="p">)</span> <span class="c1"># - K which is ommitted since it's zero</span>
<span class="n">v_cyan</span> <span class="o">=</span> <span class="n">lms_of_key</span><span class="p">(</span><span class="n">KBMRGCWY</span><span class="p">,</span> <span class="s1">'C'</span><span class="p">)</span>  <span class="c1"># - K which is ommitted since it's zero</span>
<span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">v_cyan</span><span class="p">,</span> <span class="n">v_red</span><span class="p">)</span>
<span class="nb">print</span> <span class="p">(</span><span class="s1">'Normal (tritan) = '</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

<span class="n">H_tritan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
    <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="o">-</span><span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">n</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">-</span><span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">n</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">],</span>
<span class="p">])</span>

<span class="nb">print</span><span class="p">()</span>
<span class="n">printMatrix</span><span class="p">(</span><span class="s1">'Projection matrix for tritan'</span><span class="p">,</span> <span class="n">H_tritan</span><span class="p">)</span>

<span class="n">im_tritan</span> <span class="o">=</span> <span class="n">simulate_dichromacy_vienot</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">H_tritan</span><span class="p">)</span>
<span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">im_tritan</span><span class="p">,</span>   <span class="s1">'Tritan (Vienot)'</span><span class="p">,</span> <span class="p">(</span><span class="mi">125</span><span class="p">,</span><span class="mi">190</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_COMPLEX</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="p">(</span><span class="mi">64</span><span class="p">,</span><span class="mi">64</span><span class="p">,</span><span class="mi">64</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">LINE_AA</span><span class="p">)</span>
<span class="n">px</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">im_original</span><span class="p">,</span> <span class="n">im_tritan</span><span class="p">]))</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Comparing-Viénot-1999-and-Brettel-1997">
<a class="anchor" href="#Comparing-Vi%C3%A9not-1999-and-Brettel-1997" aria-hidden="true"><span class="octicon octicon-link"></span></a>Comparing Viénot 1999 and Brettel 1997<a class="anchor-link" href="#Comparing-Vi%C3%A9not-1999-and-Brettel-1997"> </a>
</h2>
<p>Let's implement <a class="citation" href="#brettel_computerized_1997">(Brettel &amp; Mollon, 1997)</a> so we can compare and see whether the extra complexity is worth it. The implementation is very similar to the Viénot approach, but instead of projecting on just one plane we have to project to one of the 2 planes. The plane on which to project depends of the LMS color. The paper directly gives a simple criteria to decide, but it was not so obvious to me so I re-did the math.</p>
<p>Let's take the example of tritanopia to reason about this:</p>
<ul>
<li>
<p>If the LMS color is on the "same side" as the 485nm point then we should project on that half-plane, otherwise on the 660nm half-plane.</p>
</li>
<li>
<p>The separation is determined by the diagonal $K-E$</p>
</li>
<li>
<p>The projection is along the S axis, so we need to determine if the point is on the same side of the plane oriented along the S axis that goes through the K-E diagonal (black-equal energy). A third point on that plane is for example $K+(0,0,1) = (0,0,1)$ since $K$ is the origin.</p>
</li>
<li>
<p>Now to determine the side of any point $P = (P_l,P_m,P_s)$ w.r.t to a plane, we can check the sign of the dot-product of a vector going from the plane to the point with the plane normal.</p>
</li>
<li>
<p>The plane normal is given by the cross-product of two vectors on the plane: $$n = (E-K) \times ((0,0,1)-K) = E \times (0,0,1) = (E_m,-E_l,0)$$</p>
</li>
<li>
<p>So the dot product becomes: $P . n = P_l.E_m - P_m.E_l$. And this is positive if $P_l.E_m &gt; P_m.E_l$. The Brettel paper gives the equivalent condition $\frac{P_l}{P_m} &gt; \frac{E_l}{E_m}$ since all the quantities are positive.</p>
</li>
</ul>
<p>The extra matrix multiplication is not really significant with the processing power we have in 2021, but it never hurts to keep things simpler. Let's start with the tritanopes for once since those are the most likely to have a significant difference. We first need to compute the 2 projection planes.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">v_E</span> <span class="o">=</span> <span class="n">lms_of_key</span><span class="p">(</span><span class="n">KBMRGCWY</span><span class="p">,</span> <span class="s1">'E'</span><span class="p">)</span> <span class="c1"># - K which is ommitted since it's zero</span>
<span class="n">v_485</span> <span class="o">=</span> <span class="n">lms_of_key</span><span class="p">(</span><span class="n">KBMRGCWY</span><span class="p">,</span> <span class="s1">'485nm'</span><span class="p">)</span> <span class="c1"># - K which is ommitted since it's zero</span>
<span class="n">v_660</span> <span class="o">=</span> <span class="n">lms_of_key</span><span class="p">(</span><span class="n">KBMRGCWY</span><span class="p">,</span> <span class="s1">'660nm'</span><span class="p">)</span>  <span class="c1"># - K which is ommitted since it's zero</span>
<span class="n">n1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">v_E</span><span class="p">,</span> <span class="n">v_485</span><span class="p">)</span> <span class="c1"># first plane</span>
<span class="n">n2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">v_E</span><span class="p">,</span> <span class="n">v_660</span><span class="p">)</span> <span class="c1"># second plane</span>

<span class="n">H_tritans_brettel</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="n">n1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">n1</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">-</span><span class="n">n1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">n1</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">]]),</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="n">n2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">n2</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">-</span><span class="n">n2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">n2</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">]])</span>
<span class="p">]</span>

<span class="nb">print</span><span class="p">()</span>
<span class="n">printMatrix</span><span class="p">(</span><span class="s1">'Projection matrix for tritan (485nm)'</span><span class="p">,</span> <span class="n">H_tritans_brettel</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="nb">print</span><span class="p">()</span>
<span class="n">printMatrix</span><span class="p">(</span><span class="s1">'Projection matrix for tritan (660nm)'</span><span class="p">,</span> <span class="n">H_tritans_brettel</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now we can create the simulation function:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">projection_matrix</span><span class="p">(</span><span class="n">plane_normal</span><span class="p">,</span> <span class="n">anomaly</span><span class="p">:</span> <span class="n">simulate</span><span class="o">.</span><span class="n">Deficiency</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">plane_normal</span>
    <span class="k">if</span> <span class="n">anomaly</span> <span class="o">==</span> <span class="n">simulate</span><span class="o">.</span><span class="n">Deficiency</span><span class="o">.</span><span class="n">PROTAN</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="o">-</span><span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="n">n</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> 
        <span class="p">])</span>
    <span class="k">if</span> <span class="n">anomaly</span> <span class="o">==</span> <span class="n">simulate</span><span class="o">.</span><span class="n">Deficiency</span><span class="o">.</span><span class="n">DEUTAN</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="o">-</span><span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">n</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> 
        <span class="p">])</span>
    <span class="k">if</span> <span class="n">anomaly</span> <span class="o">==</span> <span class="n">simulate</span><span class="o">.</span><span class="n">Deficiency</span><span class="o">.</span><span class="n">TRITAN</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="o">-</span><span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">n</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">-</span><span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">n</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span>
        <span class="p">])</span>
    <span class="k">return</span> <span class="kc">None</span>

<span class="k">def</span> <span class="nf">simulate_dichromacy_brettel</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">lms_E</span><span class="p">,</span> <span class="n">lms_on_wing1</span><span class="p">,</span> <span class="n">lms_on_wing2</span><span class="p">,</span> <span class="n">anomaly</span><span class="p">:</span> <span class="n">simulate</span><span class="o">.</span><span class="n">Deficiency</span><span class="p">):</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">lms_E</span><span class="p">,</span> <span class="n">lms_on_wing1</span><span class="p">)</span> <span class="c1"># first plane</span>
    <span class="n">n2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">lms_E</span><span class="p">,</span> <span class="n">lms_on_wing2</span><span class="p">)</span> <span class="c1"># second plane</span>
    <span class="n">n_sep_plane</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">lms_E</span><span class="p">,</span> <span class="n">simulate</span><span class="o">.</span><span class="n">lms_confusion_axis</span><span class="p">(</span><span class="n">anomaly</span><span class="p">))</span> <span class="c1"># separation plane going through the diagonal</span>
    <span class="c1"># Swap the input so that wing1 is on the positive side of the separation plane</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">n_sep_plane</span><span class="p">,</span> <span class="n">lms_on_wing1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span> <span class="o">=</span> <span class="n">n2</span><span class="p">,</span> <span class="n">n1</span>
        <span class="n">lms_on_wing1</span><span class="p">,</span> <span class="n">lms_on_wing2</span> <span class="o">=</span> <span class="n">lms_on_wing2</span><span class="p">,</span> <span class="n">lms_on_wing1</span>
    
    <span class="n">H1</span> <span class="o">=</span> <span class="n">projection_matrix</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">anomaly</span><span class="p">)</span>
    <span class="n">H2</span> <span class="o">=</span> <span class="n">projection_matrix</span><span class="p">(</span><span class="n">n2</span><span class="p">,</span> <span class="n">anomaly</span><span class="p">)</span>
    
    <span class="n">im_linear_rgb</span> <span class="o">=</span> <span class="n">convert</span><span class="o">.</span><span class="n">linearRGB_from_sRGB</span><span class="p">(</span><span class="n">convert</span><span class="o">.</span><span class="n">as_float32</span><span class="p">(</span><span class="n">im</span><span class="p">))</span>
    <span class="n">im_lms</span> <span class="o">=</span> <span class="n">convert</span><span class="o">.</span><span class="n">apply_color_matrix</span><span class="p">(</span><span class="n">im_linear_rgb</span><span class="p">,</span> <span class="n">lms_model</span><span class="o">.</span><span class="n">LMS_from_linearRGB</span><span class="p">)</span>
    <span class="n">im_H1</span> <span class="o">=</span> <span class="n">convert</span><span class="o">.</span><span class="n">apply_color_matrix</span><span class="p">(</span><span class="n">im_lms</span><span class="p">,</span> <span class="n">H1</span><span class="p">)</span>
    <span class="n">im_H2</span> <span class="o">=</span> <span class="n">convert</span><span class="o">.</span><span class="n">apply_color_matrix</span><span class="p">(</span><span class="n">im_lms</span><span class="p">,</span> <span class="n">H2</span><span class="p">)</span>
    <span class="n">H2_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">im_lms</span><span class="p">,</span> <span class="n">n_sep_plane</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span>

    <span class="c1"># Start with H1, then overwrite the pixels that are closer to plane 2 with im_H2</span>
    <span class="n">im_H</span> <span class="o">=</span> <span class="n">im_H1</span>
    <span class="n">im_H</span><span class="p">[</span><span class="n">H2_indices</span><span class="p">]</span> <span class="o">=</span> <span class="n">im_H2</span><span class="p">[</span><span class="n">H2_indices</span><span class="p">]</span>
    <span class="n">im_linear_rgb</span> <span class="o">=</span> <span class="n">convert</span><span class="o">.</span><span class="n">apply_color_matrix</span><span class="p">(</span><span class="n">im_H</span><span class="p">,</span> <span class="n">lms_model</span><span class="o">.</span><span class="n">linearRGB_from_LMS</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">convert</span><span class="o">.</span><span class="n">as_uint8</span><span class="p">(</span><span class="n">convert</span><span class="o">.</span><span class="n">sRGB_from_linearRGB</span><span class="p">(</span><span class="n">im_linear_rgb</span><span class="p">))</span>

<span class="n">im_tritan_brettel</span> <span class="o">=</span> <span class="n">simulate_dichromacy_brettel</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">lms_of_key</span><span class="p">(</span><span class="n">KBMRGCWY</span><span class="p">,</span> <span class="s1">'E'</span><span class="p">),</span> <span class="n">lms_485</span><span class="p">,</span> <span class="n">lms_660</span><span class="p">,</span> <span class="n">simulate</span><span class="o">.</span><span class="n">Deficiency</span><span class="o">.</span><span class="n">TRITAN</span><span class="p">)</span>
<span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">im_tritan_brettel</span><span class="p">,</span> <span class="s1">'Tritan (Brettel)'</span><span class="p">,</span> <span class="p">(</span><span class="mi">125</span><span class="p">,</span><span class="mi">190</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_COMPLEX</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="p">(</span><span class="mi">64</span><span class="p">,</span><span class="mi">64</span><span class="p">,</span><span class="mi">64</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">LINE_AA</span><span class="p">)</span>
<span class="n">px</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">im_original</span><span class="p">,</span> <span class="n">im_tritan</span><span class="p">,</span> <span class="n">im_tritan_brettel</span><span class="p">]))</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">v_E</span> <span class="o">=</span> <span class="n">lms_of_key</span><span class="p">(</span><span class="n">KBMRGCWY</span><span class="p">,</span> <span class="s1">'E'</span><span class="p">)</span> <span class="c1"># - K which is ommitted since it's zero</span>
<span class="n">v_475</span> <span class="o">=</span> <span class="n">lms_of_key</span><span class="p">(</span><span class="n">KBMRGCWY</span><span class="p">,</span> <span class="s1">'475nm'</span><span class="p">)</span> <span class="c1"># - K which is ommitted since it's zero</span>
<span class="n">v_575</span> <span class="o">=</span> <span class="n">lms_of_key</span><span class="p">(</span><span class="n">KBMRGCWY</span><span class="p">,</span> <span class="s1">'575nm'</span><span class="p">)</span>  <span class="c1"># - K which is ommitted since it's zero</span>
<span class="n">n1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">v_E</span><span class="p">,</span> <span class="n">v_475</span><span class="p">)</span> <span class="c1"># first plane</span>
<span class="n">n2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">v_E</span><span class="p">,</span> <span class="n">v_575</span><span class="p">)</span> <span class="c1"># second plane</span>

<span class="n">H_protans_brettel</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="o">-</span><span class="n">n1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">n1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="n">n1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">n1</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]),</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="o">-</span><span class="n">n2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">n2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="n">n2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">n2</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])]</span>

<span class="n">H_deutans_brettel</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="n">n1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">n1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">n1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">n1</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]),</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="n">n2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">n2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">n2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">n2</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
<span class="p">]</span>

<span class="nb">print</span><span class="p">()</span>
<span class="n">printMatrix</span><span class="p">(</span><span class="s1">'Projection matrix for protan (475nm)'</span><span class="p">,</span> <span class="n">H_protans_brettel</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">printMatrix</span><span class="p">(</span><span class="s1">'Projection matrix for protan (575nm)'</span><span class="p">,</span> <span class="n">H_protans_brettel</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="nb">print</span><span class="p">()</span>
<span class="n">printMatrix</span><span class="p">(</span><span class="s1">'Projection matrix for deutan (475nm)'</span><span class="p">,</span> <span class="n">H_deutans_brettel</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">printMatrix</span><span class="p">(</span><span class="s1">'Projection matrix for deutan (575nm)'</span><span class="p">,</span> <span class="n">H_deutans_brettel</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">im_protan_brettel</span> <span class="o">=</span> <span class="n">simulate_dichromacy_brettel</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">lms_E</span><span class="p">,</span> <span class="n">lms_475</span><span class="p">,</span> <span class="n">lms_575</span><span class="p">,</span> <span class="n">simulate</span><span class="o">.</span><span class="n">Deficiency</span><span class="o">.</span><span class="n">PROTAN</span><span class="p">)</span>
<span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">im_protan_brettel</span><span class="p">,</span> <span class="s1">'Protan (Brettel)'</span><span class="p">,</span> <span class="p">(</span><span class="mi">125</span><span class="p">,</span><span class="mi">190</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_COMPLEX</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="p">(</span><span class="mi">64</span><span class="p">,</span><span class="mi">64</span><span class="p">,</span><span class="mi">64</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">LINE_AA</span><span class="p">)</span>
<span class="n">px</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">im_original</span><span class="p">,</span> <span class="n">im_protan</span><span class="p">,</span> <span class="n">im_protan_brettel</span><span class="p">]))</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">hide_image_axes</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">im_deutan_brettel</span> <span class="o">=</span> <span class="n">simulate_dichromacy_brettel</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">lms_E</span><span class="p">,</span> <span class="n">lms_475</span><span class="p">,</span> <span class="n">lms_575</span><span class="p">,</span> <span class="n">simulate</span><span class="o">.</span><span class="n">Deficiency</span><span class="o">.</span><span class="n">DEUTAN</span><span class="p">)</span>
<span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">im_deutan_brettel</span><span class="p">,</span> <span class="s1">'Deutan (Brettel)'</span><span class="p">,</span> <span class="p">(</span><span class="mi">125</span><span class="p">,</span><span class="mi">190</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_COMPLEX</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="p">(</span><span class="mi">64</span><span class="p">,</span><span class="mi">64</span><span class="p">,</span><span class="mi">64</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">LINE_AA</span><span class="p">)</span>
<span class="n">px</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">im_original</span><span class="p">,</span> <span class="n">im_deutan</span><span class="p">,</span> <span class="n">im_deutan_brettel</span><span class="p">]))</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>For protanopia deuteranopia the results are much more similar, so the simpler Viénot approach is a good choice. It also better preserves with extreme values like pure RGB white (255,255,255) since the plane diagonal goes through it.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="How-accurate-are-these-simulations?">
<a class="anchor" href="#How-accurate-are-these-simulations?" aria-hidden="true"><span class="octicon octicon-link"></span></a>How accurate are these simulations?<a class="anchor-link" href="#How-accurate-are-these-simulations?"> </a>
</h2>
<p>Both the <a class="citation" href="#vienot_digital_1999">(Viénot, Brettel, &amp; Mollon, 1999)</a> and <a class="citation" href="#brettel_computerized_1997">(Brettel &amp; Mollon, 1997)</a> methods have fairly a solid background, but they remain approximate mathematical models of the complex human perception of colors. So how good are they at simulating how a person with CVD perceives colors? Several studies have attempted to validate these experimentally. A first step is to ask a person with CVD to validate whether the original image and the simulated image look similar, which is what <a class="citation" href="#brettel_computerized_1997">(Brettel &amp; Mollon, 1997)</a> did. More elaborate studies compared how people with CVD and people with normal vision performed on color tests or color-related tasks. On the original images people with normal vision are expected to perform better, but when given the simulated images they should perform similarly as the people with the corresponding CVD, if the simulate is accurate. <a class="citation" href="#simon_liedtke_using_2016">(Simon-Liedtke &amp; Farup, 2016)</a> show that the Brettel model is pretty good at least for deuteranopes, and <a class="citation" href="#machado_physiologically_based_2009">(Machado, Oliveira, &amp; Fernandes, 2009)</a> showed pretty good results for protanopes and deuteranopes for their method, which is similar to the Brettel one for full dichromacy.</p>
<p>There are still some serious limits though, so all these models have to be taken with a grain of salt:</p>
<ul>
<li>
<p>So far we've mostly discussed dichromacy, where one kind of cone is entirely missing. But most people actually have anomalous trichromacy, where the deficient cones are still either present but with less density, or shifted towards another cone, limiting its discrimitive power. For those the dichromat models will look too extreme as they can perceive more colors and see a difference between the original and simulated images. We'll discuss that next.</p>
</li>
<li>
<p>All these models are based on <em>average</em> observers. But there are great individual variations. For example <a class="citation" href="#brettel_computerized_1997">(Brettel &amp; Mollon, 1997)</a> noted that some experiments on 4 deuteranopes showed that two had a spectral peak of 558 nm for two of them, and 563nm for the other two. So ideally the parameters of the models would need to get adjusted accordingly for each person.</p>
</li>
<li>
<p>These models assumed that only the lowest level of color perception is affected, and ignore the plasticity of the brain that can potentially adapt and change the color perception at higher levels. These simulations do not model anything like that.</p>
</li>
<li>
<p>The validation experiments are generally made on very small population, rarely more than 10 people. And tritanopes are basically never evaluated since they are very rare and hard to find.</p>
</li>
<li>
<p>Most people will look at these simulations on an uncalibrated computer screen in a room with some kind of background illumination. Without a proper calibration of the monitor the stimuli that corresponds to each sRGB value will be innaccurate, and the background illumination may be far from D65 (normal outdoor). Also the brightness, contrast and color balance settings of the monitor can significantly change the color appearance.</p>
</li>
<li>
<p><a class="citation" href="#meyer_color_defective_1988">(Meyer &amp; Greenberg, 1988)</a> noted that the size of the field of view can affect the severity of an individual's deficiency. They refer to <a class="citation" href="#pokorny_new_1982">(Pokorny &amp; Smith, 1982)</a> that observed that the severity can decrease as the field of view increases. This explains why colors are harder to identify for a person with CVD on small objects like LEDs, but easier on large bright objects. Ideally the simulations should take that into account and preserve more of the original color on large objects.</p>
</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="What-about-anomalous-trichromacy?">
<a class="anchor" href="#What-about-anomalous-trichromacy?" aria-hidden="true"><span class="octicon octicon-link"></span></a>What about anomalous trichromacy?<a class="anchor-link" href="#What-about-anomalous-trichromacy?"> </a>
</h2>
<p>As mentioned above, most people with CVD still have <em>some</em> perception with the deficient kind of cones. The <a class="citation" href="#vienot_digital_1999">(Viénot, Brettel, &amp; Mollon, 1999)</a> and <a class="citation" href="#brettel_computerized_1997">(Brettel &amp; Mollon, 1997)</a> models can be adjusted to be more progressive by not projecting all the way towards the plane.</p>
<p>(missing reference), where the degree of severity comes from an amount of shift in the peak wavelength of the cone response. Dichromacy can be represented when e.g. the M-cone is shifted to align with the S-cone, effectively suppressing it. By shifting it less, various degrees of severity can be simulated. At the end of the day (missing reference) the step size is proportional to the distance between the point and the plane, while the steps are fixed in (missing reference) and <a class="citation" href="#machado_physiologically_based_2009">(Machado, Oliveira, &amp; Fernandes, 2009)</a> quite close for protanomaly and deuteranomaly. Here is an example for protanomaly:</p>
<p><!-- Image tags have to be unindented for nbdev to catch them :-( --></p>
<table>
    <tr>
<th>Original</th>
<th>Machado 2009 (1.0 severity)</th>
<th>Brettel 1997 (1.0 severity)</th>
</tr>
    <tr>
<td>
<figure>
  
    <img class="docimage" src="/images/copied_from_nb/simulation_images/rgbspan.png" alt="">
    
    
</figure>
</td>
<td>
<figure>
  
    <img class="docimage" src="/images/copied_from_nb/simulation_images/rgbspan_protan_machado2009.png" alt="">
    
    
</figure>
</td>
<td>
<figure>
  
    <img class="docimage" src="/images/copied_from_nb/simulation_images/rgbspan_protan_brettel1997.png" alt="">
    
    
</figure>
</td>
</tr>
     <tr>
<th>Original</th>
<th>Machado 2009 (0.5 severity)</th>
<th>Brettel 1997 (0.5 severity)</th>
</tr>
    <tr>
<td>
<figure>
  
    <img class="docimage" src="/images/copied_from_nb/simulation_images/rgbspan.png" alt="">
    
    
</figure>
</td>
<td>
<figure>
  
    <img class="docimage" src="/images/copied_from_nb/simulation_images/rgbspan_protan_machado2009_0.5.png" alt="">
    
    
</figure>
</td>
<td>
<figure>
  
    <img class="docimage" src="/images/copied_from_nb/simulation_images/rgbspan_protan_brettel1997_0.5.png" alt="">
    
    
</figure>
</td>
</tr>
</table>
<p>The main problem then becomes to estimate the severity factor for each individual. (missing reference) and <a class="citation" href="#macalpine_real_time_2016">(MacAlpine &amp; Flatla, 2016)</a> goes in that direction, but as far as I know there is no opensource code for it. If you want to evaluate what kind of blindness and what severity you have according to the LMS models discussed in this article I've generated a number of Ishihara-like plates in the Appendix FIXME.</p>
<p>There are also other research work that have remained more confidential so far like <a class="citation" href="#capilla_corresponding_pair_2004">(Capilla, Díez-Ajenjo, Luque, &amp; Malo, 2004)</a>. While interesting, the main problem here again is that no large-scale validation was performed, so it's hard to know which one is better. That group also did share <a href="http://rua.ua.es/dspace/handle/10045/23471">some Matlab code</a>, but it hasn't been maintained and can't be run without a Matlab runtime from 2011.</p>
<p>The next step after simulation is to try to transform images to help people with CVD to process them. The most well-known approach is the daltonize algorithm from <a class="citation" href="#fidaner_analysis_2005">(Fidaner, Lin, &amp; Ozguven, 2005)</a>, but it's main advantage is the simplicity and code availability as it is quite rough (it was actually just a small school project!). There are a lot of more recent work in that area, so it'll be the subject of a followup article.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Appendix">
<a class="anchor" href="#Appendix" aria-hidden="true"><span class="octicon octicon-link"></span></a>Appendix<a class="anchor-link" href="#Appendix"> </a>
</h1>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Code-to-generate-the-confusion-lines-of-the-introduction">
<a class="anchor" href="#Code-to-generate-the-confusion-lines-of-the-introduction" aria-hidden="true"><span class="octicon octicon-link"></span></a>Code to generate the confusion lines of the introduction<a class="anchor-link" href="#Code-to-generate-the-confusion-lines-of-the-introduction"> </a>
</h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Debug figure to visualize the confusion lines</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">scatter_3d</span><span class="p">(</span><span class="n">KBMRGCWY</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">'K'</span><span class="p">:</span><span class="s1">'Y'</span><span class="p">],</span> <span class="n">x</span><span class="o">=</span><span class="s1">'L'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">'M'</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="s1">'S'</span><span class="p">,</span> 
                    <span class="n">color</span><span class="o">=</span><span class="s1">'colorhex'</span><span class="p">,</span> <span class="n">color_discrete_map</span><span class="o">=</span><span class="s1">'identity'</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s1">'short_name'</span><span class="p">,</span>
                    <span class="n">width</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">)</span>

<span class="c1"># Add the parallelepiped lines</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">KBMRGCWY</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="s1">'K'</span><span class="p">,</span><span class="s1">'B'</span><span class="p">,</span><span class="s1">'M'</span><span class="p">,</span><span class="s1">'R'</span><span class="p">,</span> <span class="s1">'K'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'Y'</span><span class="p">,</span> <span class="s1">'W'</span><span class="p">,</span> <span class="s1">'C'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'Y'</span><span class="p">,</span> <span class="s1">'R'</span><span class="p">,</span> <span class="s1">'M'</span><span class="p">,</span> <span class="s1">'W'</span><span class="p">,</span> <span class="s1">'C'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">]]</span>
<span class="n">fig</span><span class="o">.</span><span class="n">add_scatter3d</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'L'</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'M'</span><span class="p">],</span> <span class="n">z</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'S'</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">'lines'</span><span class="p">,</span> <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Add the black-white diagonal</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">KBMRGCWY</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="s1">'K'</span><span class="p">,</span><span class="s1">'W'</span><span class="p">]]</span>
<span class="n">fig</span><span class="o">.</span><span class="n">add_scatter3d</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'L'</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'M'</span><span class="p">],</span> <span class="n">z</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'S'</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">'lines'</span><span class="p">,</span> <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">dash</span><span class="o">=</span><span class="s1">'dash'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">))</span>

<span class="c1"># add_black_white_yellow_blue_plane(fig, KBMRGCWY)</span>
   
<span class="k">def</span> <span class="nf">generate_confusion_line</span><span class="p">(</span><span class="n">lms_color</span><span class="p">,</span> <span class="n">anomaly</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">,</span> <span class="n">fig</span><span class="p">):</span>
    <span class="c1"># This returns a line segment along the anomaly projection axis (L, M or S)</span>
    <span class="c1"># that passes through the input LMS color and stops at the boundaries of the</span>
    <span class="c1"># gamut (the parallelepiped). Then we can walk along that segment with small</span>
    <span class="c1"># steps to generate confusion colors.</span>
    <span class="n">segment</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">lms_confusion_segment</span><span class="p">(</span><span class="n">lms_color</span><span class="p">,</span> <span class="n">lms_model</span><span class="p">,</span> <span class="n">anomaly</span><span class="p">)</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Ensure num_steps at the end</span>
    <span class="n">step</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">num_steps</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">-</span> <span class="mf">1e-5</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">segment</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">s</span><span class="p">)</span> <span class="o">+</span> <span class="n">segment</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">s</span>
        <span class="n">colors</span><span class="o">.</span><span class="n">append</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fig</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_scatter3d</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">z</span><span class="o">=</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span> <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">lms_model</span><span class="o">.</span><span class="n">sRGB_hexstring_from_LMS</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> 
                                          <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">'Black'</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">colors</span>
    
<span class="n">anomaly</span> <span class="o">=</span> <span class="n">simulate</span><span class="o">.</span><span class="n">Deficiency</span><span class="o">.</span><span class="n">PROTAN</span>
<span class="n">num_steps</span> <span class="o">=</span> <span class="mi">7</span>

<span class="c1"># Generate segments that passes through a set of LMS points. To get a nice</span>
<span class="c1"># distribution of the segment we sample them from the diagonal Black-Yellow-Blue plane</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">lms_of_key</span><span class="p">(</span><span class="n">KBMRGCWY</span><span class="p">,</span> <span class="s1">'Y'</span><span class="p">)</span> <span class="o">-</span> <span class="n">lms_of_key</span><span class="p">(</span><span class="n">KBMRGCWY</span><span class="p">,</span> <span class="s1">'K'</span><span class="p">)</span>
<span class="n">V</span> <span class="o">=</span> <span class="n">lms_of_key</span><span class="p">(</span><span class="n">KBMRGCWY</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">)</span> <span class="o">-</span> <span class="n">lms_of_key</span><span class="p">(</span><span class="n">KBMRGCWY</span><span class="p">,</span> <span class="s1">'K'</span><span class="p">)</span>
<span class="n">confusion_lines</span> <span class="o">=</span> <span class="p">[]</span>
<span class="c1"># for uv_plane in itertools.product([0.1,0.25,0.5,0.75,0.9], [0.02,0.1,0.25,0.5,0.75,0.9]):</span>
<span class="k">for</span> <span class="n">uv_plane</span> <span class="ow">in</span> <span class="p">[(</span><span class="mf">0.2</span><span class="p">,</span><span class="mf">0.2</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">)]:</span>
    <span class="n">lms_color</span> <span class="o">=</span> <span class="n">uv_plane</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">U</span><span class="p">,</span><span class="n">V</span><span class="p">])</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="n">generate_confusion_line</span><span class="p">(</span><span class="n">lms_color</span><span class="p">,</span> <span class="n">anomaly</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">,</span> <span class="n">fig</span><span class="p">)</span>
    <span class="n">confusion_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span>

<span class="nb">print</span> <span class="p">(</span><span class="sa">f</span><span class="s2">"# Confusion lines for </span><span class="si">{</span><span class="n">anomaly</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span> <span class="p">(</span><span class="s2">"confusion_lines = ["</span><span class="p">)</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">confusion_lines</span><span class="p">:</span>
    <span class="nb">print</span> <span class="p">(</span><span class="s2">" "</span><span class="o">*</span><span class="mi">4</span> <span class="o">+</span> <span class="s2">"pd.DataFrame.from_records(["</span><span class="p">)</span>
    <span class="n">lines_as_text</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
        <span class="n">srgb_hex</span> <span class="o">=</span> <span class="n">lms_model</span><span class="o">.</span><span class="n">sRGB_hexstring_from_LMS</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">L</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">S</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">linear_rgb</span> <span class="o">=</span> <span class="n">convert</span><span class="o">.</span><span class="n">apply_color_matrix</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">lms_model</span><span class="o">.</span><span class="n">linearRGB_from_LMS</span><span class="p">)</span>
        <span class="n">linear_rgb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">linear_rgb</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">R</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">B</span> <span class="o">=</span> <span class="n">linear_rgb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">linear_rgb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">linear_rgb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">lines_as_text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">" "</span><span class="o">*</span><span class="mi">8</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">"(</span><span class="si">{</span><span class="n">L</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">M</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">S</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">R</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">G</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">B</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, '</span><span class="si">{</span><span class="n">srgb_hex</span><span class="si">}</span><span class="s2">')"</span><span class="p">)</span>
    <span class="nb">print</span> <span class="p">(</span><span class="s2">",</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines_as_text</span><span class="p">)</span> <span class="o">+</span> <span class="s2">"],"</span><span class="p">)</span>    
    <span class="nb">print</span> <span class="p">(</span><span class="s2">" "</span><span class="o">*</span><span class="mi">8</span> <span class="o">+</span> <span class="s2">"columns = ['L', 'M', 'S', 'R', 'G', 'B', 'sRGB_hex']),"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"]"</span><span class="p">)</span>
<span class="c1"># Uncomment to show the confusion lines.</span>
<span class="c1"># fig.show()</span>

<span class="n">confusion_matrices</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">confusion_line</span> <span class="ow">in</span> <span class="n">confusion_lines</span><span class="p">:</span>
    <span class="n">confusion_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">confusion_line</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">confusion_matrix</span> <span class="o">=</span> <span class="n">convert</span><span class="o">.</span><span class="n">apply_color_matrix</span><span class="p">(</span><span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">lms_model</span><span class="o">.</span><span class="n">linearRGB_from_LMS</span><span class="p">)</span>
    <span class="n">confusion_matrix</span> <span class="o">=</span> <span class="n">convert</span><span class="o">.</span><span class="n">sRGB_from_linearRGB</span><span class="p">(</span><span class="n">confusion_matrix</span><span class="p">)</span>
    <span class="n">confusion_matrices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">confusion_matrix</span><span class="o">*</span><span class="mf">255.0</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">255.</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">confusion_matrices</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">"Confusion lines for </span><span class="si">{</span><span class="n">anomaly</span><span class="si">}</span><span class="s2">. The colors on each row should appear similar to a dichromat."</span><span class="p">)</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">hide_image_axes</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Generated-Ishihara-like-plates-to-evaluate-the-kind-and-severity-of-CVD">
<a class="anchor" href="#Generated-Ishihara-like-plates-to-evaluate-the-kind-and-severity-of-CVD" aria-hidden="true"><span class="octicon octicon-link"></span></a>Generated Ishihara-like plates to evaluate the kind and severity of CVD<a class="anchor-link" href="#Generated-Ishihara-like-plates-to-evaluate-the-kind-and-severity-of-CVD"> </a>
</h2>
<p>It is possible to generate Ishihara-like plates for a given deficiency and severity factor. The main idea is to pick a confusion segment in the LMS space, and generate an Ishihara-like image by using one end of the segment as the background color and the other end as the foreground color (a single-digit number). On top of that lower degrees of severity can be tested by making the segment shorter, effectively reducing the distance between the colors along the confusion line. This makes it harder and harder to differentiate for someone with anomalous trichromacy.</p>
<p>By looking at these generated plates it becomes possible to self-evaluate the kind of deficiency by checking in which plate the numbers are the harder to read. For example I can read all the numbers in the tritan plate, most numbers in the deutan plate (but not all), and barely any in the protan plate. This confirms that I am a protan.</p>
<p>Then the severity can be evaluated by looking at plates generated with decreasing severity and checking at which value it becomes impossible to see any number. For me that's around 0.8 for the protan plate.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">showAnimatedImages</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">deficiency</span><span class="p">):</span>
    <span class="n">images</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">severity</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.19</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">):</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">generate</span><span class="o">.</span><span class="n">ishihara_plate</span><span class="p">(</span><span class="n">deficiency</span><span class="p">,</span> <span class="n">severity</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"Severity </span><span class="si">{</span><span class="n">severity</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">images</span><span class="o">.</span><span class="n">append</span> <span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="n">images</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">704</span><span class="o">*</span><span class="mf">1.4</span><span class="p">,</span> <span class="n">animation_frame</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">hide_image_axes</span><span class="p">)</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">margin</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">showAnimatedImages</span><span class="p">(</span><span class="s2">"Protanopia / protanomaly"</span><span class="p">,</span> <span class="n">simulate</span><span class="o">.</span><span class="n">Deficiency</span><span class="o">.</span><span class="n">PROTAN</span><span class="p">)</span>
<span class="n">showAnimatedImages</span><span class="p">(</span><span class="s2">"Deuteranopia / deuteranomaly"</span><span class="p">,</span> <span class="n">simulate</span><span class="o">.</span><span class="n">Deficiency</span><span class="o">.</span><span class="n">DEUTAN</span><span class="p">)</span>
<span class="n">showAnimatedImages</span><span class="p">(</span><span class="s2">"Tritanopia / tratanomaly"</span><span class="p">,</span> <span class="n">simulate</span><span class="o">.</span><span class="n">Deficiency</span><span class="o">.</span><span class="n">TRITAN</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p></p>
<ol class="bibliography">
<li><span id="meyer_color_defective_1988">Meyer, G. W., &amp; Greenberg, D. P. (1988). Color-defective vision and computer graphics displays. <i>IEEE Computer Graphics and Applications</i>, <i>8</i>(5), 28–40.</span></li>
<li><span id="vienot_digital_1999">Viénot, F., Brettel, H., &amp; Mollon, J. D. (1999). Digital video colourmaps for checking the legibility of displays by dichromats. <i>Color Research &amp; Application</i>, <i>24</i>(4), 243–252.</span></li>
<li><span id="brettel_computerized_1997">Brettel, H., &amp; Mollon, J. D. (1997). <i>Computerized simulation of color appearance for dichromats</i>. <i>14</i>(10), 2647–2655.</span></li>
<li><span id="fairchild2013color">Fairchild, M. D. (2013). <i>Color appearance models</i>. John Wiley &amp; Sons.</span></li>
<li><span id="machado_physiologically_based_2009">Machado, G. M., Oliveira, M. M., &amp; Fernandes, L. A. F. (2009). A physiologically-based model for simulation of color vision deficiency. <i>IEEE Transactions on Visualization and Computer Graphics</i>, <i>15</i>(6), 1291–1298. https://doi.org/10.1109/TVCG.2009.113</span></li>
<li><span id="flatla_so_2012">Flatla, D. R., &amp; Gutwin, C. (2012). "So that’s what you see": building understanding with personalized simulations of colour vision deficiency. <i>Proceedings of the 14th International ACM SIGACCESS Conference on Computers and Accessibility</i>, 167–174. New York, NY, USA: Association for Computing Machinery. https://doi.org/10.1145/2384916.2384946</span></li>
<li><span id="fidaner_analysis_2005">Fidaner, O., Lin, P., &amp; Ozguven, N. (2005). <i>Analysis of Color Blindness</i>.</span></li>
<li><span id="simon_liedtke_using_2016">Simon-Liedtke, J. T., &amp; Farup, I. (2016). Using a Behavioral Match-to-Sample Method to Evaluate Color Vision Deficiency Simulation Methods. <i>Journal of Imaging Science and Technology</i>, <i>60</i>(5), 504091–504099. https://doi.org/10.2352/J.ImagingSci.Technol.2016.60.5.050409</span></li>
<li><span id="kotera_optimal_2012">Kotera, H. (2012). Optimal daltonization by spectral shift for dichromatic vision. <i>Color and Imaging Conference</i>, <i>2012</i>, 302–308. Society for Imaging Science and Technology.</span></li>
<li><span id="daltonize_org"><i>daltonize.org</i>. (2010). Retrieved from http://www.daltonize.org</span></li>
<li><span id="dietrich_daltonize_2020">Dietrich, J., &amp; daltonize.py. (2020). <i>daltonize</i>. Retrieved from https://github.com/joergdietrich</span></li>
<li><span id="jim_ixora_2021">Jim, &amp; Ixora. (2021). <i>Color Blindness Simulation Research</i>. Retrieved from https://ixora.io/projects/colorblindness/color-blindness-simulation-research/</span></li>
<li><span id="smith_spectral_1975">Smith, V. C., &amp; Pokorny, J. (1975). Spectral sensitivity of the foveal cone photopigments between 400 and 500 nm. <i>Vision Research</i>, <i>15</i>(2), 161–171.</span></li>
<li><span id="estevez1981fundamental">Estévez, O. (1981). On the fundamental data-base of normal and dichromatic colour vision. <i>Ph. D. Thesis, University of Amsterdam</i>.</span></li>
<li><span id="stockman_spectral_2000">Stockman, A., &amp; Sharpe, L. T. (2000). The spectral sensitivities of the middle-and long-wavelength-sensitive cones derived from measurements in observers of known genotype. <i>Vision Research</i>, <i>40</i>, 1711–1737.</span></li>
<li><span id="vienot_colorimetry_2013">Viénot, F., &amp; Le Rohellec, J. (2013). Colorimetry and Physiology - The LMS Specification. In <i>Digital Color</i> (pp. 1–28). Hoboken, NJ USA: John Wiley &amp; Sons, Inc. https://doi.org/10.1002/9781118562680.ch1</span></li>
<li><span id="smith_color_2003">Smith, V. C., &amp; Pokorny, J. (2003). Color Matching and Color Discrimination. In <i>The Science of Color</i> (pp. 103–148). Elsevier. https://doi.org/10.1016/B978-044451251-2/50004-0</span></li>
<li><span id="pokorny_new_1982">Pokorny, J., &amp; Smith, V. C. (1982). New observations concerning red–green color defects. <i>Color Research &amp; Application</i>, <i>7</i>(2), 159–164.</span></li>
<li><span id="macalpine_real_time_2016">MacAlpine, R., &amp; Flatla, D. R. (2016). <i>Real-Time Mobile Personalized Simulations of Impaired Colour Vision</i>. 9.</span></li>
<li><span id="capilla_corresponding_pair_2004">Capilla, P., Díez-Ajenjo, M. A., Luque, M. J., &amp; Malo, J. (2004). Corresponding-pair procedure: a new approach to simulation of dichromatic color perception. <i>Journal of the Optical Society of America. A, Optics, Image Science, and Vision</i>, <i>21</i>(2), 176–186. https://doi.org/10.1364/josaa.21.000176</span></li>
</ol>

</div>
</div>
</div>
</div>



  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="DaltonLens/daltonlens.org"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/understanding-cvd-simulation/" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Software tools and technical posts to make the life of colorblind people easier. Includes color filters and color blindness simulation.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/DaltonLens" title="DaltonLens"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/nburrus" title="nburrus"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
