<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Understanding LMS-based Color Blindness Simulations | DaltonLens</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Understanding LMS-based Color Blindness Simulations" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Diving deeper in the theory of Viénot, Brettel &amp; Mollon’s method to understand what’s behind the scene." />
<meta property="og:description" content="Diving deeper in the theory of Viénot, Brettel &amp; Mollon’s method to understand what’s behind the scene." />
<link rel="canonical" href="http://daltonlens.org/understanding-cvd-simulation/" />
<meta property="og:url" content="http://daltonlens.org/understanding-cvd-simulation/" />
<meta property="og:site_name" content="DaltonLens" />
<meta property="og:image" content="http://daltonlens.org/images/chart-preview.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-10-21T00:00:00-05:00" />
<script type="application/ld+json">
{"url":"http://daltonlens.org/understanding-cvd-simulation/","headline":"Understanding LMS-based Color Blindness Simulations","dateModified":"2021-10-21T00:00:00-05:00","datePublished":"2021-10-21T00:00:00-05:00","image":"http://daltonlens.org/images/chart-preview.png","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://daltonlens.org/understanding-cvd-simulation/"},"description":"Diving deeper in the theory of Viénot, Brettel &amp; Mollon’s method to understand what’s behind the scene.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="http://daltonlens.org/feed.xml" title="DaltonLens" /><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">DaltonLens</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/search/">Search</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Understanding LMS-based Color Blindness Simulations</h1><p class="page-description">Diving deeper in the theory of Viénot, Brettel & Mollon's method to understand what's behind the scene.</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2021-10-21T00:00:00-05:00" itemprop="datePublished">
        Oct 21, 2021
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      45 min read
    
</span></p>

    

    
      
        <div class="pb-5 d-flex flex-wrap flex-justify-end">
          <div class="px-2">

    <a href="https://github.com/DaltonLens/daltonlens.org/tree/master/_notebooks/2021-10-21-Understanding-Color-Blindness-Simulations.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          <div class="px-2">
    <a href="https://mybinder.org/v2/gh/DaltonLens/daltonlens.org/master?filepath=_notebooks%2F2021-10-21-Understanding-Color-Blindness-Simulations.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/binder.svg" alt="Open In Binder"/>
    </a>
</div>

          <div class="px-2">
    <a href="https://colab.research.google.com/github/DaltonLens/daltonlens.org/blob/master/_notebooks/2021-10-21-Understanding-Color-Blindness-Simulations.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h1"><a href="#Introduction">Introduction </a></li>
<li class="toc-entry toc-h1"><a href="#From-sRGB-to-LMS">From sRGB to LMS </a>
<ul>
<li class="toc-entry toc-h2"><a href="#From-sRGB-to-linearRGB">From sRGB to linearRGB </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Does-it-matter?-Yes!">Does it matter? Yes! </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#From-linearRGB-to-CIE-XYZ">From linearRGB to CIE XYZ </a></li>
<li class="toc-entry toc-h2"><a href="#From-CIE-XYZ-to-LMS">From CIE XYZ to LMS </a></li>
<li class="toc-entry toc-h2"><a href="#From-linearRGB-to-LMS">From linearRGB to LMS </a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#Simulating-dichromacy-in-LMS-(Brettel-1997-and-Viénot-1999)">Simulating dichromacy in LMS (Brettel 1997 and Viénot 1999) </a>
<ul>
<li class="toc-entry toc-h2"><a href="#Projection-planes-in-LMS">Projection planes in LMS </a></li>
<li class="toc-entry toc-h2"><a href="#The-simplification-of-Viénot-1999-for-protanopes-and-deuteranopes">The simplification of Viénot 1999 for protanopes and deuteranopes </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Plane-projection-as-a-3x3-matrix">Plane projection as a 3x3 matrix </a></li>
<li class="toc-entry toc-h3"><a href="#Putting-it-together">Putting it together </a></li>
<li class="toc-entry toc-h3"><a href="#What-about-tritanopes?">What about tritanopes? </a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#Comparing-Viénot-1999-and-Brettel-1997">Comparing Viénot 1999 and Brettel 1997 </a></li>
<li class="toc-entry toc-h1"><a href="#What-about-anomalous-trichromacy?">What about anomalous trichromacy? </a></li>
<li class="toc-entry toc-h1"><a href="#Conclusion">Conclusion </a></li>
<li class="toc-entry toc-h1"><a href="#Bibliography">Bibliography </a></li>
<li class="toc-entry toc-h1"><a href="#Appendix">Appendix </a>
<ul>
<li class="toc-entry toc-h2"><a href="#Code-to-generate-the-confusion-lines-of-the-introduction">Code to generate the confusion lines of the introduction </a></li>
</ul>
</li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2021-10-21-Understanding-Color-Blindness-Simulations.ipynb
-->

<div class="container" id="notebook-container">
        
    
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Introduction">
<a class="anchor" href="#Introduction" aria-hidden="true"><span class="octicon octicon-link"></span></a>Introduction<a class="anchor-link" href="#Introduction"> </a>
</h1>
<p>This post is a followup to our <a href="/opensource-cvd-simulation/#How-accurate-are-these-simulations?">Review of Open Source Color Blindness Simulations</a> and assumes that you are familiar with color vision deficiencies (CVD) simulation. The goal of this post is to dive into <em>how</em> these methods actually work. To visualize and play with the models interactively this page is actually generated from a Jupyter notebook (using <a href="https://github.com/fastai/fastpages">fastpages</a>) and can be run in e.g. <a href="https://colab.research.google.com/github/DaltonLens/daltonlens.org/blob/master/_notebooks/2021-10-30-Understanding-Color-Blindness-Simulations.ipynb">Google colab</a> to play with it.</p>
<p><a class="citation" href="#brettel_computerized_1997">(Brettel &amp; Mollon, 1997)</a>, <a class="citation" href="#vienot_digital_1999">(Viénot, Brettel, &amp; Mollon, 1999)</a> and <a class="citation" href="#machado_physiologically_based_2009">(Machado, Oliveira, &amp; Fernandes, 2009)</a> all rely on the same low-level principles to simulate CVD. For all of them the final code will basically just apply a sRGB/gamma function, one or two 3x3 matrices, undo the gamma, and call it a day. But we're going to analyze that pipeline and try to understand how to compute those matrices and get a sense of what they do.</p>
<p>The Machado 2009 method is actually a bit more involved as it uses a second stage of modeling (opponent-color theory), so we will not cover it here and only focus on Viénot 1999 and Brettel 1997. Both focus on full dichromacy, so we'll start with that. The extension to anomalous trichromacy will be discussed in section <a href="#What-about-anomalous-trichromacy?">What about anomalous trichromacy?</a>, and it's worth noting that Machado 2009 has similar results for dichromacy anyway.</p>
<p>Let's first get an overview of the process. Protanopes, deuteranopes and tritanopes respectively lack the L, M, and S cone cells. Thus a natural approach to simulate dichromacy is to go to the LMS color-space and somehow remove the component coming from the missing cone cells. The good news is that going from an RGB color space to LMS can be done with a linear transformation (matrix multiplication). But as usual there are many ways to do it and it'll deserve its own section.</p>
<p>One extra complexity is that images are typically encoded in <code>sRGB</code> to get properly displayed on digital monitors. So our first step will be to go from sRGB to linear RGB, and then from there to LMS.</p>
<p>Once in the LMS color space, colors that only differ by the coordinate of the axis corresponding to the missing cone cannot be differentiated by a dichromat. This creates so-called confusion lines, which are, by construction, parallel to the missing axis in the LMS color space. So according to this model a protanope cannot distinguish colors that only differ by their L component, a deuteranope those that only differ by their M component, and tritanopes those that only differ by their S component.</p>
<p>To illustrate this let's build a plot with a few confusion lines in the LMS space, and their counterpart on the linear RGB space. The code to generate the confusion lines is in the <a href="#Code-to-generate-the-confusion-lines-of-the-introduction">Appendix</a>. We'll going to just draw 5 precomputed lines, starting with protanopia (missing L cones). To have a reference we'll also add the gamut (range) of colors that can be produced by a digital monitor. It's a cube in the RGB color space, and a parallelepiped in the LMS space. The 8 vertices are black (<code>K = RGB[0,0,0]</code>), white (<code>W = RGB[1, 1, 1])</code>, red (<code>R = RGB[1, 0, 0])</code>, green (<code>G = RGB[0,1,0]</code>), blue (<code>B = RGB[0,0,1]</code>), yellow (<code>G = RGB[1,1,0]</code>), magenta (<code>M = RGB[1,0,1]</code>) and cyan (<code>C = RGB[0,1,1]</code>). 
</p>
<div class="flash">
    <svg class="octicon octicon-info" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z"></path></svg>
    <strong>Note: </strong>the plots are in 3D and interactive, so feel free to play with the point of view!
</div>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># This cell defines all our imports and a few utilities</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">plotly.express</span> <span class="k">as</span> <span class="nn">px</span>
<span class="kn">import</span> <span class="nn">plotly.graph_objs</span> <span class="k">as</span> <span class="nn">go</span>
<span class="kn">from</span> <span class="nn">plotly.subplots</span> <span class="kn">import</span> <span class="n">make_subplots</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">Geometry3D</span> <span class="k">as</span> <span class="nn">geo3d</span>

<span class="kn">import</span> <span class="nn">daltonlens.convert</span> <span class="k">as</span> <span class="nn">convert</span>
<span class="kn">import</span> <span class="nn">daltonlens.generate</span> <span class="k">as</span> <span class="nn">generate</span>
<span class="kn">import</span> <span class="nn">daltonlens.simulate</span> <span class="k">as</span> <span class="nn">simulate</span>
<span class="kn">import</span> <span class="nn">daltonlens.geometry</span> <span class="k">as</span> <span class="nn">geometry</span>
<span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">suppress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">printMatrix</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
    <span class="n">mat_str</span> <span class="o">=</span> <span class="s1">'</span><span class="se">\n</span><span class="s1">  '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array_repr</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">))</span>
    <span class="nb">print</span> <span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> = </span><span class="se">\n</span><span class="s1">  </span><span class="si">{</span><span class="n">mat_str</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
    
<span class="c1"># Utility for plotly imshow</span>
<span class="n">hide_image_axes</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">yaxis_visible</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">yaxis_showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">xaxis_visible</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">xaxis_showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">show_confusion_lines</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
    <span class="n">rgb_cube</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">([</span>
        <span class="p">(</span><span class="s1">'K'</span><span class="p">,</span> <span class="s1">'black'</span><span class="p">,</span>     <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span> <span class="mf">0.</span>        <span class="p">,</span> <span class="mf">0.</span>        <span class="p">,</span> <span class="mf">0.</span>        <span class="p">,</span> <span class="s1">'#000000'</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">'B'</span><span class="p">,</span> <span class="s1">'blue'</span><span class="p">,</span>      <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">1</span><span class="p">,</span> <span class="mf">0.03596577</span><span class="p">,</span> <span class="mf">0.03620635</span><span class="p">,</span> <span class="mf">0.01528089</span><span class="p">,</span> <span class="s1">'#0000ff'</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">'M'</span><span class="p">,</span> <span class="s1">'magenta'</span><span class="p">,</span>   <span class="mi">1</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">1</span><span class="p">,</span> <span class="mf">0.21482533</span><span class="p">,</span> <span class="mf">0.07001029</span><span class="p">,</span> <span class="mf">0.01559176</span><span class="p">,</span> <span class="s1">'#ff00ff'</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">'R'</span><span class="p">,</span> <span class="s1">'red'</span><span class="p">,</span>       <span class="mi">1</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span> <span class="mf">0.17885956</span><span class="p">,</span> <span class="mf">0.03380394</span><span class="p">,</span> <span class="mf">0.00031087</span><span class="p">,</span> <span class="s1">'#ff0000'</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">'G'</span><span class="p">,</span> <span class="s1">'green'</span><span class="p">,</span>     <span class="mi">0</span><span class="p">,</span>   <span class="mi">1</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span> <span class="mf">0.43997117</span><span class="p">,</span> <span class="mf">0.27515242</span><span class="p">,</span> <span class="mf">0.00191661</span><span class="p">,</span> <span class="s1">'#00ff00'</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">'C'</span><span class="p">,</span> <span class="s1">'cyan'</span><span class="p">,</span>      <span class="mi">0</span><span class="p">,</span>   <span class="mi">1</span><span class="p">,</span>   <span class="mi">1</span><span class="p">,</span> <span class="mf">0.47593694</span><span class="p">,</span> <span class="mf">0.31135877</span><span class="p">,</span> <span class="mf">0.0171975</span> <span class="p">,</span> <span class="s1">'#00ffff'</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">'W'</span><span class="p">,</span> <span class="s1">'white'</span><span class="p">,</span>     <span class="mi">1</span><span class="p">,</span>   <span class="mi">1</span><span class="p">,</span>   <span class="mi">1</span><span class="p">,</span> <span class="mf">0.6547965</span> <span class="p">,</span> <span class="mf">0.34516271</span><span class="p">,</span> <span class="mf">0.01750837</span><span class="p">,</span> <span class="s1">'#ffffff'</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">'Y'</span><span class="p">,</span> <span class="s1">'yellow'</span><span class="p">,</span>    <span class="mi">1</span><span class="p">,</span>   <span class="mi">1</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span> <span class="mf">0.61883073</span><span class="p">,</span> <span class="mf">0.30895636</span><span class="p">,</span> <span class="mf">0.00222748</span><span class="p">,</span> <span class="s1">'#ffff00'</span><span class="p">)],</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'short_name'</span><span class="p">,</span> <span class="s1">'name'</span><span class="p">,</span> <span class="s1">'R'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">,</span> <span class="s1">'L'</span><span class="p">,</span> <span class="s1">'M'</span><span class="p">,</span> <span class="s1">'S'</span><span class="p">,</span> <span class="s1">'sRGB_hex'</span><span class="p">])</span>
    <span class="n">rgb_cube</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">rgb_cube</span><span class="p">[</span><span class="s1">'short_name'</span><span class="p">]</span>
    <span class="n">rgb_cube</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">'key'</span>
    <span class="c1"># display(HTML("&lt;h2&gt;RGB Cube&lt;/h2&gt;"), rgb_cube)</span>
    
    <span class="n">fig</span> <span class="o">=</span> <span class="n">make_subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> 
                        <span class="n">subplot_titles</span><span class="o">=</span><span class="p">(</span><span class="s1">'RGB Color Space'</span><span class="p">,</span>  <span class="s1">'LMS Color Space'</span><span class="p">),</span>
                        <span class="n">specs</span><span class="o">=</span><span class="p">[[{</span><span class="s2">"type"</span><span class="p">:</span> <span class="s2">"scene"</span><span class="p">},</span> <span class="p">{</span><span class="s2">"type"</span><span class="p">:</span> <span class="s2">"scene"</span><span class="p">}]])</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">add_scatter3d</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">rgb_cube</span><span class="p">[</span><span class="s1">'R'</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">rgb_cube</span><span class="p">[</span><span class="s1">'G'</span><span class="p">],</span> <span class="n">z</span><span class="o">=</span><span class="n">rgb_cube</span><span class="p">[</span><span class="s1">'B'</span><span class="p">],</span> 
                      <span class="n">text</span><span class="o">=</span><span class="n">rgb_cube</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">"markers+text"</span><span class="p">,</span>
                      <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">rgb_cube</span><span class="p">[</span><span class="s1">'sRGB_hex'</span><span class="p">]),</span>
                      <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">add_scatter3d</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">rgb_cube</span><span class="p">[</span><span class="s1">'L'</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">rgb_cube</span><span class="p">[</span><span class="s1">'M'</span><span class="p">],</span> <span class="n">z</span><span class="o">=</span><span class="n">rgb_cube</span><span class="p">[</span><span class="s1">'S'</span><span class="p">],</span> 
                      <span class="n">text</span><span class="o">=</span><span class="n">rgb_cube</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">"markers+text"</span><span class="p">,</span>
                      <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">rgb_cube</span><span class="p">[</span><span class="s1">'sRGB_hex'</span><span class="p">]),</span>
                      <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">dragmode</span><span class="o">=</span><span class="s1">'orbit'</span><span class="p">,</span> 
                      <span class="n">scene</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                        <span class="n">xaxis_title</span><span class="o">=</span><span class="s1">'R'</span><span class="p">,</span>
                        <span class="n">yaxis_title</span><span class="o">=</span><span class="s1">'G'</span><span class="p">,</span>
                        <span class="n">zaxis_title</span><span class="o">=</span><span class="s1">'B'</span><span class="p">))</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">scene2</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                        <span class="n">xaxis_title</span><span class="o">=</span><span class="s1">'L'</span><span class="p">,</span>
                        <span class="n">yaxis_title</span><span class="o">=</span><span class="s1">'M'</span><span class="p">,</span>
                        <span class="n">zaxis_title</span><span class="o">=</span><span class="s1">'S'</span><span class="p">))</span>
    
    <span class="c1"># Add the parallelepiped lines</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">rgb_cube</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="s1">'K'</span><span class="p">,</span><span class="s1">'B'</span><span class="p">,</span><span class="s1">'M'</span><span class="p">,</span><span class="s1">'R'</span><span class="p">,</span> <span class="s1">'K'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'Y'</span><span class="p">,</span> <span class="s1">'W'</span><span class="p">,</span> <span class="s1">'C'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'Y'</span><span class="p">,</span> <span class="s1">'R'</span><span class="p">,</span> <span class="s1">'M'</span><span class="p">,</span> <span class="s1">'W'</span><span class="p">,</span> <span class="s1">'C'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">]]</span>    
    <span class="n">fig</span><span class="o">.</span><span class="n">add_scatter3d</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'R'</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'G'</span><span class="p">],</span> <span class="n">z</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'B'</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">'lines'</span><span class="p">,</span> <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_scatter3d</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'L'</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'M'</span><span class="p">],</span> <span class="n">z</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'S'</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">'lines'</span><span class="p">,</span> <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_scatter3d</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">line</span><span class="p">[</span><span class="s1">'R'</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">line</span><span class="p">[</span><span class="s1">'G'</span><span class="p">],</span> <span class="n">z</span><span class="o">=</span><span class="n">line</span><span class="p">[</span><span class="s1">'B'</span><span class="p">],</span> <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                          <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">line</span><span class="p">[</span><span class="s1">'sRGB_hex'</span><span class="p">]),</span>
                          <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">add_scatter3d</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">line</span><span class="p">[</span><span class="s1">'L'</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">line</span><span class="p">[</span><span class="s1">'M'</span><span class="p">],</span> <span class="n">z</span><span class="o">=</span><span class="n">line</span><span class="p">[</span><span class="s1">'S'</span><span class="p">],</span> <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                          <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">line</span><span class="p">[</span><span class="s1">'sRGB_hex'</span><span class="p">]),</span>
                          <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Confusion lines for Deficiency.PROTAN</span>
<span class="n">protan_confusion_lines</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">([</span>
        <span class="p">(</span><span class="mf">0.2309</span><span class="p">,</span> <span class="mf">0.0690</span><span class="p">,</span> <span class="mf">0.0035</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">,</span> <span class="mf">0.1022</span><span class="p">,</span> <span class="mf">0.1960</span><span class="p">,</span> <span class="s1">'#fe5a7a'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.2101</span><span class="p">,</span> <span class="mf">0.0690</span><span class="p">,</span> <span class="mf">0.0035</span><span class="p">,</span> <span class="mf">0.8333</span><span class="p">,</span> <span class="mf">0.1226</span><span class="p">,</span> <span class="mf">0.1968</span><span class="p">,</span> <span class="s1">'#eb627a'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1893</span><span class="p">,</span> <span class="mf">0.0690</span><span class="p">,</span> <span class="mf">0.0035</span><span class="p">,</span> <span class="mf">0.6667</span><span class="p">,</span> <span class="mf">0.1430</span><span class="p">,</span> <span class="mf">0.1977</span><span class="p">,</span> <span class="s1">'#d5697a'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1684</span><span class="p">,</span> <span class="mf">0.0690</span><span class="p">,</span> <span class="mf">0.0035</span><span class="p">,</span> <span class="mf">0.5000</span><span class="p">,</span> <span class="mf">0.1633</span><span class="p">,</span> <span class="mf">0.1985</span><span class="p">,</span> <span class="s1">'#bb707b'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1476</span><span class="p">,</span> <span class="mf">0.0690</span><span class="p">,</span> <span class="mf">0.0035</span><span class="p">,</span> <span class="mf">0.3334</span><span class="p">,</span> <span class="mf">0.1837</span><span class="p">,</span> <span class="mf">0.1993</span><span class="p">,</span> <span class="s1">'#9c767b'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1268</span><span class="p">,</span> <span class="mf">0.0690</span><span class="p">,</span> <span class="mf">0.0035</span><span class="p">,</span> <span class="mf">0.1667</span><span class="p">,</span> <span class="mf">0.2041</span><span class="p">,</span> <span class="mf">0.2002</span><span class="p">,</span> <span class="s1">'#717c7b'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1060</span><span class="p">,</span> <span class="mf">0.0690</span><span class="p">,</span> <span class="mf">0.0035</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.2244</span><span class="p">,</span> <span class="mf">0.2010</span><span class="p">,</span> <span class="s1">'#00827b'</span><span class="p">)],</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'L'</span><span class="p">,</span> <span class="s1">'M'</span><span class="p">,</span> <span class="s1">'S'</span><span class="p">,</span> <span class="s1">'R'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">,</span> <span class="s1">'sRGB_hex'</span><span class="p">]),</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">([</span>
        <span class="p">(</span><span class="mf">0.3899</span><span class="p">,</span> <span class="mf">0.1726</span><span class="p">,</span> <span class="mf">0.0088</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">,</span> <span class="mf">0.4389</span><span class="p">,</span> <span class="mf">0.4975</span><span class="p">,</span> <span class="s1">'#feb0bb'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.3690</span><span class="p">,</span> <span class="mf">0.1726</span><span class="p">,</span> <span class="mf">0.0088</span><span class="p">,</span> <span class="mf">0.8333</span><span class="p">,</span> <span class="mf">0.4593</span><span class="p">,</span> <span class="mf">0.4983</span><span class="p">,</span> <span class="s1">'#ebb4bb'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.3482</span><span class="p">,</span> <span class="mf">0.1726</span><span class="p">,</span> <span class="mf">0.0088</span><span class="p">,</span> <span class="mf">0.6667</span><span class="p">,</span> <span class="mf">0.4796</span><span class="p">,</span> <span class="mf">0.4992</span><span class="p">,</span> <span class="s1">'#d5b8bb'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.3274</span><span class="p">,</span> <span class="mf">0.1726</span><span class="p">,</span> <span class="mf">0.0088</span><span class="p">,</span> <span class="mf">0.5000</span><span class="p">,</span> <span class="mf">0.5000</span><span class="p">,</span> <span class="mf">0.5000</span><span class="p">,</span> <span class="s1">'#bbbbbb'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.3066</span><span class="p">,</span> <span class="mf">0.1726</span><span class="p">,</span> <span class="mf">0.0088</span><span class="p">,</span> <span class="mf">0.3334</span><span class="p">,</span> <span class="mf">0.5204</span><span class="p">,</span> <span class="mf">0.5008</span><span class="p">,</span> <span class="s1">'#9cbebb'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.2858</span><span class="p">,</span> <span class="mf">0.1726</span><span class="p">,</span> <span class="mf">0.0088</span><span class="p">,</span> <span class="mf">0.1667</span><span class="p">,</span> <span class="mf">0.5407</span><span class="p">,</span> <span class="mf">0.5017</span><span class="p">,</span> <span class="s1">'#71c2bb'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.2649</span><span class="p">,</span> <span class="mf">0.1726</span><span class="p">,</span> <span class="mf">0.0088</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.5611</span><span class="p">,</span> <span class="mf">0.5025</span><span class="p">,</span> <span class="s1">'#00c5bb'</span><span class="p">)],</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'L'</span><span class="p">,</span> <span class="s1">'M'</span><span class="p">,</span> <span class="s1">'S'</span><span class="p">,</span> <span class="s1">'R'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">,</span> <span class="s1">'sRGB_hex'</span><span class="p">]),</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">([</span>
        <span class="p">(</span><span class="mf">0.2754</span><span class="p">,</span> <span class="mf">0.1044</span><span class="p">,</span> <span class="mf">0.0120</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">,</span> <span class="mf">0.1584</span><span class="p">,</span> <span class="mf">0.7462</span><span class="p">,</span> <span class="s1">'#fe6ee0'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.2546</span><span class="p">,</span> <span class="mf">0.1044</span><span class="p">,</span> <span class="mf">0.0120</span><span class="p">,</span> <span class="mf">0.8333</span><span class="p">,</span> <span class="mf">0.1787</span><span class="p">,</span> <span class="mf">0.7471</span><span class="p">,</span> <span class="s1">'#eb75e0'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.2337</span><span class="p">,</span> <span class="mf">0.1044</span><span class="p">,</span> <span class="mf">0.0120</span><span class="p">,</span> <span class="mf">0.6667</span><span class="p">,</span> <span class="mf">0.1991</span><span class="p">,</span> <span class="mf">0.7479</span><span class="p">,</span> <span class="s1">'#d57be0'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.2129</span><span class="p">,</span> <span class="mf">0.1044</span><span class="p">,</span> <span class="mf">0.0120</span><span class="p">,</span> <span class="mf">0.5000</span><span class="p">,</span> <span class="mf">0.2194</span><span class="p">,</span> <span class="mf">0.7487</span><span class="p">,</span> <span class="s1">'#bb80e0'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1921</span><span class="p">,</span> <span class="mf">0.1044</span><span class="p">,</span> <span class="mf">0.0120</span><span class="p">,</span> <span class="mf">0.3334</span><span class="p">,</span> <span class="mf">0.2398</span><span class="p">,</span> <span class="mf">0.7496</span><span class="p">,</span> <span class="s1">'#9c86e0'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1713</span><span class="p">,</span> <span class="mf">0.1044</span><span class="p">,</span> <span class="mf">0.0120</span><span class="p">,</span> <span class="mf">0.1667</span><span class="p">,</span> <span class="mf">0.2602</span><span class="p">,</span> <span class="mf">0.7504</span><span class="p">,</span> <span class="s1">'#718be0'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1505</span><span class="p">,</span> <span class="mf">0.1044</span><span class="p">,</span> <span class="mf">0.0120</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.2805</span><span class="p">,</span> <span class="mf">0.7513</span><span class="p">,</span> <span class="s1">'#0090e0'</span><span class="p">)],</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'L'</span><span class="p">,</span> <span class="s1">'M'</span><span class="p">,</span> <span class="s1">'S'</span><span class="p">,</span> <span class="s1">'R'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">,</span> <span class="s1">'sRGB_hex'</span><span class="p">]),</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">([</span>
        <span class="p">(</span><span class="mf">0.5043</span><span class="p">,</span> <span class="mf">0.2408</span><span class="p">,</span> <span class="mf">0.0055</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">,</span> <span class="mf">0.7195</span><span class="p">,</span> <span class="mf">0.2487</span><span class="p">,</span> <span class="s1">'#fedc88'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.4835</span><span class="p">,</span> <span class="mf">0.2408</span><span class="p">,</span> <span class="mf">0.0055</span><span class="p">,</span> <span class="mf">0.8333</span><span class="p">,</span> <span class="mf">0.7398</span><span class="p">,</span> <span class="mf">0.2496</span><span class="p">,</span> <span class="s1">'#ebdf88'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.4627</span><span class="p">,</span> <span class="mf">0.2408</span><span class="p">,</span> <span class="mf">0.0055</span><span class="p">,</span> <span class="mf">0.6667</span><span class="p">,</span> <span class="mf">0.7602</span><span class="p">,</span> <span class="mf">0.2504</span><span class="p">,</span> <span class="s1">'#d5e189'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.4419</span><span class="p">,</span> <span class="mf">0.2408</span><span class="p">,</span> <span class="mf">0.0055</span><span class="p">,</span> <span class="mf">0.5000</span><span class="p">,</span> <span class="mf">0.7805</span><span class="p">,</span> <span class="mf">0.2513</span><span class="p">,</span> <span class="s1">'#bbe489'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.4211</span><span class="p">,</span> <span class="mf">0.2408</span><span class="p">,</span> <span class="mf">0.0055</span><span class="p">,</span> <span class="mf">0.3334</span><span class="p">,</span> <span class="mf">0.8009</span><span class="p">,</span> <span class="mf">0.2521</span><span class="p">,</span> <span class="s1">'#9ce789'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.4003</span><span class="p">,</span> <span class="mf">0.2408</span><span class="p">,</span> <span class="mf">0.0055</span><span class="p">,</span> <span class="mf">0.1667</span><span class="p">,</span> <span class="mf">0.8213</span><span class="p">,</span> <span class="mf">0.2529</span><span class="p">,</span> <span class="s1">'#71e989'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.3794</span><span class="p">,</span> <span class="mf">0.2408</span><span class="p">,</span> <span class="mf">0.0055</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.8416</span><span class="p">,</span> <span class="mf">0.2538</span><span class="p">,</span> <span class="s1">'#00ec89'</span><span class="p">)],</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'L'</span><span class="p">,</span> <span class="s1">'M'</span><span class="p">,</span> <span class="s1">'S'</span><span class="p">,</span> <span class="s1">'R'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">,</span> <span class="s1">'sRGB_hex'</span><span class="p">]),</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">([</span>
        <span class="p">(</span><span class="mf">0.5488</span><span class="p">,</span> <span class="mf">0.2761</span><span class="p">,</span> <span class="mf">0.0140</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">,</span> <span class="mf">0.7756</span><span class="p">,</span> <span class="mf">0.7990</span><span class="p">,</span> <span class="s1">'#fee3e6'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.5280</span><span class="p">,</span> <span class="mf">0.2761</span><span class="p">,</span> <span class="mf">0.0140</span><span class="p">,</span> <span class="mf">0.8333</span><span class="p">,</span> <span class="mf">0.7959</span><span class="p">,</span> <span class="mf">0.7998</span><span class="p">,</span> <span class="s1">'#ebe6e7'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.5072</span><span class="p">,</span> <span class="mf">0.2761</span><span class="p">,</span> <span class="mf">0.0140</span><span class="p">,</span> <span class="mf">0.6667</span><span class="p">,</span> <span class="mf">0.8163</span><span class="p">,</span> <span class="mf">0.8007</span><span class="p">,</span> <span class="s1">'#d5e9e7'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.4864</span><span class="p">,</span> <span class="mf">0.2761</span><span class="p">,</span> <span class="mf">0.0140</span><span class="p">,</span> <span class="mf">0.5000</span><span class="p">,</span> <span class="mf">0.8367</span><span class="p">,</span> <span class="mf">0.8015</span><span class="p">,</span> <span class="s1">'#bbebe7'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.4655</span><span class="p">,</span> <span class="mf">0.2761</span><span class="p">,</span> <span class="mf">0.0140</span><span class="p">,</span> <span class="mf">0.3334</span><span class="p">,</span> <span class="mf">0.8570</span><span class="p">,</span> <span class="mf">0.8023</span><span class="p">,</span> <span class="s1">'#9ceee7'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.4447</span><span class="p">,</span> <span class="mf">0.2761</span><span class="p">,</span> <span class="mf">0.0140</span><span class="p">,</span> <span class="mf">0.1667</span><span class="p">,</span> <span class="mf">0.8774</span><span class="p">,</span> <span class="mf">0.8032</span><span class="p">,</span> <span class="s1">'#71f0e7'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.4239</span><span class="p">,</span> <span class="mf">0.2761</span><span class="p">,</span> <span class="mf">0.0140</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.8977</span><span class="p">,</span> <span class="mf">0.8040</span><span class="p">,</span> <span class="s1">'#00f3e7'</span><span class="p">)],</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'L'</span><span class="p">,</span> <span class="s1">'M'</span><span class="p">,</span> <span class="s1">'S'</span><span class="p">,</span> <span class="s1">'R'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">,</span> <span class="s1">'sRGB_hex'</span><span class="p">]),</span>
<span class="p">]</span>

<span class="n">show_confusion_lines</span><span class="p">(</span><span class="s1">'Examples of protan confusion lines'</span><span class="p">,</span> <span class="n">protan_confusion_lines</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The colors of some of the 5 lines might be easier to discriminate for some protan, but overall with this point size they should be pretty difficult to differentiate on a monitor screen.</p>
<p>See how the confusion lines are parallel to the L axis in the LMS color space, but not aligned with any axis in the RGB space. As expected for protanopes, the colors along the confusion lines vary mostly by their red and green components and are pretty much orthogonal to the blue axis.</p>
<p>Let's also visualize some lines for deuteranopes (parallel to the M axis) and tritanopes (parallel to the S axis).</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Confusion lines for Deficiency.DEUTAN</span>
<span class="n">deutan_confusion_lines</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">([</span>
        <span class="p">(</span><span class="mf">0.1310</span><span class="p">,</span> <span class="mf">0.0311</span><span class="p">,</span> <span class="mf">0.0035</span><span class="p">,</span> <span class="mf">0.6889</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">0.2151</span><span class="p">,</span> <span class="s1">'#d8007f'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1310</span><span class="p">,</span> <span class="mf">0.0400</span><span class="p">,</span> <span class="mf">0.0035</span><span class="p">,</span> <span class="mf">0.5741</span><span class="p">,</span> <span class="mf">0.0470</span><span class="p">,</span> <span class="mf">0.2116</span><span class="p">,</span> <span class="s1">'#c73d7e'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1310</span><span class="p">,</span> <span class="mf">0.0489</span><span class="p">,</span> <span class="mf">0.0035</span><span class="p">,</span> <span class="mf">0.4593</span><span class="p">,</span> <span class="mf">0.0939</span><span class="p">,</span> <span class="mf">0.2080</span><span class="p">,</span> <span class="s1">'#b4567d'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1310</span><span class="p">,</span> <span class="mf">0.0578</span><span class="p">,</span> <span class="mf">0.0035</span><span class="p">,</span> <span class="mf">0.3445</span><span class="p">,</span> <span class="mf">0.1409</span><span class="p">,</span> <span class="mf">0.2045</span><span class="p">,</span> <span class="s1">'#9e687c'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1310</span><span class="p">,</span> <span class="mf">0.0667</span><span class="p">,</span> <span class="mf">0.0035</span><span class="p">,</span> <span class="mf">0.2297</span><span class="p">,</span> <span class="mf">0.1879</span><span class="p">,</span> <span class="mf">0.2009</span><span class="p">,</span> <span class="s1">'#83787b'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1310</span><span class="p">,</span> <span class="mf">0.0756</span><span class="p">,</span> <span class="mf">0.0035</span><span class="p">,</span> <span class="mf">0.1149</span><span class="p">,</span> <span class="mf">0.2348</span><span class="p">,</span> <span class="mf">0.1974</span><span class="p">,</span> <span class="s1">'#5f857a'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1310</span><span class="p">,</span> <span class="mf">0.0846</span><span class="p">,</span> <span class="mf">0.0035</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">0.2818</span><span class="p">,</span> <span class="mf">0.1938</span><span class="p">,</span> <span class="s1">'#009079'</span><span class="p">)],</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'L'</span><span class="p">,</span> <span class="s1">'M'</span><span class="p">,</span> <span class="s1">'S'</span><span class="p">,</span> <span class="s1">'R'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">,</span> <span class="s1">'sRGB_hex'</span><span class="p">]),</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">([</span>
        <span class="p">(</span><span class="mf">0.3274</span><span class="p">,</span> <span class="mf">0.1338</span><span class="p">,</span> <span class="mf">0.0088</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">,</span> <span class="mf">0.2955</span><span class="p">,</span> <span class="mf">0.5155</span><span class="p">,</span> <span class="s1">'#fe93be'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.3274</span><span class="p">,</span> <span class="mf">0.1467</span><span class="p">,</span> <span class="mf">0.0088</span><span class="p">,</span> <span class="mf">0.8333</span><span class="p">,</span> <span class="mf">0.3636</span><span class="p">,</span> <span class="mf">0.5103</span><span class="p">,</span> <span class="s1">'#eba2bd'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.3274</span><span class="p">,</span> <span class="mf">0.1596</span><span class="p">,</span> <span class="mf">0.0088</span><span class="p">,</span> <span class="mf">0.6667</span><span class="p">,</span> <span class="mf">0.4318</span><span class="p">,</span> <span class="mf">0.5052</span><span class="p">,</span> <span class="s1">'#d5afbc'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.3274</span><span class="p">,</span> <span class="mf">0.1726</span><span class="p">,</span> <span class="mf">0.0088</span><span class="p">,</span> <span class="mf">0.5000</span><span class="p">,</span> <span class="mf">0.5000</span><span class="p">,</span> <span class="mf">0.5000</span><span class="p">,</span> <span class="s1">'#bbbbbb'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.3274</span><span class="p">,</span> <span class="mf">0.1855</span><span class="p">,</span> <span class="mf">0.0088</span><span class="p">,</span> <span class="mf">0.3334</span><span class="p">,</span> <span class="mf">0.5682</span><span class="p">,</span> <span class="mf">0.4948</span><span class="p">,</span> <span class="s1">'#9cc6ba'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.3274</span><span class="p">,</span> <span class="mf">0.1985</span><span class="p">,</span> <span class="mf">0.0088</span><span class="p">,</span> <span class="mf">0.1667</span><span class="p">,</span> <span class="mf">0.6363</span><span class="p">,</span> <span class="mf">0.4897</span><span class="p">,</span> <span class="s1">'#71d0b9'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.3274</span><span class="p">,</span> <span class="mf">0.2114</span><span class="p">,</span> <span class="mf">0.0088</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.7045</span><span class="p">,</span> <span class="mf">0.4845</span><span class="p">,</span> <span class="s1">'#00dab8'</span><span class="p">)],</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'L'</span><span class="p">,</span> <span class="s1">'M'</span><span class="p">,</span> <span class="s1">'S'</span><span class="p">,</span> <span class="s1">'R'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">,</span> <span class="s1">'sRGB_hex'</span><span class="p">]),</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">([</span>
        <span class="p">(</span><span class="mf">0.1817</span><span class="p">,</span> <span class="mf">0.0570</span><span class="p">,</span> <span class="mf">0.0120</span><span class="p">,</span> <span class="mf">0.8612</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">0.7689</span><span class="p">,</span> <span class="s1">'#ee00e3'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1817</span><span class="p">,</span> <span class="mf">0.0681</span><span class="p">,</span> <span class="mf">0.0120</span><span class="p">,</span> <span class="mf">0.7176</span><span class="p">,</span> <span class="mf">0.0587</span><span class="p">,</span> <span class="mf">0.7645</span><span class="p">,</span> <span class="s1">'#dc44e2'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1817</span><span class="p">,</span> <span class="mf">0.0792</span><span class="p">,</span> <span class="mf">0.0120</span><span class="p">,</span> <span class="mf">0.5741</span><span class="p">,</span> <span class="mf">0.1174</span><span class="p">,</span> <span class="mf">0.7600</span><span class="p">,</span> <span class="s1">'#c760e1'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1817</span><span class="p">,</span> <span class="mf">0.0904</span><span class="p">,</span> <span class="mf">0.0120</span><span class="p">,</span> <span class="mf">0.4306</span><span class="p">,</span> <span class="mf">0.1761</span><span class="p">,</span> <span class="mf">0.7556</span><span class="p">,</span> <span class="s1">'#af74e1'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1817</span><span class="p">,</span> <span class="mf">0.1015</span><span class="p">,</span> <span class="mf">0.0120</span><span class="p">,</span> <span class="mf">0.2871</span><span class="p">,</span> <span class="mf">0.2348</span><span class="p">,</span> <span class="mf">0.7511</span><span class="p">,</span> <span class="s1">'#9185e0'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1817</span><span class="p">,</span> <span class="mf">0.1127</span><span class="p">,</span> <span class="mf">0.0120</span><span class="p">,</span> <span class="mf">0.1436</span><span class="p">,</span> <span class="mf">0.2935</span><span class="p">,</span> <span class="mf">0.7467</span><span class="p">,</span> <span class="s1">'#6993e0'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1817</span><span class="p">,</span> <span class="mf">0.1238</span><span class="p">,</span> <span class="mf">0.0120</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.3522</span><span class="p">,</span> <span class="mf">0.7423</span><span class="p">,</span> <span class="s1">'#00a0df'</span><span class="p">)],</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'L'</span><span class="p">,</span> <span class="s1">'M'</span><span class="p">,</span> <span class="s1">'S'</span><span class="p">,</span> <span class="s1">'R'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">,</span> <span class="s1">'sRGB_hex'</span><span class="p">]),</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">([</span>
        <span class="p">(</span><span class="mf">0.4731</span><span class="p">,</span> <span class="mf">0.2214</span><span class="p">,</span> <span class="mf">0.0055</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">,</span> <span class="mf">0.6477</span><span class="p">,</span> <span class="mf">0.2577</span><span class="p">,</span> <span class="s1">'#fed28a'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.4731</span><span class="p">,</span> <span class="mf">0.2325</span><span class="p">,</span> <span class="mf">0.0055</span><span class="p">,</span> <span class="mf">0.8565</span><span class="p">,</span> <span class="mf">0.7064</span><span class="p">,</span> <span class="mf">0.2533</span><span class="p">,</span> <span class="s1">'#eeda89'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.4731</span><span class="p">,</span> <span class="mf">0.2436</span><span class="p">,</span> <span class="mf">0.0055</span><span class="p">,</span> <span class="mf">0.7130</span><span class="p">,</span> <span class="mf">0.7652</span><span class="p">,</span> <span class="mf">0.2489</span><span class="p">,</span> <span class="s1">'#dbe288'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.4731</span><span class="p">,</span> <span class="mf">0.2548</span><span class="p">,</span> <span class="mf">0.0055</span><span class="p">,</span> <span class="mf">0.5694</span><span class="p">,</span> <span class="mf">0.8239</span><span class="p">,</span> <span class="mf">0.2444</span><span class="p">,</span> <span class="s1">'#c6ea87'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.4731</span><span class="p">,</span> <span class="mf">0.2659</span><span class="p">,</span> <span class="mf">0.0055</span><span class="p">,</span> <span class="mf">0.4259</span><span class="p">,</span> <span class="mf">0.8826</span><span class="p">,</span> <span class="mf">0.2400</span><span class="p">,</span> <span class="s1">'#aef186'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.4731</span><span class="p">,</span> <span class="mf">0.2771</span><span class="p">,</span> <span class="mf">0.0055</span><span class="p">,</span> <span class="mf">0.2824</span><span class="p">,</span> <span class="mf">0.9413</span><span class="p">,</span> <span class="mf">0.2355</span><span class="p">,</span> <span class="s1">'#90f885'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.4731</span><span class="p">,</span> <span class="mf">0.2882</span><span class="p">,</span> <span class="mf">0.0055</span><span class="p">,</span> <span class="mf">0.1389</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">,</span> <span class="mf">0.2311</span><span class="p">,</span> <span class="s1">'#68fe84'</span><span class="p">)],</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'L'</span><span class="p">,</span> <span class="s1">'M'</span><span class="p">,</span> <span class="s1">'S'</span><span class="p">,</span> <span class="s1">'R'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">,</span> <span class="s1">'sRGB_hex'</span><span class="p">]),</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">([</span>
        <span class="p">(</span><span class="mf">0.5238</span><span class="p">,</span> <span class="mf">0.3141</span><span class="p">,</span> <span class="mf">0.0140</span><span class="p">,</span> <span class="mf">0.3111</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">,</span> <span class="mf">0.7849</span><span class="p">,</span> <span class="s1">'#97fee5'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.5238</span><span class="p">,</span> <span class="mf">0.3052</span><span class="p">,</span> <span class="mf">0.0140</span><span class="p">,</span> <span class="mf">0.4259</span><span class="p">,</span> <span class="mf">0.9530</span><span class="p">,</span> <span class="mf">0.7884</span><span class="p">,</span> <span class="s1">'#aef9e5'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.5238</span><span class="p">,</span> <span class="mf">0.2963</span><span class="p">,</span> <span class="mf">0.0140</span><span class="p">,</span> <span class="mf">0.5407</span><span class="p">,</span> <span class="mf">0.9061</span><span class="p">,</span> <span class="mf">0.7920</span><span class="p">,</span> <span class="s1">'#c2f4e6'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.5238</span><span class="p">,</span> <span class="mf">0.2873</span><span class="p">,</span> <span class="mf">0.0140</span><span class="p">,</span> <span class="mf">0.6555</span><span class="p">,</span> <span class="mf">0.8591</span><span class="p">,</span> <span class="mf">0.7955</span><span class="p">,</span> <span class="s1">'#d3eee6'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.5238</span><span class="p">,</span> <span class="mf">0.2784</span><span class="p">,</span> <span class="mf">0.0140</span><span class="p">,</span> <span class="mf">0.7703</span><span class="p">,</span> <span class="mf">0.8121</span><span class="p">,</span> <span class="mf">0.7991</span><span class="p">,</span> <span class="s1">'#e3e8e6'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.5238</span><span class="p">,</span> <span class="mf">0.2695</span><span class="p">,</span> <span class="mf">0.0140</span><span class="p">,</span> <span class="mf">0.8851</span><span class="p">,</span> <span class="mf">0.7652</span><span class="p">,</span> <span class="mf">0.8026</span><span class="p">,</span> <span class="s1">'#f1e2e7'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.5238</span><span class="p">,</span> <span class="mf">0.2606</span><span class="p">,</span> <span class="mf">0.0140</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">,</span> <span class="mf">0.7182</span><span class="p">,</span> <span class="mf">0.8062</span><span class="p">,</span> <span class="s1">'#fedce7'</span><span class="p">)],</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'L'</span><span class="p">,</span> <span class="s1">'M'</span><span class="p">,</span> <span class="s1">'S'</span><span class="p">,</span> <span class="s1">'R'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">,</span> <span class="s1">'sRGB_hex'</span><span class="p">]),</span>
<span class="p">]</span>

<span class="n">show_confusion_lines</span><span class="p">(</span><span class="s1">'Examples of deutan confusion lines'</span><span class="p">,</span> <span class="n">deutan_confusion_lines</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Confusion lines for Deficiency.TRITAN</span>
<span class="n">tritan_confusion_lines</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">([</span>
        <span class="p">(</span><span class="mf">0.1310</span><span class="p">,</span> <span class="mf">0.0690</span><span class="p">,</span> <span class="mf">0.0005</span><span class="p">,</span> <span class="mf">0.1649</span><span class="p">,</span> <span class="mf">0.2306</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="s1">'#708300'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1310</span><span class="p">,</span> <span class="mf">0.0690</span><span class="p">,</span> <span class="mf">0.0030</span><span class="p">,</span> <span class="mf">0.1941</span><span class="p">,</span> <span class="mf">0.2051</span><span class="p">,</span> <span class="mf">0.1667</span><span class="p">,</span> <span class="s1">'#797d71'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1310</span><span class="p">,</span> <span class="mf">0.0690</span><span class="p">,</span> <span class="mf">0.0055</span><span class="p">,</span> <span class="mf">0.2234</span><span class="p">,</span> <span class="mf">0.1796</span><span class="p">,</span> <span class="mf">0.3333</span><span class="p">,</span> <span class="s1">'#82759c'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1310</span><span class="p">,</span> <span class="mf">0.0690</span><span class="p">,</span> <span class="mf">0.0080</span><span class="p">,</span> <span class="mf">0.2527</span><span class="p">,</span> <span class="mf">0.1541</span><span class="p">,</span> <span class="mf">0.5000</span><span class="p">,</span> <span class="s1">'#896dbb'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1310</span><span class="p">,</span> <span class="mf">0.0690</span><span class="p">,</span> <span class="mf">0.0105</span><span class="p">,</span> <span class="mf">0.2820</span><span class="p">,</span> <span class="mf">0.1285</span><span class="p">,</span> <span class="mf">0.6666</span><span class="p">,</span> <span class="s1">'#9064d5'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1310</span><span class="p">,</span> <span class="mf">0.0690</span><span class="p">,</span> <span class="mf">0.0130</span><span class="p">,</span> <span class="mf">0.3113</span><span class="p">,</span> <span class="mf">0.1030</span><span class="p">,</span> <span class="mf">0.8333</span><span class="p">,</span> <span class="s1">'#975aeb'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1310</span><span class="p">,</span> <span class="mf">0.0690</span><span class="p">,</span> <span class="mf">0.0155</span><span class="p">,</span> <span class="mf">0.3405</span><span class="p">,</span> <span class="mf">0.0775</span><span class="p">,</span> <span class="mf">0.9999</span><span class="p">,</span> <span class="s1">'#9d4efe'</span><span class="p">)],</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'L'</span><span class="p">,</span> <span class="s1">'M'</span><span class="p">,</span> <span class="s1">'S'</span><span class="p">,</span> <span class="s1">'R'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">,</span> <span class="s1">'sRGB_hex'</span><span class="p">]),</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">([</span>
        <span class="p">(</span><span class="mf">0.3274</span><span class="p">,</span> <span class="mf">0.1726</span><span class="p">,</span> <span class="mf">0.0163</span><span class="p">,</span> <span class="mf">0.5878</span><span class="p">,</span> <span class="mf">0.4234</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">,</span> <span class="s1">'#c9aefe'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.3274</span><span class="p">,</span> <span class="mf">0.1726</span><span class="p">,</span> <span class="mf">0.0138</span><span class="p">,</span> <span class="mf">0.5586</span><span class="p">,</span> <span class="mf">0.4489</span><span class="p">,</span> <span class="mf">0.8333</span><span class="p">,</span> <span class="s1">'#c5b2eb'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.3274</span><span class="p">,</span> <span class="mf">0.1726</span><span class="p">,</span> <span class="mf">0.0113</span><span class="p">,</span> <span class="mf">0.5293</span><span class="p">,</span> <span class="mf">0.4745</span><span class="p">,</span> <span class="mf">0.6667</span><span class="p">,</span> <span class="s1">'#c0b7d5'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.3274</span><span class="p">,</span> <span class="mf">0.1726</span><span class="p">,</span> <span class="mf">0.0088</span><span class="p">,</span> <span class="mf">0.5000</span><span class="p">,</span> <span class="mf">0.5000</span><span class="p">,</span> <span class="mf">0.5000</span><span class="p">,</span> <span class="s1">'#bbbbbb'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.3274</span><span class="p">,</span> <span class="mf">0.1726</span><span class="p">,</span> <span class="mf">0.0062</span><span class="p">,</span> <span class="mf">0.4707</span><span class="p">,</span> <span class="mf">0.5255</span><span class="p">,</span> <span class="mf">0.3334</span><span class="p">,</span> <span class="s1">'#b6bf9c'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.3274</span><span class="p">,</span> <span class="mf">0.1726</span><span class="p">,</span> <span class="mf">0.0037</span><span class="p">,</span> <span class="mf">0.4414</span><span class="p">,</span> <span class="mf">0.5510</span><span class="p">,</span> <span class="mf">0.1667</span><span class="p">,</span> <span class="s1">'#b1c371'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.3274</span><span class="p">,</span> <span class="mf">0.1726</span><span class="p">,</span> <span class="mf">0.0012</span><span class="p">,</span> <span class="mf">0.4122</span><span class="p">,</span> <span class="mf">0.5766</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="s1">'#abc700'</span><span class="p">)],</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'L'</span><span class="p">,</span> <span class="s1">'M'</span><span class="p">,</span> <span class="s1">'S'</span><span class="p">,</span> <span class="s1">'R'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">,</span> <span class="s1">'sRGB_hex'</span><span class="p">]),</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">([</span>
        <span class="p">(</span><span class="mf">0.1817</span><span class="p">,</span> <span class="mf">0.1044</span><span class="p">,</span> <span class="mf">0.0158</span><span class="p">,</span> <span class="mf">0.2939</span><span class="p">,</span> <span class="mf">0.2117</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">,</span> <span class="s1">'#937efe'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1817</span><span class="p">,</span> <span class="mf">0.1044</span><span class="p">,</span> <span class="mf">0.0133</span><span class="p">,</span> <span class="mf">0.2646</span><span class="p">,</span> <span class="mf">0.2372</span><span class="p">,</span> <span class="mf">0.8333</span><span class="p">,</span> <span class="s1">'#8c85eb'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1817</span><span class="p">,</span> <span class="mf">0.1044</span><span class="p">,</span> <span class="mf">0.0108</span><span class="p">,</span> <span class="mf">0.2354</span><span class="p">,</span> <span class="mf">0.2628</span><span class="p">,</span> <span class="mf">0.6667</span><span class="p">,</span> <span class="s1">'#858cd5'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1817</span><span class="p">,</span> <span class="mf">0.1044</span><span class="p">,</span> <span class="mf">0.0083</span><span class="p">,</span> <span class="mf">0.2061</span><span class="p">,</span> <span class="mf">0.2883</span><span class="p">,</span> <span class="mf">0.5000</span><span class="p">,</span> <span class="s1">'#7d92bb'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1817</span><span class="p">,</span> <span class="mf">0.1044</span><span class="p">,</span> <span class="mf">0.0058</span><span class="p">,</span> <span class="mf">0.1768</span><span class="p">,</span> <span class="mf">0.3138</span><span class="p">,</span> <span class="mf">0.3334</span><span class="p">,</span> <span class="s1">'#74979c'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1817</span><span class="p">,</span> <span class="mf">0.1044</span><span class="p">,</span> <span class="mf">0.0032</span><span class="p">,</span> <span class="mf">0.1475</span><span class="p">,</span> <span class="mf">0.3393</span><span class="p">,</span> <span class="mf">0.1667</span><span class="p">,</span> <span class="s1">'#6b9d71'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.1817</span><span class="p">,</span> <span class="mf">0.1044</span><span class="p">,</span> <span class="mf">0.0007</span><span class="p">,</span> <span class="mf">0.1182</span><span class="p">,</span> <span class="mf">0.3649</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="s1">'#60a200'</span><span class="p">)],</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'L'</span><span class="p">,</span> <span class="s1">'M'</span><span class="p">,</span> <span class="s1">'S'</span><span class="p">,</span> <span class="s1">'R'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">,</span> <span class="s1">'sRGB_hex'</span><span class="p">]),</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">([</span>
        <span class="p">(</span><span class="mf">0.4731</span><span class="p">,</span> <span class="mf">0.2408</span><span class="p">,</span> <span class="mf">0.0168</span><span class="p">,</span> <span class="mf">0.8818</span><span class="p">,</span> <span class="mf">0.6351</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">,</span> <span class="s1">'#f1d0fe'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.4731</span><span class="p">,</span> <span class="mf">0.2408</span><span class="p">,</span> <span class="mf">0.0143</span><span class="p">,</span> <span class="mf">0.8525</span><span class="p">,</span> <span class="mf">0.6606</span><span class="p">,</span> <span class="mf">0.8333</span><span class="p">,</span> <span class="s1">'#edd4eb'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.4731</span><span class="p">,</span> <span class="mf">0.2408</span><span class="p">,</span> <span class="mf">0.0118</span><span class="p">,</span> <span class="mf">0.8232</span><span class="p">,</span> <span class="mf">0.6862</span><span class="p">,</span> <span class="mf">0.6667</span><span class="p">,</span> <span class="s1">'#ead7d5'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.4731</span><span class="p">,</span> <span class="mf">0.2408</span><span class="p">,</span> <span class="mf">0.0093</span><span class="p">,</span> <span class="mf">0.7939</span><span class="p">,</span> <span class="mf">0.7117</span><span class="p">,</span> <span class="mf">0.5000</span><span class="p">,</span> <span class="s1">'#e6dbbb'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.4731</span><span class="p">,</span> <span class="mf">0.2408</span><span class="p">,</span> <span class="mf">0.0067</span><span class="p">,</span> <span class="mf">0.7646</span><span class="p">,</span> <span class="mf">0.7372</span><span class="p">,</span> <span class="mf">0.3334</span><span class="p">,</span> <span class="s1">'#e2de9c'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.4731</span><span class="p">,</span> <span class="mf">0.2408</span><span class="p">,</span> <span class="mf">0.0042</span><span class="p">,</span> <span class="mf">0.7354</span><span class="p">,</span> <span class="mf">0.7628</span><span class="p">,</span> <span class="mf">0.1667</span><span class="p">,</span> <span class="s1">'#dee271'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.4731</span><span class="p">,</span> <span class="mf">0.2408</span><span class="p">,</span> <span class="mf">0.0017</span><span class="p">,</span> <span class="mf">0.7061</span><span class="p">,</span> <span class="mf">0.7883</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="s1">'#dae500'</span><span class="p">)],</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'L'</span><span class="p">,</span> <span class="s1">'M'</span><span class="p">,</span> <span class="s1">'S'</span><span class="p">,</span> <span class="s1">'R'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">,</span> <span class="s1">'sRGB_hex'</span><span class="p">]),</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">([</span>
        <span class="p">(</span><span class="mf">0.5238</span><span class="p">,</span> <span class="mf">0.2761</span><span class="p">,</span> <span class="mf">0.0170</span><span class="p">,</span> <span class="mf">0.8351</span><span class="p">,</span> <span class="mf">0.7694</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">,</span> <span class="s1">'#ebe3fe'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.5238</span><span class="p">,</span> <span class="mf">0.2761</span><span class="p">,</span> <span class="mf">0.0145</span><span class="p">,</span> <span class="mf">0.8059</span><span class="p">,</span> <span class="mf">0.7949</span><span class="p">,</span> <span class="mf">0.8333</span><span class="p">,</span> <span class="s1">'#e7e6eb'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.5238</span><span class="p">,</span> <span class="mf">0.2761</span><span class="p">,</span> <span class="mf">0.0120</span><span class="p">,</span> <span class="mf">0.7766</span><span class="p">,</span> <span class="mf">0.8204</span><span class="p">,</span> <span class="mf">0.6667</span><span class="p">,</span> <span class="s1">'#e4e9d5'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.5238</span><span class="p">,</span> <span class="mf">0.2761</span><span class="p">,</span> <span class="mf">0.0095</span><span class="p">,</span> <span class="mf">0.7473</span><span class="p">,</span> <span class="mf">0.8459</span><span class="p">,</span> <span class="mf">0.5000</span><span class="p">,</span> <span class="s1">'#e0ecbb'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.5238</span><span class="p">,</span> <span class="mf">0.2761</span><span class="p">,</span> <span class="mf">0.0070</span><span class="p">,</span> <span class="mf">0.7180</span><span class="p">,</span> <span class="mf">0.8715</span><span class="p">,</span> <span class="mf">0.3334</span><span class="p">,</span> <span class="s1">'#dcf09c'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.5238</span><span class="p">,</span> <span class="mf">0.2761</span><span class="p">,</span> <span class="mf">0.0045</span><span class="p">,</span> <span class="mf">0.6887</span><span class="p">,</span> <span class="mf">0.8970</span><span class="p">,</span> <span class="mf">0.1667</span><span class="p">,</span> <span class="s1">'#d8f371'</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.5238</span><span class="p">,</span> <span class="mf">0.2761</span><span class="p">,</span> <span class="mf">0.0020</span><span class="p">,</span> <span class="mf">0.6595</span><span class="p">,</span> <span class="mf">0.9225</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="s1">'#d4f600'</span><span class="p">)],</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'L'</span><span class="p">,</span> <span class="s1">'M'</span><span class="p">,</span> <span class="s1">'S'</span><span class="p">,</span> <span class="s1">'R'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">,</span> <span class="s1">'sRGB_hex'</span><span class="p">]),</span>
<span class="p">]</span>

<span class="n">show_confusion_lines</span><span class="p">(</span><span class="s1">'Examples of tritan confusion lines'</span><span class="p">,</span> <span class="n">tritan_confusion_lines</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The deutan confusion lines are somewhat similar to the protan confusion lines (this is why both are called red-green deficiency), but the tritan ones are mostly along the blue axis.</p>
<p>At this stage if you are affected by a color vision deficiency you might already have a more precise idea of what kind of dichromacy better models your color vision. For me the colors on the protan confusion lines look pretty similar at such a small point size, but I can better distinguish the deutan lines and very well the tritan ones, confirming that I am a protan.</p>
<p>So now that we can compute these confusion lines for each kind of dichromacy, can we simulate how a person with a CVD sees? Since it's related to perception it's impossible to know how another person "feels" the colors, but to understand the loss of color sensitivity we can transform images so that all the colors on each confusion line projects to a single one, essentially making the color space 2D. If the models are correct then the transformed image should still appear identical to a dichromat, and a trichromat will get a sense of the color differences that get lost for the dichromat.</p>
<p>The remaining question is what color should we pick to represent each confusion line? That will be the subject of the <a href="#Simulating-dichromacy-in-LMS">Simulating dichromacy in LMS</a> section.</p>
<p>Finally once the LMS colors are projected along the confusion lines, we can transform them back to the linearRGB and then sRGB color spaces to get the final simulated image. The overall process is summarized in the diagram below, and we're going to dive into each part in the next sections.</p>
<p><img src="/images/copied_from_nb/simulation_images/CVD_Simulation_Pipeline.svg" alt="image" title="CVS Simulation Pipeline"></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="From-sRGB-to-LMS">
<a class="anchor" href="#From-sRGB-to-LMS" aria-hidden="true"><span class="octicon octicon-link"></span></a>From sRGB to LMS<a class="anchor-link" href="#From-sRGB-to-LMS"> </a>
</h1>
<p>In this section we're going to review the steps to go to that nice LMS color space. Several models have been proposed in the literature, so there is not just one way to do it.</p>
<h2 id="From-sRGB-to-linearRGB">
<a class="anchor" href="#From-sRGB-to-linearRGB" aria-hidden="true"><span class="octicon octicon-link"></span></a>From sRGB to linearRGB<a class="anchor-link" href="#From-sRGB-to-linearRGB"> </a>
</h2>
<p>Most digital images are encoded with 3 values per pixel: red, green and blue. But what is often neglected is that this "RGB" usually corresponds to the sRGB standard that precisely defines how these values should be interpreted. sRGB is not a linear space because it tries to compensate the non-linear gamma factor applied by monitors, so that the image captured by a digital camera and then rendered on a monitor will look like the original scene.</p>
<p>We'll call the RGB color space after removing that non-linearity the <em>linearRGB</em> color space. The transformation roughly corresponds to applying a gamma exponent of 2.4 on each channel like a typical monitor would do, with a special linear slope for very small values. So unlike all the other color transformations of that notebook it is non-linear and cannot be expressed as a matrix.</p>
<p>The good news is that sRGB is a well-defined standard now, so we just need to implement the function given by the standard. For more details see <a href="https://en.wikipedia.org/wiki/SRGB">the wikipedia page</a>.</p>
<p>Since both Brettel 1997 and Viénot 1999 were published before the sRGB standard became mainstream, they had to calibrate their old CRT monitor and publish their own model in the paper. Their matrices must be adapted to use the new sRGB model. Even worse, even if the Viénot 1999 paper explicitly mentions the required non-linear transform for their CRT monitor, the most widely replicated matlab code from <a class="citation" href="#fidaner_analysis_2005">(Fidaner, Lin, &amp; Ozguven, 2005)</a> does not take it into account and directly treat the input image as linear RGB. As a consequence this is also the case of most of the source code listed on <a class="citation" href="#daltonize_org">(<i>Daltonize.org</i>, 2010)</a>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Does-it-matter?-Yes!">
<a class="anchor" href="#Does-it-matter?-Yes!" aria-hidden="true"><span class="octicon octicon-link"></span></a>Does it matter? Yes!<a class="anchor-link" href="#Does-it-matter?-Yes!"> </a>
</h3>
<p>As you can see in the image below forgetting the sRGB -&gt; linearRGB transform makes a big difference and it can invalidate perceptual experiments. The first row has 4 sRGB colors, and the second row shows the same colors wrongly interpreted as linear RGB.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">im_sRGB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[[</span><span class="mi">127</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">64</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">192</span><span class="p">],</span> <span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">192</span><span class="p">]]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span>
<span class="n">px</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">im_sRGB</span><span class="p">,</span> <span class="c1"># First row is the sRGB content</span>
                     <span class="n">convert</span><span class="o">.</span><span class="n">linearRGB_from_sRGB</span><span class="p">(</span><span class="n">im_sRGB</span><span class="p">)]),</span> 
          <span class="n">title</span><span class="o">=</span><span class="s1">'sRGB(first row) vs linear RGB (second row)'</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">hide_image_axes</span><span class="p">)</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">margin</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>And the impact is also significant on the final simulation, here is a comparison of Viénot 1999 implemented with and without the proper sRGB decoding / encoding. Note how a bunch of colors appear too dark in the simulation without sRGB.</p>
<p><!-- Image tags have to be unindented for nbdev to catch them :-( --></p>
<table>
    <tr>
<th>Original</th>
<th> Viénot 1999</th>
<th>Viénot 1999 without sRGB</th>
</tr>
    <tr>
<td>
<figure>
  
    <img class="docimage" src="/images/copied_from_nb/simulation_images/rgbspan.png" alt="">
    
    
</figure>
</td>
<td>
<figure>
  
    <img class="docimage" src="/images/copied_from_nb/simulation_images/rgbspan_protan_vienot1999.png" alt="">
    
    
</figure>
</td>
<td>
<figure>
  
    <img class="docimage" src="/images/copied_from_nb/simulation_images/rgbspan_protan_vienot1999_missing_srgb.png" alt="">
    
    
</figure>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="From-linearRGB-to-CIE-XYZ">
<a class="anchor" href="#From-linearRGB-to-CIE-XYZ" aria-hidden="true"><span class="octicon octicon-link"></span></a>From linearRGB to CIE XYZ<a class="anchor-link" href="#From-linearRGB-to-CIE-XYZ"> </a>
</h2>
<p>So far we only mentioned the LMS color space, saying that we'd just go from linearRGB to LMS. But to understand the literature around that transform it is necessary to add an intermediate step which is the CIE XYZ color space. The reason is historical, this color space was standardized in 1931 and it has been used as the main space for color science research since. The main reason is that it can (almost) represent the full range of colors that can be perceived by an average human observer with just 3 values, is device-independent, and has a well-defined relationship w.r.t the input light spectrum.
</p>
<div class="flash">
    <svg class="octicon octicon-info octicon octicon-info" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z"></path></svg>
    <strong>Note: </strong>dichromats confusion lines are sometimes shown in the CIE XYZ color space (e.g. on <a href="http://www.color-blindness.com/2009/01/19/colorblind-colors-of-confusion/">color-blindness.com</a>), usually drawing the lines on a so-called chromaticity diagram. These diagram are a 2d projection of the CIE XYZ color space for a constant maximal luminance. I always got confused about those because I could clearly see differences along these lines, especially when they transition from green to red. The reason is that the confusion lines are actually 3d in CIE XYZ and the luminance needs to get adjusted as the hue/chroma changes along the line to actually get confused by a dichromat.
</div>
The <a href="https://en.wikipedia.org/wiki/SRGB#The_reverse_transformation_(sRGB_to_CIE_XYZ">sRGB wikipedia page</a> gives the <code>XYZ_from_linearRGB</code> matrix defined by the standard itself. As we noted Viénot 1999 used a different matrix resulting from a generic CRT monitor. That matrix was kept in <a class="citation" href="#fidaner_analysis_2005">(Fidaner, Lin, &amp; Ozguven, 2005)</a> and is thus still widespread today.
<p>However as <a class="citation" href="#simon_liedtke_using_2016">(Simon-Liedtke &amp; Farup, 2016)</a> noted, we should now use the modern sRGB-induced transform for LCD monitors. This is also the model correctly used by <a class="citation" href="#dietrich_daltonize_2020">(Dietrich &amp; daltonize.py, 2020)</a> and <a class="citation" href="#jim_ixora_2021">(Jim &amp; Ixora, 2021)</a>.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">printMatrix</span><span class="p">(</span><span class="s1">'Vienot1999 XYZ_from_linearRGB (for old CRT)'</span><span class="p">,</span> <span class="n">convert</span><span class="o">.</span><span class="n">LMSModel_Vienot1999_SmithPokorny75</span><span class="p">()</span><span class="o">.</span><span class="n">XYZ_from_linearRGB</span><span class="o">*</span><span class="mf">255.0</span><span class="p">);</span> <span class="nb">print</span><span class="p">()</span>
<span class="n">printMatrix</span><span class="p">(</span><span class="s1">'sRGB XYZ_from_linearRGB (use this one!)'</span><span class="p">,</span> <span class="n">convert</span><span class="o">.</span><span class="n">LMSModel_sRGB_SmithPokorny75</span><span class="p">()</span><span class="o">.</span><span class="n">XYZ_from_linearRGB</span><span class="o">*</span><span class="mi">255</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="From-CIE-XYZ-to-LMS">
<a class="anchor" href="#From-CIE-XYZ-to-LMS" aria-hidden="true"><span class="octicon octicon-link"></span></a>From CIE XYZ to LMS<a class="anchor-link" href="#From-CIE-XYZ-to-LMS"> </a>
</h2>
<p>That conversion is less clear as many more transforms have been proposed, with different motivations. The most relevant models for CVD simulations are based on color matching experiments with people who happen to have one normal trichromat eye and one dichromat eye (unilateral dichromats).</p>
<p>The most widely used conversion for CVD simulation is still <a class="citation" href="#smith_spectral_1975">(Smith &amp; Pokorny, 1975)</a>, which is the one used by Brettel 1997 and Viénot 1999. The earlier seminal work of <a class="citation" href="#meyer_color_defective_1988">(Meyer &amp; Greenberg, 1988)</a> used another transform from <a class="citation" href="#estevez1981fundamental">(Estévez, 1981)</a> but it already mentioned <a class="citation" href="#smith_spectral_1975">(Smith &amp; Pokorny, 1975)</a> as being a good candidate. Another popular reference model in the literature is the Hunt-Pointer-Esterez one (missing reference). It is used a lot for chromatic adaptation (predicting how a perceived color will change with the illumination conditions), but less for CVD simulation experiments.</p>
<p><a class="citation" href="#stockman_spectral_2000">(Stockman &amp; Sharpe, 2000)</a> made a thorough comparison of the models, and they also propose a new matrix (for a 10 degree standard observer). But overall they are in good agreement with <a class="citation" href="#smith_spectral_1975">(Smith &amp; Pokorny, 1975)</a> once adjusted for a 2 degree observer, with larger differences compared to Hunt-Pointer-Esterez. All 3 are probably reasonable options, but since the CVD simulation evaluations were most often made and evaluated with Smith &amp; Pokorny it's probably still the most solid choice, despite its age. It is also interesting to note that both Pokorny and Viénot continue to promote that transform in more recent papers <a class="citation" href="#vienot_colorimetry_2013">(Viénot &amp; Le Rohellec, 2013)</a> <a class="citation" href="#smith_color_2003">(Smith &amp; Pokorny, 2003)</a>, and other recent papers in the color science research literature do the same <a class="citation" href="#machado_physiologically_based_2009">(Machado, Oliveira, &amp; Fernandes, 2009)</a> <a class="citation" href="#simon_liedtke_using_2016">(Simon-Liedtke &amp; Farup, 2016)</a>.</p>
<p>Most open source code uses the Smith and Pokorny since they did not modify the original code, but some did. <a class="citation" href="#jim_ixora_2021">(Jim &amp; Ixora, 2021)</a> uses the Hunt-Pointer-Estevez matrix and <a class="citation" href="#dietrich_daltonize_2020">(Dietrich &amp; daltonize.py, 2020)</a> uses the sharpened transformation matrix of CIECAM02. These two matrices are on the Wikipedia page and look attractive as they are more recent. But at least the "sharpened" matrices variants are not meant to match the physiological cone responses but to perform hue-preserving chromatic adaptation (see the discussion p181 of <a class="citation" href="#fairchild2013color">(Fairchild, 2013)</a>). So I would argue that we should keep using Smith &amp; Pokorny transform until a proper validation of newer matrices gets done in the context of CVD simulation.
</p>
<div class="flash">
    <svg class="octicon octicon-info octicon octicon-info octicon octicon-info" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z"></path></svg>
    <strong>Note: </strong>the XYZ&lt;-&gt;LMS matrices of the different models can look very different, but the main reason is the normalization factor. There is no unique "scale" for each axis, so each model picked a convention. For example Smith &amp; Pokorny made it so L+S=Y and S/Y=1 at the 400nm wavelengths. For Hunt-Pointer-Esterez they normalize it so that L=M=S for the equal-energy illuminant E (X=Y=Z=1/3), which means that the sum of each rows equals to 1. One reason for this scale variance is that the human vision system can actually change it independently for each axis depending on the illumination conditions. This process is called <em>chromatic adaptation</em> and explains why we still perceive a white sheet of paper as white under an incandescent indoor lighting that makes it actually yellow-ish. It’s a bit similar to the white balance correction of digital cameras. These normalizations do not really matter for CVD simulation if we only do linear operations in it, the scale factor will cancel out when we go back to RGB.
</div>
Below are some example of those <code>LMS_from_XYZ</code> matrices.

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">printMatrix</span><span class="p">(</span><span class="s1">'Smith &amp; Pokorny (used by Viénot, recommended) LMS_from_XYZ'</span><span class="p">,</span> <span class="n">convert</span><span class="o">.</span><span class="n">LMSModel_Vienot1999_SmithPokorny75</span><span class="p">()</span><span class="o">.</span><span class="n">LMS_from_XYZ</span><span class="p">);</span> <span class="nb">print</span><span class="p">()</span>
<span class="n">printMatrix</span><span class="p">(</span><span class="s1">'Hunt-Pointer-Estevez LMS_from_XYZ'</span><span class="p">,</span> <span class="n">convert</span><span class="o">.</span><span class="n">LMSModel_sRGB_HuntPointerEstevez</span><span class="p">()</span><span class="o">.</span><span class="n">LMS_from_XYZ</span><span class="p">);</span> <span class="nb">print</span><span class="p">()</span>
<span class="n">printMatrix</span><span class="p">(</span><span class="s1">'Stockman-Sharpe LMS_from_XYZ'</span><span class="p">,</span> <span class="n">convert</span><span class="o">.</span><span class="n">LMSModel_sRGB_StockmanSharpe2000</span><span class="p">()</span><span class="o">.</span><span class="n">LMS_from_XYZ</span><span class="p">);</span> <span class="nb">print</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="From-linearRGB-to-LMS">
<a class="anchor" href="#From-linearRGB-to-LMS" aria-hidden="true"><span class="octicon octicon-link"></span></a>From linearRGB to LMS<a class="anchor-link" href="#From-linearRGB-to-LMS"> </a>
</h2>
<p>Since both <code>XYZ_from_linearRGB</code> and <code>LMS_from_XYZ</code> are linear transforms, we can just combine the two matrices to get a final <code>LMS_from_linearRGB = LMS_from_XYZ . XYZ_from_linearRGB</code> transform. Here are some of the models implemented in <a href="https://github.com/DaltonLens/DaltonLens-Python">DaltonLens-Python</a>, scaled by 255 for an easier comparison with existing open source code:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">printMatrix</span><span class="p">(</span><span class="s1">'Viénot 1999 (old CRT monitor, do not use)</span><span class="se">\n</span><span class="s1">LMS_from_linearRGB'</span><span class="p">,</span> <span class="n">convert</span><span class="o">.</span><span class="n">LMSModel_Vienot1999_SmithPokorny75</span><span class="p">()</span><span class="o">.</span><span class="n">LMS_from_linearRGB</span><span class="o">*</span><span class="mf">255.0</span><span class="p">);</span> <span class="nb">print</span><span class="p">()</span>
<span class="n">printMatrix</span><span class="p">(</span><span class="s1">'sRGB Viénot (recommended)</span><span class="se">\n</span><span class="s1">LMS_from_linearRGB'</span><span class="p">,</span> <span class="n">convert</span><span class="o">.</span><span class="n">LMSModel_sRGB_SmithPokorny75</span><span class="p">()</span><span class="o">.</span><span class="n">LMS_from_linearRGB</span><span class="o">*</span><span class="mf">255.0</span><span class="p">);</span> <span class="nb">print</span><span class="p">()</span>
<span class="n">printMatrix</span><span class="p">(</span><span class="s1">'Hunt-Pointer-Esterez</span><span class="se">\n</span><span class="s1">LMS_from_linearRGB'</span><span class="p">,</span> <span class="n">convert</span><span class="o">.</span><span class="n">LMSModel_sRGB_HuntPointerEstevez</span><span class="p">()</span><span class="o">.</span><span class="n">LMS_from_linearRGB</span><span class="o">*</span><span class="mf">255.0</span><span class="p">);</span> <span class="nb">print</span><span class="p">()</span>
<span class="n">printMatrix</span><span class="p">(</span><span class="s1">'Stockman &amp; Sharpe</span><span class="se">\n</span><span class="s1">LMS_from_linearRGB'</span><span class="p">,</span> <span class="n">convert</span><span class="o">.</span><span class="n">LMSModel_sRGB_StockmanSharpe2000</span><span class="p">()</span><span class="o">.</span><span class="n">LMS_from_linearRGB</span><span class="o">*</span><span class="mf">255.0</span><span class="p">);</span> <span class="nb">print</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Simulating-dichromacy-in-LMS-(Brettel-1997-and-Viénot-1999)">
<a class="anchor" href="#Simulating-dichromacy-in-LMS-(Brettel-1997-and-Vi%C3%A9not-1999)" aria-hidden="true"><span class="octicon octicon-link"></span></a>Simulating dichromacy in LMS (Brettel 1997 and Viénot 1999)<a class="anchor-link" href="#Simulating-dichromacy-in-LMS-(Brettel-1997-and-Vi%C3%A9not-1999)"> </a>
</h1>
<p>Let's rebuild the seminal paper of <a class="citation" href="#brettel_computerized_1997">(Brettel &amp; Mollon, 1997)</a> that built a precise model based on perceptual experiments. <a class="citation" href="#vienot_digital_1999">(Viénot, Brettel, &amp; Mollon, 1999)</a> then simplified it for its use with digital monitors, reducing the whole pipeline to a single matrix multiplication, and we'll see it right after.</p>
<h2 id="Projection-planes-in-LMS">
<a class="anchor" href="#Projection-planes-in-LMS" aria-hidden="true"><span class="octicon octicon-link"></span></a>Projection planes in LMS<a class="anchor-link" href="#Projection-planes-in-LMS"> </a>
</h2>
<p>Now that we are in a color space that better matches the human physiology, the question becomes how to transform the LMS coordinates to simulate what a color blind person perceives. As discussed in the <a href="#Introduction">Introduction</a>, we want all the colors along the confusion lines to project to the same one, so that a dichromat won't see a difference in the transformed image, but a trichromat will see how much of the color information is lost by the dichromat.</p>
<p>As <a class="citation" href="#jim_ixora_2021">(Jim &amp; Ixora, 2021)</a> points out, a first idea is to just set the deficient axis to 0. But that won't work for several reasons:</p>
<p>1) The new point with L=0, S=0 or M=0 is likely to be outside of the sRGB gamut (the parallelepiped we visualized before in LMS), so most of these transformed color would not be valid once transformed back to sRGB.</p>
<p>2) Experiments on unilateral dichromats (people who have one normal trichromat eye and one dichromat eye) show that they perceive some colors similarly with both eyes. Unsurprisingly among these invariant stimulus we find shades of gray (black to white). Then the similar colors for the two eyes are observed along the 475nm (blue-greenish) and 575nm (yellow) axes for protans and deutans, and along the 485nm (cyan) and 660nm (red) axes for tritans. <a class="citation" href="#meyer_color_defective_1988">(Meyer &amp; Greenberg, 1988)</a> has solid references for some of these experiments, made in the 1950s. Intuitively it makes sense that the dichromat eye of a protan or deutan does a good job on colors that only differ by the amount of blue (S cone). Indeed in LMS going from black to blue or white to yellow is just a change in the S coordinate.</p>
<p>Based on that that data it is possible to design a projection that respect these constraints. <a class="citation" href="#brettel_computerized_1997">(Brettel &amp; Mollon, 1997)</a> proposed the first modern algorithm to compute that. It consists in creating two half-planes around the Black-White diagonal. For protanopes and deuteranopes the wings go through the LMS coordinates of the 475nm and 575nm wavelengths, and for tritanopes towards the coordinates of the 485nm and 660nm wavelengths. By construction colors that lie on these invariant axes are thus preserved.</p>
<p>While black just has a (0,0,0) coordinate in LMS, "white" needs a more careful definition. In <a class="citation" href="#brettel_computerized_1997">(Brettel &amp; Mollon, 1997)</a> they take the white point of the equal-energy illuminant as the neutral axis. That illuminant (called <code>E</code> in <a href="https://en.wikipedia.org/wiki/Standard_illuminant#Illuminant_E">CIE XYZ terminology</a>) has the same amount of energy on all the visible light wavelengths, so it presents a perfectly even color. It differs a bit from the "white" of a sRGB monitor which is the white point of the <a href="https://en.wikipedia.org/wiki/Illuminant_D65">D65 illuminant</a>, which roughly corresponds to the stimulus we'd perceive as white under average outdoor daylight. So to stay close to the best theoretical value we'll start by considering Black to E as the neutral axis that dichromats perceive similarly as trichromats.</p>
<p>Let's first visualize how these planes look like in 3D for protans/deutans (they share the same plane) and for tritans. Note that the colors corresponding to pure 475nm, 485nm, 575nm and 660nm cannot be represented on a sRGB monitor, so I use their closest approximation in the plot by de-saturating them (adding "white" to them until they fit in the gamut).</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">lms_model</span> <span class="o">=</span> <span class="n">convert</span><span class="o">.</span><span class="n">LMSModel_sRGB_SmithPokorny75</span><span class="p">()</span>
<span class="c1"># lms_model = convert.LMSModel_Vienot1999_SmithPokorny75()</span>
<span class="c1"># lms_model = convert.LMSModel_sRGB_StockmanSharpe2000()</span>

<span class="kn">import</span> <span class="nn">colour</span> <span class="c1"># from pip install colour-science</span>
<span class="kn">from</span> <span class="nn">colour</span> <span class="kn">import</span> <span class="n">MSDS_CMFS</span>
<span class="n">cmfs</span> <span class="o">=</span> <span class="n">MSDS_CMFS</span><span class="p">[</span><span class="s1">'CIE 1931 2 Degree Standard Observer'</span><span class="p">]</span>
<span class="n">xyz_475</span> <span class="o">=</span> <span class="n">colour</span><span class="o">.</span><span class="n">wavelength_to_XYZ</span><span class="p">(</span><span class="mi">475</span><span class="p">,</span> <span class="n">cmfs</span><span class="p">)</span>
<span class="n">xyz_575</span> <span class="o">=</span> <span class="n">colour</span><span class="o">.</span><span class="n">wavelength_to_XYZ</span><span class="p">(</span><span class="mi">575</span><span class="p">,</span> <span class="n">cmfs</span><span class="p">)</span>
<span class="n">xyz_485</span> <span class="o">=</span> <span class="n">colour</span><span class="o">.</span><span class="n">wavelength_to_XYZ</span><span class="p">(</span><span class="mi">485</span><span class="p">,</span> <span class="n">cmfs</span><span class="p">)</span>
<span class="n">xyz_660</span> <span class="o">=</span> <span class="n">colour</span><span class="o">.</span><span class="n">wavelength_to_XYZ</span><span class="p">(</span><span class="mi">660</span><span class="p">,</span> <span class="n">cmfs</span><span class="p">)</span>

<span class="c1"># From https://www.johndcook.com/wavelength_to_RGB.html</span>
<span class="c1"># Approximate since the XYZ coordinates are not actually in the RGB gamut</span>
<span class="c1"># The correspondence has to be done projecting in the direction of the</span>
<span class="c1"># whitepoint until reaching the gamut.</span>
<span class="c1"># http://www.fourmilab.ch/documents/specrend/</span>

<span class="n">lms_475</span> <span class="o">=</span> <span class="n">lms_model</span><span class="o">.</span><span class="n">LMS_from_XYZ</span> <span class="o">@</span> <span class="n">xyz_475</span>
<span class="n">lms_575</span> <span class="o">=</span> <span class="n">lms_model</span><span class="o">.</span><span class="n">LMS_from_XYZ</span> <span class="o">@</span> <span class="n">xyz_575</span>
<span class="n">lms_485</span> <span class="o">=</span> <span class="n">lms_model</span><span class="o">.</span><span class="n">LMS_from_XYZ</span> <span class="o">@</span> <span class="n">xyz_485</span>
<span class="n">lms_660</span> <span class="o">=</span> <span class="n">lms_model</span><span class="o">.</span><span class="n">LMS_from_XYZ</span> <span class="o">@</span> <span class="n">xyz_660</span>

<span class="c1"># The equal-energy white point. By construction of CIE XYZ</span>
<span class="c1"># it has X=Y=Z. The normalization does not matter to define</span>
<span class="c1"># the diagonal direction, picking 0.8 to make it close to</span>
<span class="c1"># sRGB white.</span>
<span class="n">xyz_E</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">]</span>
<span class="n">rgb_E</span> <span class="o">=</span> <span class="n">lms_model</span><span class="o">.</span><span class="n">linearRGB_from_XYZ</span> <span class="o">@</span> <span class="n">xyz_E</span>
<span class="n">srgb_E</span> <span class="o">=</span> <span class="n">convert</span><span class="o">.</span><span class="n">sRGB_from_linearRGB</span><span class="p">([</span><span class="n">rgb_E</span><span class="p">])</span>
<span class="n">lms_E</span> <span class="o">=</span> <span class="n">lms_model</span><span class="o">.</span><span class="n">LMS_from_XYZ</span> <span class="o">@</span> <span class="n">xyz_E</span>

<span class="n">rgb_wavelengths</span> <span class="o">=</span> <span class="n">convert</span><span class="o">.</span><span class="n">apply_color_matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xyz_475</span><span class="p">,</span> <span class="n">xyz_575</span><span class="p">,</span> <span class="n">xyz_485</span><span class="p">,</span> <span class="n">xyz_660</span><span class="p">]),</span> <span class="n">lms_model</span><span class="o">.</span><span class="n">linearRGB_from_XYZ</span><span class="p">)</span>
<span class="n">rgb_wavelengths</span> <span class="o">=</span> <span class="n">convert</span><span class="o">.</span><span class="n">desaturate_linearRGB_to_fit_in_gamut</span><span class="p">(</span><span class="n">rgb_wavelengths</span><span class="p">)</span>
<span class="n">srgb_wavelengths</span> <span class="o">=</span> <span class="n">convert</span><span class="o">.</span><span class="n">sRGB_from_linearRGB</span><span class="p">(</span><span class="n">rgb_wavelengths</span><span class="p">)</span>

<span class="n">rgb_475</span><span class="p">,</span> <span class="n">rgb_575</span><span class="p">,</span> <span class="n">rgb_485</span><span class="p">,</span> <span class="n">rgb_660</span> <span class="o">=</span> <span class="n">srgb_wavelengths</span>

<span class="n">rgb_gamut</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]),</span> <span class="s1">'K'</span><span class="p">,</span> <span class="s1">'black'</span><span class="p">),</span>
    <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]),</span> <span class="s1">'B'</span><span class="p">,</span> <span class="s1">'blue'</span><span class="p">),</span>
    <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]),</span> <span class="s1">'M'</span><span class="p">,</span> <span class="s1">'magenta'</span><span class="p">),</span>
    <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]),</span> <span class="s1">'R'</span><span class="p">,</span> <span class="s1">'red'</span><span class="p">),</span>    
    <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]),</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'green'</span><span class="p">),</span>
    <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]),</span> <span class="s1">'C'</span><span class="p">,</span> <span class="s1">'cyan'</span><span class="p">),</span>
    <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]),</span> <span class="s1">'W'</span><span class="p">,</span> <span class="s1">'white'</span><span class="p">),</span>    
    <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]),</span> <span class="s1">'Y'</span><span class="p">,</span> <span class="s1">'yellow'</span><span class="p">),</span>
<span class="p">]</span>

<span class="k">def</span> <span class="nf">dataframe_row</span><span class="p">(</span><span class="n">rgb</span><span class="p">,</span> <span class="n">lms</span><span class="p">,</span> <span class="n">short_name</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">int_rgb255</span> <span class="o">=</span> <span class="p">(</span><span class="n">rgb</span><span class="o">*</span><span class="mf">255.0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">name</span><span class="p">,</span> <span class="n">short_name</span><span class="p">,</span> <span class="o">*</span><span class="n">rgb</span><span class="p">,</span> <span class="o">*</span><span class="n">lms</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'#</span><span class="si">{</span><span class="n">int_rgb255</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">02x</span><span class="si">}{</span><span class="n">int_rgb255</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">02x</span><span class="si">}{</span><span class="n">int_rgb255</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s1">02x</span><span class="si">}</span><span class="s1">'</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">lms_of_key</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="p">[</span><span class="s1">'L'</span><span class="p">,</span><span class="s1">'M'</span><span class="p">,</span><span class="s1">'S'</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

<span class="c1"># RGB parallelepiped gamut in LMS</span>
<span class="n">df_rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">dataframe_row</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lms_model</span><span class="o">.</span><span class="n">LMS_from_linearRGB</span> <span class="o">@</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rgb_gamut</span><span class="p">]</span>
<span class="n">df_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataframe_row</span><span class="p">(</span><span class="n">rgb_E</span><span class="p">,</span> <span class="n">lms_E</span><span class="p">,</span> <span class="s1">'E'</span><span class="p">,</span> <span class="s1">'Equal-Energy'</span><span class="p">))</span>
<span class="n">df_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataframe_row</span><span class="p">(</span><span class="n">rgb_475</span><span class="p">,</span> <span class="n">lms_475</span><span class="p">,</span> <span class="s1">'475nm'</span><span class="p">,</span> <span class="s1">'475nm'</span><span class="p">))</span>
<span class="n">df_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataframe_row</span><span class="p">(</span><span class="n">rgb_575</span><span class="p">,</span> <span class="n">lms_575</span><span class="p">,</span> <span class="s1">'575nm'</span><span class="p">,</span> <span class="s1">'575nm'</span><span class="p">))</span>
<span class="n">df_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataframe_row</span><span class="p">(</span><span class="n">rgb_485</span><span class="p">,</span> <span class="n">lms_485</span><span class="p">,</span> <span class="s1">'485nm'</span><span class="p">,</span> <span class="s1">'485nm'</span><span class="p">))</span>
<span class="n">df_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataframe_row</span><span class="p">(</span><span class="n">rgb_660</span><span class="p">,</span> <span class="n">lms_660</span><span class="p">,</span> <span class="s1">'660nm'</span><span class="p">,</span> <span class="s1">'660nm'</span><span class="p">))</span>
<span class="n">KBMRGCWY</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df_rows</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">'name'</span><span class="p">,</span> <span class="s1">'short_name'</span><span class="p">,</span> <span class="s1">'R'</span><span class="p">,</span><span class="s1">'G'</span><span class="p">,</span><span class="s1">'B'</span><span class="p">,</span><span class="s1">'L'</span><span class="p">,</span><span class="s1">'M'</span><span class="p">,</span><span class="s1">'S'</span><span class="p">,</span><span class="s1">'colorhex'</span><span class="p">])</span>
<span class="n">KBMRGCWY</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">'short_name'</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">KBMRGCWY</span><span class="p">[</span><span class="s1">'short_name'</span><span class="p">]</span> <span class="o">=</span> <span class="n">KBMRGCWY</span><span class="o">.</span><span class="n">index</span>

<span class="n">KBMRGCWY_red_green</span> <span class="o">=</span> <span class="n">KBMRGCWY</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="c1"># drop 485 and 660nm</span>
<span class="n">KBMRGCWY_tritan</span> <span class="o">=</span> <span class="n">KBMRGCWY</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">KBMRGCWY</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="c1"># drop 475 and 575nm    </span>
   
<span class="n">figs</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">px</span><span class="o">.</span><span class="n">scatter_3d</span><span class="p">(</span><span class="n">KBMRGCWY_red_green</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">'L'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">'M'</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="s1">'S'</span><span class="p">,</span> 
                  <span class="n">color</span><span class="o">=</span><span class="s1">'colorhex'</span><span class="p">,</span> <span class="n">color_discrete_map</span><span class="o">=</span><span class="s1">'identity'</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s1">'short_name'</span><span class="p">,</span>
                  <span class="n">width</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span> 
                  <span class="n">title</span><span class="o">=</span><span class="s1">'Protan and Deutan Projection Half-Planes according to (Brettel &amp; Mollon, 1997)'</span><span class="p">),</span>
    
    <span class="n">px</span><span class="o">.</span><span class="n">scatter_3d</span><span class="p">(</span><span class="n">KBMRGCWY_tritan</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">'L'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">'M'</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="s1">'S'</span><span class="p">,</span> 
                  <span class="n">color</span><span class="o">=</span><span class="s1">'colorhex'</span><span class="p">,</span> <span class="n">color_discrete_map</span><span class="o">=</span><span class="s1">'identity'</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s1">'short_name'</span><span class="p">,</span>
                  <span class="n">width</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
                  <span class="n">title</span><span class="o">=</span><span class="s1">'Tritan Projection Half-Planes according to (Brettel &amp; Mollon, 1997)'</span><span class="p">)</span>
<span class="p">]</span>
    

<span class="c1"># Add the parallelepiped lines</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">KBMRGCWY</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="s1">'K'</span><span class="p">,</span><span class="s1">'B'</span><span class="p">,</span><span class="s1">'M'</span><span class="p">,</span><span class="s1">'R'</span><span class="p">,</span> <span class="s1">'K'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'Y'</span><span class="p">,</span> <span class="s1">'W'</span><span class="p">,</span> <span class="s1">'C'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'Y'</span><span class="p">,</span> <span class="s1">'R'</span><span class="p">,</span> <span class="s1">'M'</span><span class="p">,</span> <span class="s1">'W'</span><span class="p">,</span> <span class="s1">'C'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">]]</span>
<span class="k">for</span> <span class="n">fig</span> <span class="ow">in</span> <span class="n">figs</span><span class="p">:</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_scatter3d</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'L'</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'M'</span><span class="p">],</span> <span class="n">z</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'S'</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">'lines'</span><span class="p">,</span> <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Add the black-E diagonal, dashed</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">KBMRGCWY</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="s1">'K'</span><span class="p">,</span><span class="s1">'E'</span><span class="p">]]</span>
<span class="k">for</span> <span class="n">fig</span> <span class="ow">in</span> <span class="n">figs</span><span class="p">:</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_scatter3d</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'L'</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'M'</span><span class="p">],</span> <span class="n">z</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'S'</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">'lines'</span><span class="p">,</span> <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">dash</span><span class="o">=</span><span class="s1">'dash'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">),</span> <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">add_half_plane</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">wavelength_key</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">U_norm</span><span class="p">,</span> <span class="n">V_norm</span><span class="p">,</span> <span class="n">delaunayaxis</span><span class="o">=</span><span class="s1">'x'</span><span class="p">):</span>
    <span class="c1"># The plane is defined by two vectors starting from the origin</span>
    <span class="c1"># U is the black-white diagonal, and V is </span>
    <span class="n">U</span> <span class="o">=</span>  <span class="n">lms_of_key</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">'E'</span><span class="p">)</span> <span class="o">-</span> <span class="n">lms_of_key</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">'K'</span><span class="p">)</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">U_norm</span> <span class="o">*</span> <span class="p">(</span><span class="n">U</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">U</span><span class="p">))</span>
    <span class="n">V</span> <span class="o">=</span>  <span class="n">lms_of_key</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">wavelength_key</span><span class="p">)</span> <span class="o">-</span> <span class="n">lms_of_key</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">'K'</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">U</span><span class="p">,</span><span class="n">V</span><span class="p">)</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">U</span><span class="p">)</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">V_norm</span> <span class="o">*</span> <span class="p">(</span><span class="n">V</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">V</span><span class="p">))</span>
    <span class="n">u</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">50</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">50</span><span class="n">j</span><span class="p">]</span>
    <span class="n">xyz</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">*</span><span class="n">U</span> <span class="o">+</span> <span class="n">v</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">*</span><span class="n">V</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">xyz</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">xyz</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">xyz</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">surfacecolor</span> <span class="o">=</span> <span class="n">convert</span><span class="o">.</span><span class="n">apply_color_matrix</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">lms_model</span><span class="o">.</span><span class="n">linearRGB_from_LMS</span><span class="p">)</span>
    <span class="n">surfacecolor</span> <span class="o">=</span> <span class="n">convert</span><span class="o">.</span><span class="n">desaturate_linearRGB_to_fit_in_gamut</span><span class="p">(</span><span class="n">surfacecolor</span><span class="p">)</span>
    <span class="n">surfacecolor</span> <span class="o">=</span> <span class="n">surfacecolor</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
    <span class="c1">#display(surfacecolor)</span>
    <span class="n">surfacecolor</span> <span class="o">=</span> <span class="n">convert</span><span class="o">.</span><span class="n">sRGB_from_linearRGB</span><span class="p">(</span><span class="n">surfacecolor</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_mesh3d</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">delaunayaxis</span><span class="o">=</span><span class="n">delaunayaxis</span><span class="p">,</span> <span class="n">alphahull</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vertexcolor</span><span class="o">=</span><span class="n">surfacecolor</span><span class="p">,</span> 
                   <span class="n">lighting</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">ambient</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">specular</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="n">diffuse</span><span class="o">=</span><span class="mf">0.0</span><span class="p">),</span> 
                   <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
<span class="n">df</span> <span class="o">=</span> <span class="n">KBMRGCWY_red_green</span>
<span class="n">add_half_plane</span><span class="p">(</span><span class="n">figs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">df</span><span class="p">,</span> <span class="s1">'475nm'</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">lms_of_key</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">'E'</span><span class="p">))</span><span class="o">*</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">lms_of_key</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span>
<span class="n">add_half_plane</span><span class="p">(</span><span class="n">figs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">df</span><span class="p">,</span> <span class="s1">'575nm'</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">lms_of_key</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">'E'</span><span class="p">))</span><span class="o">*</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">lms_of_key</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">KBMRGCWY_tritan</span>
<span class="n">add_half_plane</span><span class="p">(</span><span class="n">figs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">df</span><span class="p">,</span> <span class="s1">'485nm'</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">lms_of_key</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">'E'</span><span class="p">))</span><span class="o">*</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">lms_of_key</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">))</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="s1">'y'</span><span class="p">)</span>
<span class="n">add_half_plane</span><span class="p">(</span><span class="n">figs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">df</span><span class="p">,</span> <span class="s1">'660nm'</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">lms_of_key</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">'E'</span><span class="p">))</span><span class="o">*</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">lms_of_key</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">'R'</span><span class="p">))</span><span class="o">*</span><span class="mf">0.5</span><span class="p">,</span> <span class="s1">'y'</span><span class="p">)</span>

<span class="n">camera</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">up</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">center</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
    <span class="n">eye</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=-</span><span class="mf">1.75</span><span class="p">,</span> <span class="n">y</span><span class="o">=-</span><span class="mf">1.75</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mf">0.75</span><span class="p">),</span>
<span class="p">)</span>
<span class="k">for</span> <span class="n">fig</span> <span class="ow">in</span> <span class="n">figs</span><span class="p">:</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">scene_camera</span><span class="o">=</span><span class="n">camera</span><span class="p">,</span> <span class="n">dragmode</span><span class="o">=</span><span class="s1">'orbit'</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>If the model were perfect then these planes would show the entire set of colors that can be perceived by a dichromat. The idea of <a class="citation" href="#brettel_computerized_1997">(Brettel &amp; Mollon, 1997)</a> is then to project every LMS color into these planes along the dichromat missing axis, picking the closest of the 2 planes. But from these 3d plots we observe two things:</p>
<ul>
<li>
<p>For protans and deutans the two wings are almost co-planar, and the plane is very close to passing through the white, blue and yellow limits of the sRGB parallelepiped. So <a class="citation" href="#vienot_digital_1999">(Viénot, Brettel, &amp; Mollon, 1999)</a> proposed to simplify the algorithm by using a single diagonal plane black-white-blue-yellow. As we'll see next this makes it possible to make the projection a 3x3 matrix and reduce the full pipeline to a single 3x3 matrix.</p>
</li>
<li>
<p><a class="citation" href="#vienot_digital_1999">(Viénot, Brettel, &amp; Mollon, 1999)</a> did not address the tritanope case though, and we can see that such an approximation would not be as good. Several open source implementations of the paper just use the same black-white-blue-yellow diagonal plane as the protan/deutan one, which is completely wrong, as <a class="citation" href="#jim_ixora_2021">(Jim &amp; Ixora, 2021)</a> mentions. A better single plane approximation would be black-white-red-cyan, but it's still a rough approximation and unclear how accurate this is as evaluation studies are rare for tritanopes.</p>
</li>
</ul>
<p>Let's visualize how the Viénot simplification looks like and derive their full algorithm.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="The-simplification-of-Viénot-1999-for-protanopes-and-deuteranopes">
<a class="anchor" href="#The-simplification-of-Vi%C3%A9not-1999-for-protanopes-and-deuteranopes" aria-hidden="true"><span class="octicon octicon-link"></span></a>The simplification of Viénot 1999 for protanopes and deuteranopes<a class="anchor-link" href="#The-simplification-of-Vi%C3%A9not-1999-for-protanopes-and-deuteranopes"> </a>
</h2>
<p>In <a class="citation" href="#vienot_digital_1999">(Viénot, Brettel, &amp; Mollon, 1999)</a> a single plane black-white-blue-yellow is created and all the colors will get projected onto it. Let's visualize that plane in 3D.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># RGB parallelepiped gamut in LMS</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">scatter_3d</span><span class="p">(</span><span class="n">KBMRGCWY</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">'K'</span><span class="p">:</span><span class="s1">'Y'</span><span class="p">],</span> <span class="n">x</span><span class="o">=</span><span class="s1">'L'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">'M'</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="s1">'S'</span><span class="p">,</span> 
                  <span class="n">color</span><span class="o">=</span><span class="s1">'colorhex'</span><span class="p">,</span> <span class="n">color_discrete_map</span><span class="o">=</span><span class="s1">'identity'</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s1">'short_name'</span><span class="p">,</span>
                  <span class="n">width</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span> 
                  <span class="n">title</span><span class="o">=</span><span class="s1">'Protan and Deutan Projection Plane according to (Viénot &amp; Brettel &amp; Mollon, 1999)'</span><span class="p">)</span>

<span class="c1"># Add the parallelepiped lines</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">KBMRGCWY</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="s1">'K'</span><span class="p">,</span><span class="s1">'B'</span><span class="p">,</span><span class="s1">'M'</span><span class="p">,</span><span class="s1">'R'</span><span class="p">,</span> <span class="s1">'K'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'Y'</span><span class="p">,</span> <span class="s1">'W'</span><span class="p">,</span> <span class="s1">'C'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'Y'</span><span class="p">,</span> <span class="s1">'R'</span><span class="p">,</span> <span class="s1">'M'</span><span class="p">,</span> <span class="s1">'W'</span><span class="p">,</span> <span class="s1">'C'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">]]</span>
<span class="n">fig</span><span class="o">.</span><span class="n">add_scatter3d</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'L'</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'M'</span><span class="p">],</span> <span class="n">z</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'S'</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">'lines'</span><span class="p">,</span> <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Add the black-white diagonal, dashed</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">KBMRGCWY</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="s1">'K'</span><span class="p">,</span><span class="s1">'W'</span><span class="p">]]</span>
<span class="n">fig</span><span class="o">.</span><span class="n">add_scatter3d</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'L'</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'M'</span><span class="p">],</span> <span class="n">z</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'S'</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">'lines'</span><span class="p">,</span> <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">dash</span><span class="o">=</span><span class="s1">'dash'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">),</span> <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">add_black_white_yellow_blue_plane</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
    <span class="c1"># The plane is defined by two vectors starting from the origin</span>
    <span class="c1"># U is the black-white diagonal, and V is </span>
    <span class="n">U</span> <span class="o">=</span>  <span class="n">lms_of_key</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">'Y'</span><span class="p">)</span> <span class="o">-</span> <span class="n">lms_of_key</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">'K'</span><span class="p">)</span>
    <span class="n">V</span> <span class="o">=</span>  <span class="n">lms_of_key</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">)</span> <span class="o">-</span> <span class="n">lms_of_key</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">'K'</span><span class="p">)</span>
    <span class="n">u</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">50</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">50</span><span class="n">j</span><span class="p">]</span>
    <span class="n">xyz</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">*</span><span class="n">U</span> <span class="o">+</span> <span class="n">v</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">*</span><span class="n">V</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">xyz</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">xyz</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">xyz</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">surfacecolor</span> <span class="o">=</span> <span class="n">convert</span><span class="o">.</span><span class="n">apply_color_matrix</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">lms_model</span><span class="o">.</span><span class="n">linearRGB_from_LMS</span><span class="p">)</span>
    <span class="n">surfacecolor</span> <span class="o">=</span> <span class="n">convert</span><span class="o">.</span><span class="n">desaturate_linearRGB_to_fit_in_gamut</span><span class="p">(</span><span class="n">surfacecolor</span><span class="p">)</span>
    <span class="n">surfacecolor</span> <span class="o">=</span> <span class="n">surfacecolor</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">surfacecolor</span> <span class="o">=</span> <span class="n">convert</span><span class="o">.</span><span class="n">sRGB_from_linearRGB</span><span class="p">(</span><span class="n">surfacecolor</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_mesh3d</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">delaunayaxis</span><span class="o">=</span><span class="s1">'x'</span><span class="p">,</span> <span class="n">alphahull</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vertexcolor</span><span class="o">=</span><span class="n">surfacecolor</span><span class="p">,</span> 
                   <span class="n">lighting</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">ambient</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">specular</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="n">diffuse</span><span class="o">=</span><span class="mf">0.0</span><span class="p">),</span> 
                   <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">KBMRGCWY</span>
<span class="n">add_black_white_yellow_blue_plane</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>

<span class="n">camera</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">up</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">center</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
    <span class="n">eye</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="o">=-</span><span class="mf">1.75</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mf">0.75</span><span class="p">),</span>
<span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">scene_camera</span><span class="o">=</span><span class="n">camera</span><span class="p">,</span> <span class="n">dragmode</span><span class="o">=</span><span class="s1">'orbit'</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This plane represents all the colors that can be output by the simulation algorithm. If the theory is right, then protans and deutans dichromats can always find a color on that plane that match a given color of the full gamut. Now let's do the math to actually compute the projection of any color into that plane and get the final pipeline.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Plane-projection-as-a-3x3-matrix">
<a class="anchor" href="#Plane-projection-as-a-3x3-matrix" aria-hidden="true"><span class="octicon octicon-link"></span></a>Plane projection as a 3x3 matrix<a class="anchor-link" href="#Plane-projection-as-a-3x3-matrix"> </a>
</h3>
<p>Let $p = (p_l, p_m, p_s)$ be the LMS color to transform, and $n$ the normal of the plane. Our planes always go through the origin <code>K=(0,0,0)</code>(black), so the plane equations are just given by their normal $n = (n_l, n_m, n_s)$ as $n.p = n_l.p_l + n_m.p_m + n_s.p_s = 0$. Let's call $p' = (p_l', p_m', p_s')$ the transformed point, projected on the plane. Since only the coordinate along the dichromacy axis changes, we just need to compute the missing axis coordinate and keep the other two unchanged. For example for a protan, we have $p_m' = p_m$ and $p_s' = p_s$, and plugging them into the plane equation we can calculate $p_l'$:</p>
$$
n_l . p_l' + n_m . p_m' + n_s . p_s' = 0 \\
p_l'  = -\frac{n_m}{n_l} . p_m - \frac{n_s}{n_l} . p_s
$$<p>So we just need the normal of the plane, which is given by the cross-product of two vectors on the plane. Here are the normal of the protan/deutan black-white-blue-yellow plane and the resulting $-\frac{n_m}{n_l}$ and $- \frac{n_s}{n_l}$ factors for a protan:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">v_blue</span> <span class="o">=</span> <span class="n">lms_of_key</span><span class="p">(</span><span class="n">KBMRGCWY</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">)</span> <span class="c1"># - K which is ommitted since it's zero</span>
<span class="n">v_yellow</span> <span class="o">=</span> <span class="n">lms_of_key</span><span class="p">(</span><span class="n">KBMRGCWY</span><span class="p">,</span> <span class="s1">'Y'</span><span class="p">)</span>  <span class="c1"># - K which is ommitted since it's zero</span>
<span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">v_yellow</span><span class="p">,</span> <span class="n">v_blue</span><span class="p">)</span>
<span class="nb">print</span> <span class="p">(</span><span class="s1">'Normal (protan &amp; deutan) = '</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

<span class="nb">print</span> <span class="p">(</span><span class="s1">'n_m / n_l = '</span><span class="p">,</span> <span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span> <span class="p">(</span><span class="s1">'n_s / n_l = '</span><span class="p">,</span> <span class="n">n</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>These factors can be put into a matrix $H$ so that $p' = H . p$:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">H_protan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
    <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="o">-</span><span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="n">n</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> 
<span class="p">])</span>

<span class="n">printMatrix</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">Projection matrix for protan'</span><span class="p">,</span> <span class="n">H_protan</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Similarly we can get the deutan projection matrix, with $p_l' = p_l$, $p_s' = p_s$ and $p_m' = -\frac{n_l}{n_m} . p_l - \frac{n_s}{n_m} . p_s$ this time:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">H_deutan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
    <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="o">-</span><span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">n</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> 
<span class="p">])</span>

<span class="n">printMatrix</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">Projection matrix for deutan'</span><span class="p">,</span> <span class="n">H_deutan</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p></p>
<div class="flash">
    <svg class="octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z"></path></svg>
    <strong>Note: </strong>these matrices don’t exactly match the Viénot 1999 paper because we used the sRGB version of the model (<code>convert.LMSModel_sRGB_SmithPokorny75</code>). They would match if we used <code>lms_model = LMSModel_Vienot1999_SmithPokorny75</code> instead at the beginning of the code section.
</div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Putting-it-together">
<a class="anchor" href="#Putting-it-together" aria-hidden="true"><span class="octicon octicon-link"></span></a>Putting it together<a class="anchor-link" href="#Putting-it-together"> </a>
</h3>
<p>Since the projection is just a 3x3 linear matrix, we can combine all the matrices to transform a linear RGB point into its dichromat counterpart and then go back to linear RGB. We also need to add the non-linear from/to conversion between sRGB and linearRGB to get the final Viénot 1999 pipeline:</p>

<pre><code>srgb_protan = toSRGB(linearRGB_from_LMS . H_protan . LMS_from_linearRGB . fromSRGB(srgb))
srgb_deutan = toSRGB(linearRGB_from_LMS . H_deutan . LMS_from_linearRGB . fromSRGB(srgb))</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We are almost done, we just need to deal with a last hiccup. Some LMS coordinates of the sRGB gamut might fall outside of the parallelepiped once projected onto the plane. For example if we apply the pipeline to the pure green color <code>[0,1,0]</code> we get:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">green_protan</span> <span class="o">=</span> <span class="n">lms_model</span><span class="o">.</span><span class="n">linearRGB_from_LMS</span> <span class="o">@</span> <span class="n">H_protan</span> <span class="o">@</span> <span class="n">lms_model</span><span class="o">.</span><span class="n">LMS_from_linearRGB</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
<span class="n">green_protan</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The blue coordinate becomes negative because green falls slightly outside of the parallelepiped once projected along the L axis onto the black-white-blue-yellow plane. Here the error is very small so it's ok to just clip the final values to [0,1]. This is the approach taken by <a class="citation" href="#simon_liedtke_using_2016">(Simon-Liedtke &amp; Farup, 2016)</a>.</p>
<p>Another way if we use models where we can have larger errors is to de-saturate the color by adding a white component until all the coordinates become positive. This is what we did for the <code>rgb_475</code>, <code>rgb_575</code>, <code>rgb_485</code> and <code>rgb_660</code> visualization of the wavelengths. Just clipping was totally wrong for those as some had large negative values. See <a href="https://www.fourmilab.ch/documents/specrend/">this page of the fourmilab</a> for more details, it's implemented as <code>convert.desaturate_linearRGB_to_fit_in_gamut</code> in DaltonLens.</p>
<p>Now it's time to see what kind of results we can get!</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">simulate_dichromacy_vienot</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">projection_matrix</span><span class="p">):</span>
    <span class="n">color_mat</span> <span class="o">=</span> <span class="n">lms_model</span><span class="o">.</span><span class="n">linearRGB_from_LMS</span> <span class="o">@</span> <span class="n">projection_matrix</span> <span class="o">@</span> <span class="n">lms_model</span><span class="o">.</span><span class="n">LMS_from_linearRGB</span>
    <span class="n">im_linear_rgb</span> <span class="o">=</span> <span class="n">convert</span><span class="o">.</span><span class="n">linearRGB_from_sRGB</span><span class="p">(</span><span class="n">convert</span><span class="o">.</span><span class="n">as_float32</span><span class="p">(</span><span class="n">im</span><span class="p">))</span>
    <span class="n">im_protan_linear_rgb</span> <span class="o">=</span> <span class="n">convert</span><span class="o">.</span><span class="n">apply_color_matrix</span><span class="p">(</span><span class="n">im_linear_rgb</span><span class="p">,</span> <span class="n">color_mat</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">convert</span><span class="o">.</span><span class="n">as_uint8</span><span class="p">(</span><span class="n">convert</span><span class="o">.</span><span class="n">sRGB_from_linearRGB</span><span class="p">(</span><span class="n">im_protan_linear_rgb</span><span class="p">))</span>

<span class="kn">import</span> <span class="nn">urllib.request</span>
<span class="kn">import</span> <span class="nn">cv2</span>

<span class="n">pngdata</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="s1">'https://upload.wikimedia.org/wikipedia/commons/d/d7/Byrcolorwheel.png'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="c1"># pngdata = urllib.request.urlopen('http://www.vischeck.com/images//poppies.jpg').read()</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imdecode</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">pngdata</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_COLOR</span><span class="p">)</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span> <span class="c1"># OpenCV flips the channels by default.</span>

<span class="n">im_protan</span> <span class="o">=</span> <span class="n">simulate_dichromacy_vienot</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">H_protan</span><span class="p">)</span>
<span class="n">im_deutan</span> <span class="o">=</span> <span class="n">simulate_dichromacy_vienot</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">H_deutan</span><span class="p">)</span>
<span class="n">im_original</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">im_original</span><span class="p">,</span> <span class="s1">'Original'</span><span class="p">,</span>        <span class="p">(</span><span class="mi">157</span><span class="p">,</span><span class="mi">190</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_COMPLEX</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="p">(</span><span class="mi">64</span><span class="p">,</span><span class="mi">64</span><span class="p">,</span><span class="mi">64</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">LINE_AA</span><span class="p">)</span>
<span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">im_protan</span><span class="p">,</span>   <span class="s1">'Protan (Vienot)'</span><span class="p">,</span> <span class="p">(</span><span class="mi">125</span><span class="p">,</span><span class="mi">190</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_COMPLEX</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="p">(</span><span class="mi">64</span><span class="p">,</span><span class="mi">64</span><span class="p">,</span><span class="mi">64</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">LINE_AA</span><span class="p">)</span>
<span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">im_deutan</span><span class="p">,</span>   <span class="s1">'Deutan (Vienot)'</span><span class="p">,</span> <span class="p">(</span><span class="mi">125</span><span class="p">,</span><span class="mi">190</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_COMPLEX</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="p">(</span><span class="mi">64</span><span class="p">,</span><span class="mi">64</span><span class="p">,</span><span class="mi">64</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">LINE_AA</span><span class="p">)</span>
<span class="n">px</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">im_original</span><span class="p">,</span> <span class="n">im_protan</span><span class="p">,</span> <span class="n">im_deutan</span><span class="p">]),</span> <span class="n">height</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">hide_image_axes</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="What-about-tritanopes?">
<a class="anchor" href="#What-about-tritanopes?" aria-hidden="true"><span class="octicon octicon-link"></span></a>What about tritanopes?<a class="anchor-link" href="#What-about-tritanopes?"> </a>
</h3>
<p>If we want a one-plane solution for tritanopes we can use the same method but using the black-white-red-cyan plane instead of the black-white-blue-yellow plane we used for protanopes and deuteranopes. As we observed before it's not a very nice fit, but let's try it anyway and we'll compare that with the Brettel 1997 method next.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">v_red</span> <span class="o">=</span> <span class="n">lms_of_key</span><span class="p">(</span><span class="n">KBMRGCWY</span><span class="p">,</span> <span class="s1">'R'</span><span class="p">)</span> <span class="c1"># - K which is ommitted since it's zero</span>
<span class="n">v_cyan</span> <span class="o">=</span> <span class="n">lms_of_key</span><span class="p">(</span><span class="n">KBMRGCWY</span><span class="p">,</span> <span class="s1">'C'</span><span class="p">)</span>  <span class="c1"># - K which is ommitted since it's zero</span>
<span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">v_cyan</span><span class="p">,</span> <span class="n">v_red</span><span class="p">)</span>
<span class="nb">print</span> <span class="p">(</span><span class="s1">'Normal (tritan) = '</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

<span class="n">H_tritan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
    <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="o">-</span><span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">n</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">-</span><span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">n</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">],</span>
<span class="p">])</span>

<span class="n">printMatrix</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">Projection matrix for tritan'</span><span class="p">,</span> <span class="n">H_tritan</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>

<span class="n">im_tritan</span> <span class="o">=</span> <span class="n">simulate_dichromacy_vienot</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">H_tritan</span><span class="p">)</span>
<span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">im_tritan</span><span class="p">,</span>   <span class="s1">'Tritan (Vienot)'</span><span class="p">,</span> <span class="p">(</span><span class="mi">125</span><span class="p">,</span><span class="mi">190</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_COMPLEX</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="p">(</span><span class="mi">64</span><span class="p">,</span><span class="mi">64</span><span class="p">,</span><span class="mi">64</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">LINE_AA</span><span class="p">)</span>
<span class="n">px</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">im_original</span><span class="p">,</span> <span class="n">im_tritan</span><span class="p">]),</span> <span class="n">height</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">hide_image_axes</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Comparing-Viénot-1999-and-Brettel-1997">
<a class="anchor" href="#Comparing-Vi%C3%A9not-1999-and-Brettel-1997" aria-hidden="true"><span class="octicon octicon-link"></span></a>Comparing Viénot 1999 and Brettel 1997<a class="anchor-link" href="#Comparing-Vi%C3%A9not-1999-and-Brettel-1997"> </a>
</h1>
<p>Let's implement <a class="citation" href="#brettel_computerized_1997">(Brettel &amp; Mollon, 1997)</a> so we can compare and see whether the extra complexity is worth it. The implementation is very similar to the Viénot approach, but instead of projecting on just one plane we have to project to one of the 2 planes. The plane on which to project depends on the LMS color. The paper directly gives a simple criteria to decide, but it was not so obvious to me so I re-did the math.</p>
<p>Let's take the example of tritanopia to reason about this:</p>
<ul>
<li>
<p>If the LMS color is on the "same side" as the 485nm point then we should project on that half-plane, otherwise on the 660nm half-plane.</p>
</li>
<li>
<p>The separation is determined by the diagonal $K-E$</p>
</li>
<li>
<p>The projection is along the S axis, so we need to determine if the point is on the same side of the plane oriented along the S axis that goes through the K-E diagonal (black-equal energy). A third point on that plane is for example $K+(0,0,1) = (0,0,1)$ since $K$ is the origin.</p>
</li>
<li>
<p>Now to determine the side of any point $P = (P_l,P_m,P_s)$ w.r.t to a plane, we can check the sign of the dot-product of a vector going from the plane to the point with the plane normal.</p>
</li>
<li>
<p>The plane normal is given by the cross-product of two vectors on the plane: $$n = (E-K) \times ((0,0,1)-K) = E \times (0,0,1) = (E_m,-E_l,0)$$</p>
</li>
<li>
<p>So the dot product becomes: $P . n = P_l.E_m - P_m.E_l$. And this is positive if $P_l.E_m &gt; P_m.E_l$. The Brettel paper gives the equivalent condition $\frac{P_l}{P_m} &gt; \frac{E_l}{E_m}$ since all the quantities are positive.</p>
</li>
</ul>
<p>Let's start with the tritanopes for once since those are the most likely to have a significant difference. We first need to compute the 2 projection planes.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">v_E</span> <span class="o">=</span> <span class="n">lms_of_key</span><span class="p">(</span><span class="n">KBMRGCWY</span><span class="p">,</span> <span class="s1">'E'</span><span class="p">)</span> <span class="c1"># - K which is omitted since it's zero</span>
<span class="n">v_485</span> <span class="o">=</span> <span class="n">lms_of_key</span><span class="p">(</span><span class="n">KBMRGCWY</span><span class="p">,</span> <span class="s1">'485nm'</span><span class="p">)</span> <span class="c1"># - K which is omitted since it's zero</span>
<span class="n">v_660</span> <span class="o">=</span> <span class="n">lms_of_key</span><span class="p">(</span><span class="n">KBMRGCWY</span><span class="p">,</span> <span class="s1">'660nm'</span><span class="p">)</span>  <span class="c1"># - K which is omitted since it's zero</span>
<span class="n">n1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">v_E</span><span class="p">,</span> <span class="n">v_485</span><span class="p">)</span> <span class="c1"># first plane</span>
<span class="n">n2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">v_E</span><span class="p">,</span> <span class="n">v_660</span><span class="p">)</span> <span class="c1"># second plane</span>

<span class="n">H_tritans_brettel</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="n">n1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">n1</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">-</span><span class="n">n1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">n1</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">]]),</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="n">n2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">n2</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">-</span><span class="n">n2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">n2</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">]])</span>
<span class="p">]</span>

<span class="n">printMatrix</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">Projection matrix for tritan (485nm)'</span><span class="p">,</span> <span class="n">H_tritans_brettel</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">printMatrix</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">Projection matrix for tritan (660nm)'</span><span class="p">,</span> <span class="n">H_tritans_brettel</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now we can create the simulation function and see the results.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">projection_matrix</span><span class="p">(</span><span class="n">plane_normal</span><span class="p">,</span> <span class="n">anomaly</span><span class="p">:</span> <span class="n">simulate</span><span class="o">.</span><span class="n">Deficiency</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">plane_normal</span>
    <span class="k">if</span> <span class="n">anomaly</span> <span class="o">==</span> <span class="n">simulate</span><span class="o">.</span><span class="n">Deficiency</span><span class="o">.</span><span class="n">PROTAN</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="o">-</span><span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="n">n</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> 
        <span class="p">])</span>
    <span class="k">if</span> <span class="n">anomaly</span> <span class="o">==</span> <span class="n">simulate</span><span class="o">.</span><span class="n">Deficiency</span><span class="o">.</span><span class="n">DEUTAN</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="o">-</span><span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">n</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> 
        <span class="p">])</span>
    <span class="k">if</span> <span class="n">anomaly</span> <span class="o">==</span> <span class="n">simulate</span><span class="o">.</span><span class="n">Deficiency</span><span class="o">.</span><span class="n">TRITAN</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="o">-</span><span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">n</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">-</span><span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">n</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span>
        <span class="p">])</span>
    <span class="k">return</span> <span class="kc">None</span>

<span class="k">def</span> <span class="nf">simulate_dichromacy_brettel</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">lms_E</span><span class="p">,</span> <span class="n">lms_on_wing1</span><span class="p">,</span> <span class="n">lms_on_wing2</span><span class="p">,</span> <span class="n">anomaly</span><span class="p">:</span> <span class="n">simulate</span><span class="o">.</span><span class="n">Deficiency</span><span class="p">):</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">lms_E</span><span class="p">,</span> <span class="n">lms_on_wing1</span><span class="p">)</span> <span class="c1"># first plane</span>
    <span class="n">n2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">lms_E</span><span class="p">,</span> <span class="n">lms_on_wing2</span><span class="p">)</span> <span class="c1"># second plane</span>
    <span class="n">n_sep_plane</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">lms_E</span><span class="p">,</span> <span class="n">simulate</span><span class="o">.</span><span class="n">lms_confusion_axis</span><span class="p">(</span><span class="n">anomaly</span><span class="p">))</span> <span class="c1"># separation plane going through the diagonal</span>
    <span class="c1"># Swap the input so that wing1 is on the positive side of the separation plane</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">n_sep_plane</span><span class="p">,</span> <span class="n">lms_on_wing1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span> <span class="o">=</span> <span class="n">n2</span><span class="p">,</span> <span class="n">n1</span>
        <span class="n">lms_on_wing1</span><span class="p">,</span> <span class="n">lms_on_wing2</span> <span class="o">=</span> <span class="n">lms_on_wing2</span><span class="p">,</span> <span class="n">lms_on_wing1</span>
    
    <span class="n">H1</span> <span class="o">=</span> <span class="n">projection_matrix</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">anomaly</span><span class="p">)</span>
    <span class="n">H2</span> <span class="o">=</span> <span class="n">projection_matrix</span><span class="p">(</span><span class="n">n2</span><span class="p">,</span> <span class="n">anomaly</span><span class="p">)</span>
    
    <span class="n">im_linear_rgb</span> <span class="o">=</span> <span class="n">convert</span><span class="o">.</span><span class="n">linearRGB_from_sRGB</span><span class="p">(</span><span class="n">convert</span><span class="o">.</span><span class="n">as_float32</span><span class="p">(</span><span class="n">im</span><span class="p">))</span>
    <span class="n">im_lms</span> <span class="o">=</span> <span class="n">convert</span><span class="o">.</span><span class="n">apply_color_matrix</span><span class="p">(</span><span class="n">im_linear_rgb</span><span class="p">,</span> <span class="n">lms_model</span><span class="o">.</span><span class="n">LMS_from_linearRGB</span><span class="p">)</span>
    <span class="n">im_H1</span> <span class="o">=</span> <span class="n">convert</span><span class="o">.</span><span class="n">apply_color_matrix</span><span class="p">(</span><span class="n">im_lms</span><span class="p">,</span> <span class="n">H1</span><span class="p">)</span>
    <span class="n">im_H2</span> <span class="o">=</span> <span class="n">convert</span><span class="o">.</span><span class="n">apply_color_matrix</span><span class="p">(</span><span class="n">im_lms</span><span class="p">,</span> <span class="n">H2</span><span class="p">)</span>
    <span class="n">H2_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">im_lms</span><span class="p">,</span> <span class="n">n_sep_plane</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span>

    <span class="c1"># Start with H1, then overwrite the pixels that are closer to plane 2 with im_H2</span>
    <span class="n">im_H</span> <span class="o">=</span> <span class="n">im_H1</span>
    <span class="n">im_H</span><span class="p">[</span><span class="n">H2_indices</span><span class="p">]</span> <span class="o">=</span> <span class="n">im_H2</span><span class="p">[</span><span class="n">H2_indices</span><span class="p">]</span>
    <span class="n">im_linear_rgb</span> <span class="o">=</span> <span class="n">convert</span><span class="o">.</span><span class="n">apply_color_matrix</span><span class="p">(</span><span class="n">im_H</span><span class="p">,</span> <span class="n">lms_model</span><span class="o">.</span><span class="n">linearRGB_from_LMS</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">convert</span><span class="o">.</span><span class="n">as_uint8</span><span class="p">(</span><span class="n">convert</span><span class="o">.</span><span class="n">sRGB_from_linearRGB</span><span class="p">(</span><span class="n">im_linear_rgb</span><span class="p">))</span>

<span class="n">im_tritan_brettel</span> <span class="o">=</span> <span class="n">simulate_dichromacy_brettel</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">lms_of_key</span><span class="p">(</span><span class="n">KBMRGCWY</span><span class="p">,</span> <span class="s1">'E'</span><span class="p">),</span> <span class="n">lms_485</span><span class="p">,</span> <span class="n">lms_660</span><span class="p">,</span> <span class="n">simulate</span><span class="o">.</span><span class="n">Deficiency</span><span class="o">.</span><span class="n">TRITAN</span><span class="p">)</span>
<span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">im_tritan_brettel</span><span class="p">,</span> <span class="s1">'Tritan (Brettel)'</span><span class="p">,</span> <span class="p">(</span><span class="mi">125</span><span class="p">,</span><span class="mi">190</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_COMPLEX</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="p">(</span><span class="mi">64</span><span class="p">,</span><span class="mi">64</span><span class="p">,</span><span class="mi">64</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">LINE_AA</span><span class="p">)</span>
<span class="n">px</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">im_original</span><span class="p">,</span> <span class="n">im_tritan</span><span class="p">,</span> <span class="n">im_tritan_brettel</span><span class="p">]))</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">hide_image_axes</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can do the same for protans and deutans and complete the comparison.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">v_E</span> <span class="o">=</span> <span class="n">lms_of_key</span><span class="p">(</span><span class="n">KBMRGCWY</span><span class="p">,</span> <span class="s1">'E'</span><span class="p">)</span> <span class="c1"># - K which is omitted since it's zero</span>
<span class="n">v_475</span> <span class="o">=</span> <span class="n">lms_of_key</span><span class="p">(</span><span class="n">KBMRGCWY</span><span class="p">,</span> <span class="s1">'475nm'</span><span class="p">)</span> <span class="c1"># - K which is omitted since it's zero</span>
<span class="n">v_575</span> <span class="o">=</span> <span class="n">lms_of_key</span><span class="p">(</span><span class="n">KBMRGCWY</span><span class="p">,</span> <span class="s1">'575nm'</span><span class="p">)</span>  <span class="c1"># - K which is omitted since it's zero</span>
<span class="n">n1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">v_E</span><span class="p">,</span> <span class="n">v_475</span><span class="p">)</span> <span class="c1"># first plane</span>
<span class="n">n2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">v_E</span><span class="p">,</span> <span class="n">v_575</span><span class="p">)</span> <span class="c1"># second plane</span>

<span class="n">H_protans_brettel</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="o">-</span><span class="n">n1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">n1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="n">n1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">n1</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]),</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="o">-</span><span class="n">n2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">n2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="n">n2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">n2</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])]</span>

<span class="n">H_deutans_brettel</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="n">n1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">n1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">n1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">n1</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]),</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="n">n2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">n2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">n2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">n2</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
<span class="p">]</span>

<span class="n">printMatrix</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">Projection matrix for protan (475nm)'</span><span class="p">,</span> <span class="n">H_protans_brettel</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">printMatrix</span><span class="p">(</span><span class="s1">'Projection matrix for protan (575nm)'</span><span class="p">,</span> <span class="n">H_protans_brettel</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="n">printMatrix</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">Projection matrix for deutan (475nm)'</span><span class="p">,</span> <span class="n">H_deutans_brettel</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">printMatrix</span><span class="p">(</span><span class="s1">'Projection matrix for deutan (575nm)'</span><span class="p">,</span> <span class="n">H_deutans_brettel</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="n">im_protan_brettel</span> <span class="o">=</span> <span class="n">simulate_dichromacy_brettel</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">lms_E</span><span class="p">,</span> <span class="n">lms_475</span><span class="p">,</span> <span class="n">lms_575</span><span class="p">,</span> <span class="n">simulate</span><span class="o">.</span><span class="n">Deficiency</span><span class="o">.</span><span class="n">PROTAN</span><span class="p">)</span>
<span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">im_protan_brettel</span><span class="p">,</span> <span class="s1">'Protan (Brettel)'</span><span class="p">,</span> <span class="p">(</span><span class="mi">125</span><span class="p">,</span><span class="mi">190</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_COMPLEX</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="p">(</span><span class="mi">64</span><span class="p">,</span><span class="mi">64</span><span class="p">,</span><span class="mi">64</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">LINE_AA</span><span class="p">)</span>
<span class="n">px</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">im_original</span><span class="p">,</span> <span class="n">im_protan</span><span class="p">,</span> <span class="n">im_protan_brettel</span><span class="p">]),</span> <span class="n">height</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">hide_image_axes</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">im_deutan_brettel</span> <span class="o">=</span> <span class="n">simulate_dichromacy_brettel</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">lms_E</span><span class="p">,</span> <span class="n">lms_475</span><span class="p">,</span> <span class="n">lms_575</span><span class="p">,</span> <span class="n">simulate</span><span class="o">.</span><span class="n">Deficiency</span><span class="o">.</span><span class="n">DEUTAN</span><span class="p">)</span>
<span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">im_deutan_brettel</span><span class="p">,</span> <span class="s1">'Deutan (Brettel)'</span><span class="p">,</span> <span class="p">(</span><span class="mi">125</span><span class="p">,</span><span class="mi">190</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_COMPLEX</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="p">(</span><span class="mi">64</span><span class="p">,</span><span class="mi">64</span><span class="p">,</span><span class="mi">64</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">LINE_AA</span><span class="p">)</span>
<span class="n">px</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">im_original</span><span class="p">,</span> <span class="n">im_deutan</span><span class="p">,</span> <span class="n">im_deutan_brettel</span><span class="p">]),</span> <span class="n">height</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">hide_image_axes</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>For protanopia and deuteranopia the results are significantly more similar, so the more efficient Viénot approach is a good choice. It also better preserves with extreme values like pure RGB white (255,255,255) since the plane diagonal goes exactly through white and not E in the LMS space.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="What-about-anomalous-trichromacy?">
<a class="anchor" href="#What-about-anomalous-trichromacy?" aria-hidden="true"><span class="octicon octicon-link"></span></a>What about anomalous trichromacy?<a class="anchor-link" href="#What-about-anomalous-trichromacy?"> </a>
</h1>
<p>Most people with CVD still have <em>some</em> perception with the deficient kind of cones. The Brettel 1997 and the Viénot 1999 models can be adjusted to be more progressive by not projecting all the way towards the plane.</p>
<p><a class="citation" href="#flatla_so_2012">(Flatla &amp; Gutwin, 2012)</a> (refined for a mobile app in <a class="citation" href="#macalpine_real_time_2016">(MacAlpine &amp; Flatla, 2016)</a>) propose to make a fixed step towards the plane, with the step size determined from a custom calibration. The step is actually made in the L<em>u</em>v color space since a fixed step there is supposed to be perceptually uniform in that space.</p>
<p>Another approach was proposed was <a class="citation" href="#machado_physiologically_based_2009">(Machado, Oliveira, &amp; Fernandes, 2009)</a>, where the degree of severity comes from an amount of shift in the peak wavelength of the cone response. Dichromacy can be represented when e.g. the M-cone is shifted to align with the S-cone, effectively suppressing it. By shifting it less, various degrees of severity can be simulated. At the end of the day (missing reference) the step size is proportional to the distance between the point and the plane, while the steps are fixed in <a class="citation" href="#macalpine_real_time_2016">(MacAlpine &amp; Flatla, 2016)</a>. It's unclear which one is more accurate from a perception point of view.</p>
<p>It's also trivially possible to extend the Viénot 1999 or Brettel 1997 methods by introducing a severity factor between 0 and 1 that does a linear interpolation between the dichromat simulation and the original image (in the linear RGB space). In practice this gives pretty good results, making Brettel 1997 and Machado 2009 quite close for protanomaly and deuteranomaly. Here is an example for protanomaly (generated with the implementations of <a href="https://github.com/DaltonLens/DaltonLens-Python">DaltonLens-Python</a>):</p>
<p><!-- Image tags have to be unindented for nbdev to catch them :-( --></p>
<table>
    <tr>
<th>Original</th>
<th>Machado 2009 (1.0 severity)</th>
<th>Brettel 1997 (1.0 severity)</th>
</tr>
    <tr>
<td>
<figure>
  
    <img class="docimage" src="/images/copied_from_nb/simulation_images/rgbspan.png" alt="">
    
    
</figure>
</td>
<td>
<figure>
  
    <img class="docimage" src="/images/copied_from_nb/simulation_images/rgbspan_protan_machado2009.png" alt="">
    
    
</figure>
</td>
<td>
<figure>
  
    <img class="docimage" src="/images/copied_from_nb/simulation_images/rgbspan_protan_brettel1997.png" alt="">
    
    
</figure>
</td>
</tr>
     <tr>
<th>Original</th>
<th>Machado 2009 (0.5 severity)</th>
<th>Brettel 1997 (0.5 severity)</th>
</tr>
    <tr>
<td>
<figure>
  
    <img class="docimage" src="/images/copied_from_nb/simulation_images/rgbspan.png" alt="">
    
    
</figure>
</td>
<td>
<figure>
  
    <img class="docimage" src="/images/copied_from_nb/simulation_images/rgbspan_protan_machado2009_0.5.png" alt="">
    
    
</figure>
</td>
<td>
<figure>
  
    <img class="docimage" src="/images/copied_from_nb/simulation_images/rgbspan_protan_brettel1997_0.5.png" alt="">
    
    
</figure>
</td>
</tr>
</table>
<p>The main problem then becomes to estimate the severity factor for each individual. <a class="citation" href="#flatla_so_2012">(Flatla &amp; Gutwin, 2012)</a> uses a calibration method where a number of colored patterns are shown to the user with an increasing distance from the neutral gray until she can distinguish them. And that distance is then used to determine the severity factor. But we're still lacking convenient open source tools to do that, so in practice people just have to try various parameters until they can't see the difference between the original and the simulated images.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Conclusion">
<a class="anchor" href="#Conclusion" aria-hidden="true"><span class="octicon octicon-link"></span></a>Conclusion<a class="anchor-link" href="#Conclusion"> </a>
</h1>
<p>We've seen how the most popular CVD simulation methods work and visualized the corresponding projection planes in the LMS space. As we discussed in our <a href="/opensource-cvd-simulation/#How-accurate-are-these-simulations?">Review of Open Source Color Blindness Simulations</a> we can't expect a perfect accuracy for the simulation. The main source of inaccuracy is the per-person variations as the severity and cone cells sensitivity can vary. So ideally we'd need an individual calibration procedure and a way to inject that calibration in the model. As an intermediate step we'll show in a followup post how we can generate Ishihara-like plates for each model and degree of severity. This will let everyone self-evaluate how good the models are and what severity they have for each model.</p>
<p>The next step after simulation is to try to transform images to help people with CVD to process them. The most well-known approach is the daltonize algorithm from <a class="citation" href="#fidaner_analysis_2005">(Fidaner, Lin, &amp; Ozguven, 2005)</a>, but it's main advantage is the simplicity and code availability as it is quite rough (it was actually just a small school project!). There are a lot of more recent work in that area, but that'll also be the subject of a future post.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Bibliography">
<a class="anchor" href="#Bibliography" aria-hidden="true"><span class="octicon octicon-link"></span></a>Bibliography<a class="anchor-link" href="#Bibliography"> </a>
</h1>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p></p>
<ol class="bibliography">
<li><span id="brettel_computerized_1997">Brettel, H., &amp; Mollon, J. D. (1997). <i>Computerized simulation of color appearance for dichromats</i>. <i>14</i>(10), 2647–2655.</span></li>
<li><span id="vienot_digital_1999">Viénot, F., Brettel, H., &amp; Mollon, J. D. (1999). Digital video colourmaps for checking the legibility of displays by dichromats. <i>Color Research &amp; Application</i>, <i>24</i>(4), 243–252.</span></li>
<li><span id="machado_physiologically_based_2009">Machado, G. M., Oliveira, M. M., &amp; Fernandes, L. A. F. (2009). A physiologically-based model for simulation of color vision deficiency. <i>IEEE Transactions on Visualization and Computer Graphics</i>, <i>15</i>(6), 1291–1298. https://doi.org/10.1109/TVCG.2009.113</span></li>
<li><span id="fidaner_analysis_2005">Fidaner, O., Lin, P., &amp; Ozguven, N. (2005). <i>Analysis of Color Blindness</i>.</span></li>
<li><span id="daltonize_org"><i>daltonize.org</i>. (2010). Retrieved from http://www.daltonize.org</span></li>
<li><span id="simon_liedtke_using_2016">Simon-Liedtke, J. T., &amp; Farup, I. (2016). Using a Behavioral Match-to-Sample Method to Evaluate Color Vision Deficiency Simulation Methods. <i>Journal of Imaging Science and Technology</i>, <i>60</i>(5), 504091–504099. https://doi.org/10.2352/J.ImagingSci.Technol.2016.60.5.050409</span></li>
<li><span id="dietrich_daltonize_2020">Dietrich, J., &amp; daltonize.py. (2020). <i>daltonize</i>. Retrieved from https://github.com/joergdietrich</span></li>
<li><span id="jim_ixora_2021">Jim, &amp; Ixora. (2021). <i>Color Blindness Simulation Research</i>. Retrieved from https://ixora.io/projects/colorblindness/color-blindness-simulation-research/</span></li>
<li><span id="smith_spectral_1975">Smith, V. C., &amp; Pokorny, J. (1975). Spectral sensitivity of the foveal cone photopigments between 400 and 500 nm. <i>Vision Research</i>, <i>15</i>(2), 161–171.</span></li>
<li><span id="meyer_color_defective_1988">Meyer, G. W., &amp; Greenberg, D. P. (1988). Color-defective vision and computer graphics displays. <i>IEEE Computer Graphics and Applications</i>, <i>8</i>(5), 28–40.</span></li>
<li><span id="estevez1981fundamental">Estévez, O. (1981). On the fundamental data-base of normal and dichromatic colour vision. <i>Ph. D. Thesis, University of Amsterdam</i>.</span></li>
<li><span id="stockman_spectral_2000">Stockman, A., &amp; Sharpe, L. T. (2000). The spectral sensitivities of the middle-and long-wavelength-sensitive cones derived from measurements in observers of known genotype. <i>Vision Research</i>, <i>40</i>, 1711–1737.</span></li>
<li><span id="vienot_colorimetry_2013">Viénot, F., &amp; Le Rohellec, J. (2013). Colorimetry and Physiology - The LMS Specification. In <i>Digital Color</i> (pp. 1–28). Hoboken, NJ USA: John Wiley &amp; Sons, Inc. https://doi.org/10.1002/9781118562680.ch1</span></li>
<li><span id="smith_color_2003">Smith, V. C., &amp; Pokorny, J. (2003). Color Matching and Color Discrimination. In <i>The Science of Color</i> (pp. 103–148). Elsevier. https://doi.org/10.1016/B978-044451251-2/50004-0</span></li>
<li><span id="fairchild2013color">Fairchild, M. D. (2013). <i>Color appearance models</i>. John Wiley &amp; Sons.</span></li>
<li><span id="flatla_so_2012">Flatla, D. R., &amp; Gutwin, C. (2012). "So that’s what you see": building understanding with personalized simulations of colour vision deficiency. <i>Proceedings of the 14th International ACM SIGACCESS Conference on Computers and Accessibility</i>, 167–174. New York, NY, USA: Association for Computing Machinery. https://doi.org/10.1145/2384916.2384946</span></li>
<li><span id="macalpine_real_time_2016">MacAlpine, R., &amp; Flatla, D. R. (2016). <i>Real-Time Mobile Personalized Simulations of Impaired Colour Vision</i>. 9.</span></li>
</ol>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Appendix">
<a class="anchor" href="#Appendix" aria-hidden="true"><span class="octicon octicon-link"></span></a>Appendix<a class="anchor-link" href="#Appendix"> </a>
</h1>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Code-to-generate-the-confusion-lines-of-the-introduction">
<a class="anchor" href="#Code-to-generate-the-confusion-lines-of-the-introduction" aria-hidden="true"><span class="octicon octicon-link"></span></a>Code to generate the confusion lines of the introduction<a class="anchor-link" href="#Code-to-generate-the-confusion-lines-of-the-introduction"> </a>
</h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Debug figure to visualize the confusion lines</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">scatter_3d</span><span class="p">(</span><span class="n">KBMRGCWY</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">'K'</span><span class="p">:</span><span class="s1">'Y'</span><span class="p">],</span> <span class="n">x</span><span class="o">=</span><span class="s1">'L'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">'M'</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="s1">'S'</span><span class="p">,</span> 
                    <span class="n">color</span><span class="o">=</span><span class="s1">'colorhex'</span><span class="p">,</span> <span class="n">color_discrete_map</span><span class="o">=</span><span class="s1">'identity'</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s1">'short_name'</span><span class="p">,</span>
                    <span class="n">width</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">)</span>

<span class="c1"># Add the parallelepiped lines</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">KBMRGCWY</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="s1">'K'</span><span class="p">,</span><span class="s1">'B'</span><span class="p">,</span><span class="s1">'M'</span><span class="p">,</span><span class="s1">'R'</span><span class="p">,</span> <span class="s1">'K'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'Y'</span><span class="p">,</span> <span class="s1">'W'</span><span class="p">,</span> <span class="s1">'C'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'Y'</span><span class="p">,</span> <span class="s1">'R'</span><span class="p">,</span> <span class="s1">'M'</span><span class="p">,</span> <span class="s1">'W'</span><span class="p">,</span> <span class="s1">'C'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">]]</span>
<span class="n">fig</span><span class="o">.</span><span class="n">add_scatter3d</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'L'</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'M'</span><span class="p">],</span> <span class="n">z</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'S'</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">'lines'</span><span class="p">,</span> <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Add the black-white diagonal</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">KBMRGCWY</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="s1">'K'</span><span class="p">,</span><span class="s1">'W'</span><span class="p">]]</span>
<span class="n">fig</span><span class="o">.</span><span class="n">add_scatter3d</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'L'</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'M'</span><span class="p">],</span> <span class="n">z</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'S'</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">'lines'</span><span class="p">,</span> <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">dash</span><span class="o">=</span><span class="s1">'dash'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">))</span>

<span class="c1"># add_black_white_yellow_blue_plane(fig, KBMRGCWY)</span>
   
<span class="k">def</span> <span class="nf">generate_confusion_line</span><span class="p">(</span><span class="n">lms_color</span><span class="p">,</span> <span class="n">anomaly</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">,</span> <span class="n">fig</span><span class="p">):</span>
    <span class="c1"># This returns a line segment along the anomaly projection axis (L, M or S)</span>
    <span class="c1"># that passes through the input LMS color and stops at the boundaries of the</span>
    <span class="c1"># gamut (the parallelepiped). Then we can walk along that segment with small</span>
    <span class="c1"># steps to generate confusion colors.</span>
    <span class="n">segment</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">lms_confusion_segment</span><span class="p">(</span><span class="n">lms_color</span><span class="p">,</span> <span class="n">lms_model</span><span class="p">,</span> <span class="n">anomaly</span><span class="p">)</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Ensure num_steps at the end</span>
    <span class="n">step</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">num_steps</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">-</span> <span class="mf">1e-5</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">segment</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">s</span><span class="p">)</span> <span class="o">+</span> <span class="n">segment</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">s</span>
        <span class="n">colors</span><span class="o">.</span><span class="n">append</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fig</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_scatter3d</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">z</span><span class="o">=</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span> <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">lms_model</span><span class="o">.</span><span class="n">sRGB_hexstring_from_LMS</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> 
                                          <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">'Black'</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">colors</span>
    
<span class="n">anomaly</span> <span class="o">=</span> <span class="n">simulate</span><span class="o">.</span><span class="n">Deficiency</span><span class="o">.</span><span class="n">PROTAN</span>
<span class="n">num_steps</span> <span class="o">=</span> <span class="mi">7</span>

<span class="c1"># Generate segments that passes through a set of LMS points. To get a nice</span>
<span class="c1"># distribution of the segment we sample them from the diagonal Black-Yellow-Blue plane</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">lms_of_key</span><span class="p">(</span><span class="n">KBMRGCWY</span><span class="p">,</span> <span class="s1">'Y'</span><span class="p">)</span> <span class="o">-</span> <span class="n">lms_of_key</span><span class="p">(</span><span class="n">KBMRGCWY</span><span class="p">,</span> <span class="s1">'K'</span><span class="p">)</span>
<span class="n">V</span> <span class="o">=</span> <span class="n">lms_of_key</span><span class="p">(</span><span class="n">KBMRGCWY</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">)</span> <span class="o">-</span> <span class="n">lms_of_key</span><span class="p">(</span><span class="n">KBMRGCWY</span><span class="p">,</span> <span class="s1">'K'</span><span class="p">)</span>
<span class="n">confusion_lines</span> <span class="o">=</span> <span class="p">[]</span>
<span class="c1"># for uv_plane in itertools.product([0.1,0.25,0.5,0.75,0.9], [0.02,0.1,0.25,0.5,0.75,0.9]):</span>
<span class="k">for</span> <span class="n">uv_plane</span> <span class="ow">in</span> <span class="p">[(</span><span class="mf">0.2</span><span class="p">,</span><span class="mf">0.2</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">)]:</span>
    <span class="n">lms_color</span> <span class="o">=</span> <span class="n">uv_plane</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">U</span><span class="p">,</span><span class="n">V</span><span class="p">])</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="n">generate_confusion_line</span><span class="p">(</span><span class="n">lms_color</span><span class="p">,</span> <span class="n">anomaly</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">,</span> <span class="n">fig</span><span class="p">)</span>
    <span class="n">confusion_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span>

<span class="nb">print</span> <span class="p">(</span><span class="sa">f</span><span class="s2">"# Confusion lines for </span><span class="si">{</span><span class="n">anomaly</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span> <span class="p">(</span><span class="s2">"confusion_lines = ["</span><span class="p">)</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">confusion_lines</span><span class="p">:</span>
    <span class="nb">print</span> <span class="p">(</span><span class="s2">" "</span><span class="o">*</span><span class="mi">4</span> <span class="o">+</span> <span class="s2">"pd.DataFrame.from_records(["</span><span class="p">)</span>
    <span class="n">lines_as_text</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
        <span class="n">srgb_hex</span> <span class="o">=</span> <span class="n">lms_model</span><span class="o">.</span><span class="n">sRGB_hexstring_from_LMS</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">L</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">S</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">linear_rgb</span> <span class="o">=</span> <span class="n">convert</span><span class="o">.</span><span class="n">apply_color_matrix</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">lms_model</span><span class="o">.</span><span class="n">linearRGB_from_LMS</span><span class="p">)</span>
        <span class="n">linear_rgb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">linear_rgb</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">R</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">B</span> <span class="o">=</span> <span class="n">linear_rgb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">linear_rgb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">linear_rgb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">lines_as_text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">" "</span><span class="o">*</span><span class="mi">8</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">"(</span><span class="si">{</span><span class="n">L</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">M</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">S</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">R</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">G</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">B</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, '</span><span class="si">{</span><span class="n">srgb_hex</span><span class="si">}</span><span class="s2">')"</span><span class="p">)</span>
    <span class="nb">print</span> <span class="p">(</span><span class="s2">",</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines_as_text</span><span class="p">)</span> <span class="o">+</span> <span class="s2">"],"</span><span class="p">)</span>    
    <span class="nb">print</span> <span class="p">(</span><span class="s2">" "</span><span class="o">*</span><span class="mi">8</span> <span class="o">+</span> <span class="s2">"columns = ['L', 'M', 'S', 'R', 'G', 'B', 'sRGB_hex']),"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"]"</span><span class="p">)</span>
<span class="c1"># Uncomment to show the confusion lines.</span>
<span class="c1"># fig.show()</span>

<span class="n">confusion_matrices</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">confusion_line</span> <span class="ow">in</span> <span class="n">confusion_lines</span><span class="p">:</span>
    <span class="n">confusion_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">confusion_line</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">confusion_matrix</span> <span class="o">=</span> <span class="n">convert</span><span class="o">.</span><span class="n">apply_color_matrix</span><span class="p">(</span><span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">lms_model</span><span class="o">.</span><span class="n">linearRGB_from_LMS</span><span class="p">)</span>
    <span class="n">confusion_matrix</span> <span class="o">=</span> <span class="n">convert</span><span class="o">.</span><span class="n">sRGB_from_linearRGB</span><span class="p">(</span><span class="n">confusion_matrix</span><span class="p">)</span>
    <span class="n">confusion_matrices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">confusion_matrix</span><span class="o">*</span><span class="mf">255.0</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">255.</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">confusion_matrices</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">"Confusion lines for </span><span class="si">{</span><span class="n">anomaly</span><span class="si">}</span><span class="s2">. The colors on each row should appear similar to a dichromat."</span><span class="p">)</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">hide_image_axes</span><span class="p">)</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">margin</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

</div>



  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="DaltonLens/daltonlens.org"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/understanding-cvd-simulation/" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Software tools and technical posts to make the life of colorblind people easier. Includes color filters and color blindness simulation.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/DaltonLens" title="DaltonLens"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/nburrus" title="nburrus"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
